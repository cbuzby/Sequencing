---
title: "2023 Comparing Coverage and SNPs"
author: "Cassandra Buzby"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    code_folding: hide
  html_notebook:
    code_folding: hide
---

```{r, warning=FALSE, message=FALSE, comment=FALSE, fig.width=18, fig.height=5}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

#Load packages
require(ggplot2)
require(tidyr)
require(dplyr)
require(reshape2)
require(cowplot)
require(data.table)

require(doParallel)
require(RColorBrewer)
require(scales)
require(circlize) 
require(stringr)

require(cybrBSA)


#TESTING
#glm_formula <- "Allele ~ Bulk * Parent + Rep"

ggplot2::theme_set(theme_light() + theme(text = element_text(size = 10)))

ChromosomeScale <- data.frame(CHROM = factor(as.character(as.roman(1:16)),
                                             levels = as.character(as.roman(1:16))),
                              start = rep(1, 16),
                              end = c(.23,.81,.32, 1.53, .58, .27, 1.09, .56, .44, .75, .67, 1.08, .92, .78, 1.09, .95)*1000000) %>% 
  pivot_longer(c(start, end), names_to = "delete", values_to = "POS") %>%
  mutate(Summary = NA, Label = NA) %>% select(-delete)

ChromosomeScale$Start <- 30000
ChromosomeScale$End <- ChromosomeScale$POS - 30000

ChromosomeScale2 <- data.frame(CHROM = factor(as.character(as.roman(1:16)),
                                             levels = as.character(as.roman(1:16))),
                              start = rep(1, 16),
                              end = c(.23,.81,.32, 1.53, .58, .27, 1.09, .56, .44, .75, .67, 1.08, .92, .78, 1.09, .95)*1000000) %>% 
  pivot_longer(c(start, end), names_to = "delete", values_to = "POS") %>%
  mutate(summary = 0, label = "Bulk") %>% select(-delete)

# Loci to look at specifically

myloci <- data.frame(CHROM = c("V","V","IX", "III", "IV", "I", "III"),
                     POS = c(375215, 116167,389572, 198671, 46271, 203403, 260311),
                     name = c("FLO8", "URA3", "FLO11", "MAT", "HO", "FLO1", "TUP1"),
                     cat = c("Floc", "X", "Floc", "X", "X", "Floc", "Floc"))

```

# Functions

```{r}
# glm_cb <- function(..., W, formula) {
#   data <- list(...)
#   
#   if (is.null(W) || is.null(formula)) {
#     stop("Weights (W) and formula must be provided")
#   }
#   
#   glm_formula <- as.formula(formula)
#   
#   if (!all(names(data) %in% all.vars(glm_formula))) {
#     stop("One or more variables in the formula are not provided as arguments")
#   }
#   
#   #CHANGE THIS TO ADJUST TYPE OF REGRESSION
#   glm_fit <- glm(glm_formula, data = as.data.frame(data), weights = W, family = binomial)
#   
#   #Output: Effect, Standard Error, Z-score 
#   #(ignores p-value since it can be calculated from Z score; multiply by 1 if you would like to retain it)
#   return(summary(glm_fit)$coefficients[1:((length(summary(glm_fit)$coefficients)*0.75))])
#   
# }

glm_cb2_short <- function(..., W, formula, numgroups = FALSE, outputlength = 4, return = c("Z")) {
  data <- list(...)
  
  #Ensure that there is a formula and W parameter
  if (is.null(W) || is.null(formula)) {
    stop("Weights (W) and formula must be provided")
  }
  #Set formula
  glm_formula <- as.formula(formula)
  #Ensure that formula works for the data provided
  if (!all(names(data) %in% all.vars(glm_formula))) {
    stop("One or more variables in the formula are not provided as arguments")
  }
  
  #########################
  #MAYBEWORKS
  for(i in all.vars(glm_formula)){
    if(length(unique(as.data.frame(data)[,i])) < 2){
      output <- rep(NA, outputlength)
      #print("Not enough levels within groups")
      
      return(output)
    }
  }
  
  glm_fit <- glm(glm_formula, data = as.data.frame(data), weights = W, family = binomial)
  
  #Return specific ones like z-score only
  if(return %in% "Z"){
    output <- summary(glm_fit)$coefficients[((length(summary(glm_fit)$coefficients)*0.5)+1):((length(summary(glm_fit)$coefficients)*0.75))]
  }
  
  if(length(output) == outputlength){
    return(output)
  }else{
    return(rep(NA, outputlength))
  }
  
}

############################ PERMUTATIONS ######################################
# Replicates, all scrambled
cybrPermute_Rep <- function(dataset){
  
  start.time <- Sys.time()
  
  dataset %>% 
  distinct() %>% ungroup() %>%
  group_by(CHROM, POS, Allele, 
           Bulk, 
           Rep, #might not have these
           Parent) %>% 
  summarize(culprits = length((SmoothCount))) %>% 
  merge(dataset) %>% 
  filter(culprits == 1) %>% 
  ungroup() %>%
  distinct() %>% #THIS IS IMPORTANT
  pivot_wider(names_from = Allele, values_from = SmoothCount) -> newnewtest

  #these are now all of the ones that can be used to permute
  newnewtest %>% filter(Bulk != "F", CHROM != "I", CHROM != "III", CHROM != "VIII") %>% select(CHROM, Oak, Wine) %>% 
    mutate(rownum = sample(1:nrow(.))) %>% arrange(rownum) %>% na.omit() -> NullToSample
  
  #Trying this again
  
  dataset[1:nrow(NullToSample),] %>% ungroup() %>% select(CHROM, POS, Bulk, Parent, Rep) %>% cbind(NullToSample[,c("Oak", "Wine")]) %>%
    pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "SmoothCount") %>%
    #Original Script
    group_by(CHROM, POS) %>%
    mutate_if(is.character, as.factor) %>%
      summarize(Summary = glm_cb2_short(Allele = Allele,
                               Bulk = Bulk,
                               Parent = Parent,
                               Rep = Rep,
                               W = SmoothCount,
                               formula = "Allele ~ Bulk * Parent + Rep",
                               outputlength = 5),
              Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> glmresult

  end.time = Sys.time()
  print(end.time - start.time)
  
  return(glmresult)
  
}
# No replicates, fix CHROM, Parent
# No replicates, fix Parent

# Replicates, fix CHROM, Parent
cybrPermute_byCHRParent_Rep <- function(dataset){
   start.time <- Sys.time()
  
   print("Make sure that dilute bulk is labeled D")
   
    dataset %>% 
      distinct() %>% ungroup() %>%
      group_by(CHROM, POS, Allele, 
               Bulk, 
               Rep, #might not have these
               Parent) %>% 
      summarize(culprits = length((SmoothCount))) %>% 
      merge(dataset) %>% 
      filter(culprits == 1) %>% 
      ungroup() %>%
      distinct() %>% #THIS IS IMPORTANT
      pivot_wider(names_from = Allele, values_from = SmoothCount) -> newnewtest
    
    #these are now all of the ones that can be used to permute
    newnewtest %>% filter(Bulk == "D") %>% select(CHROM, POS, Parent, Oak, Wine) %>% 
      group_by(CHROM, Parent) %>%
      summarize(CHROM = CHROM, Parent = Parent, Oak = Oak, Wine = Wine, POS = POS,
                POS2 = sample(POS)) %>%
      group_by(CHROM, Parent, POS2) %>%
      summarize(CHROM = CHROM, Parent = Parent, Oak = Oak, Wine = Wine,
                POS = POS2, 
                Rep = sample(c("a", "b"))) %>%
      mutate(Bulk = "A") -> shuffled_DiluteA
    
    newnewtest %>% filter(Bulk == "D") %>% select(CHROM, POS, Parent, Oak, Wine) %>% 
      group_by(CHROM, Parent) %>%
      summarize(CHROM = CHROM, Parent = Parent, Oak = Oak, Wine = Wine, POS = POS,
                POS2 = sample(POS)) %>%
      group_by(CHROM, Parent, POS2) %>%
      summarize(CHROM = CHROM, Parent = Parent, Oak = Oak, Wine = Wine,
                POS = POS2, 
                Rep = sample(c("a", "b"))) %>%
      mutate(Bulk = "B") -> shuffled_DiluteB
    
    rbind(shuffled_DiluteA, shuffled_DiluteB) %>% pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "SmoothCount") -> shuffletoglm
    
    #Trying this again
    
    shuffletoglm %>% na.omit() %>%
      #Original Script
      group_by(CHROM, POS) %>%
      mutate_if(is.character, as.factor) %>%
        summarize(Summary = glm_cb2_short(Allele = Allele,
                                 Bulk = Bulk,
                                 Parent = Parent,
                                 Rep = Rep,
                                 W = SmoothCount,
                                 formula = "Allele ~ Bulk * Parent + Rep",
                                numgroups = 16, outputlength = 5),
                Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> glmresult
    end.time = Sys.time()
    print(end.time - start.time)
    return(glmresult)
}

# Replicates, fix Parent
cybrPermute_byParent_Rep <- function(dataset){
  start.time <- Sys.time()
    
  print("Make sure that dilute bulk is labeled D")

  dataset %>% 
  distinct() %>% ungroup() %>%
  group_by(CHROM, POS, Allele, 
           Bulk, 
           Rep, #might not have these
           Parent) %>% 
  summarize(culprits = length((SmoothCount))) %>% 
  merge(dataset) %>% 
  filter(culprits == 1) %>% 
  ungroup() %>%
  distinct() %>% #THIS IS IMPORTANT
  pivot_wider(names_from = Allele, values_from = SmoothCount) -> newnewtest
  
  #these are now all of the ones that can be used to permute
    newnewtest %>% filter(Bulk == "D",
                          CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
      select(CHROM, POS, Parent, Oak, Wine) %>% 
      group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
      summarize(Parent = Parent, Oak = Oak, Wine = Wine, 
                Loc = sample(Loc)) %>%
      group_by(Parent, Loc) %>%
      summarize(Parent = Parent, Oak = Oak, Wine = Wine,
                Loc = Loc, 
                Rep = sample(c("a", "b"))) %>%
      mutate(Bulk = "A") -> shuffled_DiluteA2
    
    newnewtest %>% filter(Bulk == "D",
                          CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
      select(CHROM, POS, Parent, Oak, Wine) %>% 
      group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
      summarize(Parent = Parent, Oak = Oak, Wine = Wine, 
                Loc = sample(Loc)) %>%
      group_by(Parent, Loc) %>%
      summarize(Parent = Parent, Oak = Oak, Wine = Wine,
                Loc = Loc, 
                Rep = sample(c("a", "b"))) %>%
      mutate(Bulk = "B") -> shuffled_DiluteB2
    
    rbind(shuffled_DiluteA2, shuffled_DiluteB2) %>% pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "SmoothCount") -> shuffletoglm2
    
    #Trying this again
    
    shuffletoglm2 %>% na.omit() %>%
      #Original Script
      group_by(Loc) %>%
      mutate_if(is.character, as.factor) %>%
        summarize(Summary = glm_cb2_short(Allele = Allele,
                                 Bulk = Bulk,
                                 Parent = Parent,
                                 Rep = Rep,
                                 W = SmoothCount,
                                 formula = "Allele ~ Bulk * Parent + Rep",
                                numgroups = 16, outputlength = 5),
                Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> glmresult2
  
    end.time = Sys.time()
    print(end.time - start.time)
    
    return(glmresult2)
}
  
```

Note: if looking for smoothed vs unsmoothed data, the `Figures_2023_BiologyofGenomes.rmd` file has these at the beginning.

# Loading In Data

GQ Cutoff is 98 for all samples, so find out how many of these are under 98 and in which samples that tends to occur

```{r}
setwd("C:/Users/cassa/OneDrive/Documents/GitHub/Sequencing/Analysis")

parentSNPids <- cybrConvertParentalAlleles(ParentFiles = c("Wine_VCF.txt", "Oak_VCF.txt"), Truncate = TRUE)
parentSNPids %>% group_by(CHROM, POS) %>% summarize(Type = Type, Unique = length(unique(Type))) %>% filter(Unique == 1) -> pSNPs
pSNPs$CHROM <- factor(pSNPs$CHROM, levels = as.character(as.roman(1:17)))

```

## Table Processing
```{r}
MQCRuns <- read.csv("C:\\Users\\cassa\\OneDrive\\Documents\\SiegalLab\\Sequencing_Tuboweb\\AllMultiQCRuns.csv")

MQCRuns %>% select(Pool, ShortName, VCF_Table) %>% distinct() -> RawFiles

for(i in 1:length(RawFiles$VCF_Table)){
  cybrInputGATKTable(RawFiles$VCF_Table[i]) %>% mutate(Coverage = as.numeric(AD.REF) + as.numeric(AD.ALT)) %>%
  select(POS, CHROM, Dataset, GQ, AD.REF, AD.ALT, Coverage) %>% mutate(Pool = RawFiles$Pool[i])-> rawdata

  if(i > 1){
    alldata <- rbind(rawdata, alldata)
  }else{
    alldata <- rawdata
  }

}

alldata %>% distinct() %>%
  mutate(Dataset = gsub(".*_n01_", "", Dataset)) %>%
  mutate(Dataset = gsub("\\.fastq$", "", Dataset)) -> alldata

saveRDS(alldata, file = "allseqruns_nov23.rds")

alldata <- readRDS("allseqruns_nov23.rds")

#unique(alldata$Pool)
```
For any new datasets:

```{r, eval = FALSE}
#LOAD IN ORIGINAL
alldata <- readRDS("allseqruns_nov23.rds")

#LOAD IN TABLE
MQCRuns <- read.csv("C:\\Users\\cassa\\OneDrive\\Documents\\SiegalLab\\Sequencing_Tuboweb\\AllMultiQCRuns.csv")

MQCRuns %>% select(Pool, ShortName, VCF_Table) %>% distinct() -> RawFiles

var <- 1 #CHANGE THIS FOR THE INDEX OF RawFiles YOU'RE ANALYZING
RawFiles$Pool[var] #CHECK THAT IT'S RIGHT

for(i in var){
  cybrInputGATKTable(RawFiles$VCF_Table[i]) %>% mutate(Coverage = as.numeric(AD.REF) + as.numeric(AD.ALT)) %>%
  select(POS, CHROM, Dataset, GQ, AD.REF, AD.ALT, Coverage) %>% mutate(Pool = RawFiles$Pool[i])-> rawdata

}

rawdata %>% distinct() %>%
  mutate(Dataset = gsub(".*_n01_", "", Dataset)) %>%
  mutate(Dataset = gsub("\\.fastq$", "", Dataset)) -> rawdata

#SMOOTHING ETC
rawdata %>% #head(3000) %>%
  merge(parentSNPids) %>% mutate(REFW = as.numeric(Type == "Wine"), REFO = as.numeric(Type == "Oak")) %>%
  group_by(Dataset, CHROM, POS) %>%
  mutate(Wine = max(REFW * as.numeric(AD.REF), REFO * as.numeric(AD.ALT)),
         Oak = max(REFW * as.numeric(AD.ALT), REFO * as.numeric(AD.REF))) %>%
  select(Pool, Dataset, POS, CHROM, Coverage, Wine, Oak) %>%
  pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "Reads") -> rawdata_called

rawdata_called %>% group_by(Pool, Dataset, CHROM, Allele) %>% arrange(POS) %>%
  reframe(POS = POS, SmoothCount = ceiling(frollapply(Reads, n = 200, FUN = median, align = "center"))) -> rawdata_smoothed #%>% na.omit()

################################################################################
# COMBINE WITH ALLDATA FILES
################################################################################

alldata <- rbind(alldata, rawdata)

alldata_called <- readRDS(file = "Oct23_alldata_called.rds")
alldata_called <- rbind(alldata_called, rawdata_called)

alldata_smoothed <- readRDS(file = "Oct23_alldata_smoothed.rds")
alldata_smoothed <- rbind(alldata_smoothed, rawdata_smoothed)

# saveRDS(alldata, file = "allseqruns_dec23.rds")
# saveRDS(alldata_called, file = "alldata_called.rds")
# saveRDS(alldata_smoothed, file = "alldata_smoothed.rds")

################################################################################
# for quick use, add in as run here:
rawdata_smoothed -> Hsomething_smoothed
Hsomething_smoothed %>% group_by(CHROM, POS, Dataset) %>% count(Allele) -> Hsomething_counts

```

```{r}
alldata %>% #head(3000) %>%
  merge(parentSNPids) %>% mutate(REFW = as.numeric(Type == "Wine"), REFO = as.numeric(Type == "Oak")) %>%
  group_by(Dataset, CHROM, POS) %>%
  mutate(Wine = max(REFW * as.numeric(AD.REF), REFO * as.numeric(AD.ALT)),
         Oak = max(REFW * as.numeric(AD.ALT), REFO * as.numeric(AD.REF))) %>%
  select(Pool, Dataset, POS, CHROM, Coverage, Wine, Oak) %>%
  pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "Reads") -> alldata_called

alldata_called %>% group_by(Pool, Dataset, CHROM, Allele) %>% arrange(POS) %>%
  reframe(POS = POS, SmoothCount = ceiling(frollapply(Reads, n = 200, FUN = median, align = "center"))) -> alldata_smoothed #%>% na.omit()

saveRDS(alldata_called, file = "Nov23_alldata_called.rds")
saveRDS(alldata_smoothed, file = "Nov23_alldata_smoothed.rds")

# alldata_called <- readRDS(file = "Nov23_alldata_called.rds")
# alldata_smoothed <- readRDS(file = "Nov23_alldata_smoothed.rds")

```

Use _e dataset to ensure that the ends of the chromosomes are not there

```{r, fig.width = 15, fig.height = 4}
alldata_smoothed %>%
  filter(POS > 30000) %>% 
  merge(ChromosomeScale[,c("CHROM", "End")]) %>% 
  filter(End > 0) %>% 
  group_by(CHROM) %>% 
  filter(POS < End) -> alldata_smoothed_e

#saveRDS(alldata_smoothed_e, file = "Dec23_alldata_smoothed_e.rds")

alldata_smoothed_e <- readRDS(file = "Dec23_alldata_smoothed_e.rds")

```

## Separate each out into independent datasets to run GLM

```{r}
# HNGLVDRXY = CuSO4a (CSS1)
alldata_smoothed_e %>% filter(Pool == "HNGLVDRXY") -> HNGLVDRXY_smoothed
#HNGLVDRXY_smoothed %>% group_by(CHROM, POS, Dataset) %>% count(Allele) -> HNGLVDRXY_counts

# HKTFTDRX2 = CuSO4b (CSS1)
alldata_smoothed_e %>% filter(Pool == "HKTFTDRX2") -> HKTFTDRX2_smoothed
#HKTFTDRX2_smoothed %>% group_by(CHROM, POS, Dataset) %>% count(Allele) -> HKTFTDRX2_counts

# HVYTYDRX2 = CSS8 Fluc and CuSO4, also CSS1
alldata_smoothed_e %>% filter(Pool == "HVYTYDRX2") -> HVYTYDRX2_smoothed
#HVYTYDRX2_smoothed %>% group_by(CHROM, POS, Dataset) %>% count(Allele) -> HVYTYDRX2_counts

# HGVMDRX2 = Fluconazole CSS I 
alldata_smoothed_e %>% filter(Pool == "HGVMVDRX2") -> HGVMVDRX2_smoothed
#HGVMVDRX2_smoothed %>% group_by(CHROM, POS, Dataset) %>% count(Allele) -> HGVMVDRX2_counts

# HJ5HKDRX3 = H2O2 data X
alldata_smoothed_e %>% filter(Pool == "HJ5HKDRX3") -> HJ5HKDRX3_smoothed
#HJ5HKDRX3_smoothed %>% group_by(CHROM, POS, Dataset) %>% count(Allele) -> HJ5HKDRX3_counts

# HKTMWDRX2 = Zeocin/Cycloheximide X
alldata_smoothed_e %>% filter(Pool == "HKTMWDRX2") -> HKTMWDRX2_smoothed
#HKTMWDRX2_smoothed %>% group_by(CHROM, POS, Dataset) %>% count(Allele) -> HKTMWDRX2_counts

# ADD NEW ONES DOWN HERE
# CuSO4 done again
alldata_smoothed_e %>% filter(Pool == "xHNGLVDRXY") -> xHNGLVDRXY_smoothed

```

# Permutations Standard

## Check distribution of log alleles between parents, bulks, and replicates

```{r, fig.width= 8, fig.height=10, eval = FALSE}

alldata_smoothed_e %>% distinct() %>% ungroup() %>%
  group_by(Pool, Dataset, CHROM, POS, Allele) %>% 
  summarize(culprits = length((SmoothCount))) %>% 
  merge(alldata_smoothed_e) %>% 
  filter(culprits == 1) %>% 
  ungroup() %>%
  distinct() %>% #THIS IS IMPORTANT
  pivot_wider(names_from = Allele, values_from = SmoothCount) %>%
  mutate(logodds = log(Wine/Oak)) -> alldata_logodds


# alldata_logodds %>% ggplot(aes(x = logodds, y = Dataset, color = Pool)) + geom_boxplot()
# alldata_logodds %>% ggplot(aes(x = abs(logodds), color = Dataset)) + geom_density()

################################################################################
alldata_logodds %>% filter(CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>%  
  filter(grepl("D", Dataset)) %>% 
  filter(grepl("Fluc", Dataset) == FALSE) -> alldata_dilutebulks

alldata_dilutebulks %>% ggplot(aes(x = logodds, y = Dataset, color = Pool)) + geom_violin()
alldata_dilutebulks %>% ggplot(aes(x = abs(logodds), color = Dataset)) + geom_density()

alldata_dilutebulks %>% ggplot(aes(x = abs(logodds), color = Dataset)) + geom_density()

```

```{r, fig.height = 8, fig.width=12}
alldata_dilutebulks %>% ggplot(aes(y = logodds, x = Dataset, color = Pool)) + geom_violin() + facet_wrap("CHROM")
```

Look at differences between parents

```{r, fig.width=10, fig.height=4}
alldata_dilutebulks %>% filter(grepl("O", Dataset)) %>% na.omit() %>% mutate(ParentChr = "Oak") -> Oak_dilutes
alldata_dilutebulks %>% filter(grepl("W", Dataset)) %>% na.omit() %>% mutate(ParentChr = "Wine") -> Wine_dilutes

rbind(Oak_dilutes, Wine_dilutes) -> alldata_byparent

alldata_byparent %>% ggplot(aes(y = logodds, x = Dataset, color = ParentChr)) + geom_violin() + facet_wrap("CHROM") + scale_color_manual(values = c("#5A86AD","firebrick"))
alldata_byparent %>% ggplot(aes(y = logodds, x = CHROM, color = ParentChr)) + geom_violin() + scale_color_manual(values = c("#5A86AD","firebrick"))

unique(alldata_byparent$Dataset)

alldata_byparent %>% filter(grepl("8", Dataset)) %>% mutate(Fixed = "8") -> CSS8_dilutes
alldata_byparent %>% filter(grepl("8", Dataset) == FALSE) %>% mutate(Fixed = "1") -> CSS1_dilutes

rbind(CSS8_dilutes, CSS1_dilutes) %>% mutate(Parent = paste(Fixed, ParentChr)) -> alldata_byparentchr

alldata_byparentchr %>% ggplot(aes(x = logodds, y = Fixed, color = ParentChr)) + geom_violin() + scale_color_manual(values = c("#5A86AD","firebrick"))

```

```{r, fig.height = 6, fig.width=15}

#between reps
alldata_byparentchr %>% ggplot(aes(y = logodds, x = Pool, color = paste(Pool, Dataset))) + 
  geom_violin() +   
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_grid(Parent ~ CHROM) + 
  theme(legend.position = "none") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Distribution of log odds Alleles per Replicate")

#By parent
alldata_byparentchr %>% ggplot(aes(y = logodds, x = Parent, color = Fixed)) + 
  geom_violin() +   
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_grid(Pool ~ CHROM) + 
  theme(legend.position = "none") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Distribution of log odds Alleles per Parent")

```

```{r, fig.height=20, fig.width=5}
#By parent
alldata_byparentchr %>% ggplot(aes(x = logodds, y = paste(Fixed, CHROM, Pool), color = Parent)) + 
  geom_violin() +   
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme(legend.position = "none") + 
  ggtitle("Distribution of log odds Alleles per Parent")

```


Permute all of these

## Fluc CSS  VIII PERMUTATIONS

```{r}
# Pick out the specific groups of the dataset
HVYTYDRX2_smoothed %>%  separate(Dataset, into = c("Parent", "Rep_Bulk_Dose"), sep = "_") %>% 
  #CHANGE THE REPS ETC
  separate(Rep_Bulk_Dose, into = c("Rep", "Bulk", "Dose"), sep = "(?<=[a-z,A-Z,0-9])") %>%
  #cont
  mutate(Parent = gsub("0", "O", Parent)) -> HVYTYDRX2_FlucCuSO4_81

HVYTYDRX2_FlucCuSO4_81 %>%
  #Filter for Chr 8 and Bulk D or H
  filter(stringr::str_detect(Parent, '8')) %>% 
  filter(Bulk != "C") %>%
  mutate_if(is.character, as.factor) -> HVYTYDRX2_Fluc_CSS8_glm_prep

HVYTYDRX2_FlucCuSO4_81 %>%
  #Filter for Chr 8 and Bulk D or H
  filter(stringr::str_detect(Parent, '1')) %>% 
  filter(Bulk != "C") %>%
  mutate_if(is.character, as.factor) -> HVYTYDRX2_Fluc_CSS1_glm_prep

HVYTYDRX2_FlucCuSO4_81 %>%
  #Filter for Chr 8 and Bulk D or H
  filter(stringr::str_detect(Parent, '8')) %>% 
  filter(Bulk != "F") %>%
  mutate_if(is.character, as.factor) -> HVYTYDRX2_CuSO4_CSS8_glm_prep
```

```{r, eval = FALSE}

#TEST
HVYTYDRX2_Fluc_CSS8_glm_prep %>% 
  distinct() %>% ungroup() %>%
  group_by(CHROM, POS, Allele, 
           Bulk, 
           Rep, #might not have these
           Parent) %>% 
  summarize(culprits = length((SmoothCount))) %>% 
  merge(HVYTYDRX2_Fluc_CSS8_glm_prep) %>% 
  filter(culprits == 1) %>% 
  ungroup() %>%
  distinct() %>% #THIS IS IMPORTANT
  pivot_wider(names_from = Allele, values_from = SmoothCount) -> newnewtest

#these are now all of the ones that can be used to permute
newnewtest %>% filter(Bulk != "F", CHROM != "I", CHROM != "III", CHROM != "VIII") %>% select(CHROM, Oak, Wine) %>% 
  mutate(rownum = sample(1:nrow(.))) %>% arrange(rownum) %>% na.omit() -> NullToSample

#Trying this again

HVYTYDRX2_Fluc_CSS8_glm_prep[1:nrow(NullToSample),] %>% ungroup() %>% select(CHROM, POS, Bulk, Parent, Rep) %>% cbind(NullToSample[,c("Oak", "Wine")]) %>%
  pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "SmoothCount") %>%
  #Original Script
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
    summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             Rep = Rep,
                             W = SmoothCount,
                             formula = "Allele ~ Bulk * Parent + Rep",
                            numgroups = 16, outputlength = 5),
            Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> glmresult

glmresult %>% ggplot(aes(x = abs(Summary), color = Factor)) + geom_density() + geom_vline(xintercept = quantile(abs(permtest$Summary), 0.95), linetype = "dashed") +
  ggtitle("Permutations for HVYTYDRX2_Fluc_CSS8_glm_prep")

saveRDS(glmresult, file = "HVYTYDRX2_Fluc_CSS8_glm_CUTOFFS.rds")
```

Do this as a function?

```{r}

cybrPermute_Rep <- function(dataset){
  
  start.time <- Sys.time()
  
  dataset %>% 
  distinct() %>% ungroup() %>%
  group_by(CHROM, POS, Allele, 
           Bulk, 
           Rep, #might not have these
           Parent) %>% 
  summarize(culprits = length((SmoothCount))) %>% 
  merge(dataset) %>% 
  filter(culprits == 1) %>% 
  ungroup() %>%
  distinct() %>% #THIS IS IMPORTANT
  pivot_wider(names_from = Allele, values_from = SmoothCount) -> newnewtest

  #these are now all of the ones that can be used to permute
  newnewtest %>% filter(Bulk != "F", CHROM != "I", CHROM != "III", CHROM != "VIII") %>% select(CHROM, Oak, Wine) %>% 
    mutate(rownum = sample(1:nrow(.))) %>% arrange(rownum) %>% na.omit() -> NullToSample
  
  #Trying this again
  
  dataset[1:nrow(NullToSample),] %>% ungroup() %>% select(CHROM, POS, Bulk, Parent, Rep) %>% cbind(NullToSample[,c("Oak", "Wine")]) %>%
    pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "SmoothCount") %>%
    #Original Script
    group_by(CHROM, POS) %>%
    mutate_if(is.character, as.factor) %>%
      summarize(Summary = glm_cb2_short(Allele = Allele,
                               Bulk = Bulk,
                               Parent = Parent,
                               Rep = Rep,
                               W = SmoothCount,
                               formula = "Allele ~ Bulk * Parent + Rep",
                               outputlength = 5),
              Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> glmresult

  end.time = Sys.time()
  print(end.time - start.time)
  
  return(glmresult)
  
}

#this took 2.25 min
HVYTYDRX2_Fluc_CSS8_perm <- cybrPermute_Rep(dataset = HVYTYDRX2_Fluc_CSS8_glm_prep)
```

## Parent and Chrom 

Do this permutation BUT keep *parent* and *chromosome* consistent

```{r, eval = FALSE}
#TEST
HVYTYDRX2_Fluc_CSS8_glm_prep %>% 
  distinct() %>% ungroup() %>%
  group_by(CHROM, POS, Allele, 
           Bulk, 
           Rep, #might not have these
           Parent) %>% 
  summarize(culprits = length((SmoothCount))) %>% 
  merge(HVYTYDRX2_Fluc_CSS8_glm_prep) %>% 
  filter(culprits == 1) %>% 
  ungroup() %>%
  distinct() %>% #THIS IS IMPORTANT
  pivot_wider(names_from = Allele, values_from = SmoothCount) -> newnewtest

#these are now all of the ones that can be used to permute
newnewtest %>% filter(Bulk != "F") %>% select(CHROM, POS, Parent, Oak, Wine) %>% 
  group_by(CHROM, Parent) %>%
  summarize(CHROM = CHROM, Parent = Parent, Oak = Oak, Wine = Wine, POS = POS,
            POS2 = sample(POS)) %>%
  group_by(CHROM, Parent, POS2) %>%
  summarize(CHROM = CHROM, Parent = Parent, Oak = Oak, Wine = Wine,
            POS = POS2, 
            Rep = sample(c("a", "b"))) %>%
  mutate(Bulk = "A") -> shuffled_DiluteA

newnewtest %>% filter(Bulk != "F") %>% select(CHROM, POS, Parent, Oak, Wine) %>% 
  group_by(CHROM, Parent) %>%
  summarize(CHROM = CHROM, Parent = Parent, Oak = Oak, Wine = Wine, POS = POS,
            POS2 = sample(POS)) %>%
  group_by(CHROM, Parent, POS2) %>%
  summarize(CHROM = CHROM, Parent = Parent, Oak = Oak, Wine = Wine,
            POS = POS2, 
            Rep = sample(c("a", "b"))) %>%
  mutate(Bulk = "B") -> shuffled_DiluteB

rbind(shuffled_DiluteA, shuffled_DiluteB) %>% pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "SmoothCount") -> shuffletoglm

#Trying this again

shuffletoglm %>% na.omit() %>%
  #Original Script
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
    summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             Rep = Rep,
                             W = SmoothCount,
                             formula = "Allele ~ Bulk * Parent + Rep",
                            numgroups = 16, outputlength = 5),
            Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> glmresult

glmresult %>% ungroup() %>% group_by(CHROM, Factor) %>% summarize(quant = quantile(abs(Summary), 0.95, na.rm = TRUE)) %>% 
  ggplot(aes(x = CHROM, y = quant, color = Factor)) + geom_point()

glmresult %>% ungroup() %>% group_by(CHROM, Factor) %>% summarize(quant = quantile(abs(Summary), 0.95, na.rm = TRUE)) %>% 
  ggplot(aes(x = CHROM, y = quant)) + geom_boxplot() + geom_jitter(aes(x = CHROM, y = quant, color = Factor))

glmresult %>% ungroup() %>% group_by(CHROM, Factor) %>% summarize(quant = quantile(abs(Summary), 0.95, na.rm = TRUE)) -> fluc_8_cutoffs

saveRDS(fluc_8_cutoffs, file = "fluc_8_cutoffs_CHROM_Parent.rds")
saveRDS(glmresult, file = "fluc_8_perm_CHROM_Parent.rds")

```

## Parent Only
Do this permutation BUT keep *parent* ONLY consistent

```{r, eval = FALSE}
#these are now all of the ones that can be used to permute
newnewtest %>% filter(Bulk != "F",
                      CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
  select(CHROM, POS, Parent, Oak, Wine) %>% 
  group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
  summarize(Parent = Parent, Oak = Oak, Wine = Wine, 
            Loc = sample(Loc)) %>%
  group_by(Parent, Loc) %>%
  summarize(Parent = Parent, Oak = Oak, Wine = Wine,
            Loc = Loc, 
            Rep = sample(c("a", "b"))) %>%
  mutate(Bulk = "A") -> shuffled_DiluteA2

newnewtest %>% filter(Bulk != "F",
                      CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
  select(CHROM, POS, Parent, Oak, Wine) %>% 
  group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
  summarize(Parent = Parent, Oak = Oak, Wine = Wine, 
            Loc = sample(Loc)) %>%
  group_by(Parent, Loc) %>%
  summarize(Parent = Parent, Oak = Oak, Wine = Wine,
            Loc = Loc, 
            Rep = sample(c("a", "b"))) %>%
  mutate(Bulk = "B") -> shuffled_DiluteB2

rbind(shuffled_DiluteA2, shuffled_DiluteB2) %>% pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "SmoothCount") -> shuffletoglm2

#Trying this again

shuffletoglm2 %>% na.omit() %>%
  #Original Script
  group_by(Loc) %>%
  mutate_if(is.character, as.factor) %>%
    summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             Rep = Rep,
                             W = SmoothCount,
                             formula = "Allele ~ Bulk * Parent + Rep",
                            numgroups = 16, outputlength = 5),
            Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> glmresult2

glmresult2 %>% ungroup() %>% group_by(Factor) %>% summarize(quant = quantile(abs(Summary), 0.95, na.rm = TRUE)) %>% 
  ggplot(aes(x = "", y = quant, color = Factor)) + geom_point()

glmresult2 %>% ungroup() %>% group_by(Factor) %>% summarize(quant = quantile(abs(Summary), 0.95, na.rm = TRUE)) %>% 
  ggplot(aes(x = "", y = quant)) + geom_boxplot() + geom_jitter(aes(x = "", y = quant, color = Factor))

glmresult2 %>% ungroup() %>% group_by(Factor) %>% summarize(quant = quantile(abs(Summary), 0.95, na.rm = TRUE)) -> fluc_8_cutoffs_2

saveRDS(fluc_8_cutoffs_2, file = "fluc_8_cutoffs_Parent.rds")
saveRDS(glmresult2, file = "fluc_8_perm_Parent.rds")

################################################################################
#Checking how these distributions differ really
glmresult2 %>% pivot_wider(names_from = Factor, values_from = Summary) %>% ggplot(aes(x = abs(Interaction))) + geom_density()

glmresult2 %>% pivot_wider(names_from = Factor, values_from = Summary) -> glmr2_pivot
glmr2_pivot %>%
  ggplot(aes(x = Bulk, y = Parent, color = abs(Interaction), alpha = abs(Parent) + abs(Bulk))) + geom_point(alpha = 0.2) +
  scale_color_gradient(low = "gray", high = "red")

glmresult2 %>% pivot_wider(names_from = Factor, values_from = Summary) %>% ggplot(aes(x = abs(Bulk), y = abs(Interaction))) + geom_point(alpha = 0.2)

#What is the change in distribution if bulk is high?
glmresult2 %>% pivot_wider(names_from = Factor, values_from = Summary) %>% filter(abs(Bulk) > 1.717164) %>% ungroup() %>% summarize(quant = quantile(abs(Intercept), 0.95)) -> newcutoffa

glmresult2 %>% pivot_wider(names_from = Factor, values_from = Summary) %>% filter(abs(Bulk) > 1.717164) %>% 
  ggplot(aes(x = abs(Intercept))) + 
  geom_density(fill = "red", alpha = 0.5) + 
  geom_density(data = glmr2_pivot, aes(x = abs(Intercept)), fill = "gray", alpha = 0.5) +
  geom_vline(xintercept = newcutoffa$quant, color = "red") +
  geom_vline(xintercept = 1.761415) + ggtitle("abs(Intercept) from Significant (red) vs All (black) Bulk Effects")

#What is the change in distribution if bulk AND parent are high?
glmresult2 %>% pivot_wider(names_from = Factor, values_from = Summary) %>% filter(abs(Bulk) > 1.717164, abs(Parent) > 1.633736) %>% ungroup() %>% summarize(quant = quantile(abs(Intercept), 0.95)) -> newcutoff_b

glmresult2 %>% pivot_wider(names_from = Factor, values_from = Summary) %>% filter(abs(Bulk) > 1.717164, abs(Parent) > 1.633736) %>% 
  ggplot(aes(x = abs(Intercept))) + 
  geom_density(fill = "blue", alpha = 0.5) + 
  geom_density(data = glmr2_pivot, aes(x = abs(Intercept)), fill = "gray", alpha = 0.5) +
  geom_vline(xintercept = newcutoff_b$quant, color = "blue") +
  geom_vline(xintercept = 1.761415) + ggtitle("abs(Intercept) from Significant (red) vs All (black) Bulk and Parent Effects")
```

# Analysis Standard

### Fluc CSS  VIII - DONE (Z score)

```{r, eval = FALSE}

# Pick out the specific groups of the dataset
HVYTYDRX2_smoothed %>%  separate(Dataset, into = c("Parent", "Rep_Bulk_Dose"), sep = "_") %>% 
  #CHANGE THE REPS ETC
  separate(Rep_Bulk_Dose, into = c("Rep", "Bulk", "Dose"), sep = "(?<=[a-z,A-Z,0-9])") %>%
  #cont
  mutate(Parent = gsub("0", "O", Parent)) -> HVYTYDRX2_FlucCuSO4_81

#################################################################################
HVYTYDRX2_FlucCuSO4_81 %>%
  #Filter for Chr 8 and Bulk D or H
  filter(stringr::str_detect(Parent, '8')) %>% 
  filter(Bulk != "C") %>%
  mutate_if(is.character, as.factor) -> HVYTYDRX2_Fluc_CSS8_glm_prep

HVYTYDRX2_FlucCuSO4_81 %>%
  #Filter for Chr 8 and Bulk D or H
  filter(stringr::str_detect(Parent, '1')) %>% 
  filter(Bulk != "C") %>%
  mutate_if(is.character, as.factor) -> HVYTYDRX2_Fluc_CSS1_glm_prep

HVYTYDRX2_FlucCuSO4_81 %>%
  #Filter for Chr 8 and Bulk D or H
  filter(stringr::str_detect(Parent, '8')) %>% 
  filter(Bulk != "F") %>%
  mutate_if(is.character, as.factor) -> HVYTYDRX2_CuSO4_CSS8_glm_prep

#################################################################################
#Test once
testdata <- HVYTYDRX2_Fluc_CSS8_glm_prep %>% filter(CHROM == "I", POS == 60526) %>% arrange(Bulk, Parent, Rep)
table(testdata$Rep, testdata$Bulk, testdata$Parent)
sum(as.data.frame(table(testdata$Rep, testdata$Bulk, testdata$Parent))$Freq) == 16
formula = "Allele ~ Bulk * Parent + Rep"
glm(formula = formula, family = "binomial", data = testdata, weights = SmoothCount)

# Run full dataset
HVYTYDRX2_Fluc_CSS8_glm_prep %>% select(-Dose) %>% na.omit() %>%
  #filter(CHROM == "X", POS == 640028) %>%
  #REMOVE CHROMOSOME OF FIXATION (don't waste resources on that)
  filter(CHROM %in% c("M", "VIII") == FALSE) %>%
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
  summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             Rep = Rep,
                             W = SmoothCount,
                             formula = "Allele ~ Bulk * Parent + Rep",
                            numgroups = 16, outputlength = 5),
            Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> HVYTYDRX2_Fluc_CSS8_glm_all

saveRDS(HVYTYDRX2_Fluc_CSS8_glm_all, file = "StandardGLM/HVYTYDRX2_Fluc_CSS8_glm_all.rds")
```

Testing the cutoffs

```{r, fig.width = 16, fig.height = 4}
HVYTYDRX2_Fluc_CSS8_glm_all <- readRDS("StandardGLM/HVYTYDRX2_Fluc_CSS8_glm_all.rds")
fluc_8_cutoffs_2 <- readRDS("fluc_8_cutoffs_Parent.rds")


HVYTYDRX2_Fluc_CSS8_glm_all %>% ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + geom_line() + 
  geom_hline(data = fluc_8_cutoffs, aes(yintercept = quant, color = Factor)) +
  geom_hline(yintercept = mean(fluc_8_cutoffs_2$quant))+
  facet_grid(Factor~CHROM, space = "free", scales = "free") 

HVYTYDRX2_Fluc_CSS8_glm_all %>% ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + geom_line() + 
  geom_hline(data = fluc_8_cutoffs, aes(yintercept = quant, color = Factor), linetype = "dashed") +
    geom_hline(yintercept = mean(fluc_8_cutoffs_2$quant))+
  facet_grid(~CHROM, space = "free", scales = "free")
```

### CuSO4 CSS VIII - DONE

Permutations for this one

```{r, eval = FALSE}

HVYTYDRX2_CuSO4_CSS8_glm_prep %>% 
  distinct() %>% ungroup() %>%
  group_by(CHROM, POS, Allele, 
           Bulk, 
           Rep, #might not have these
           Parent) %>% 
  summarize(culprits = length((SmoothCount))) %>% 
  merge(HVYTYDRX2_Fluc_CSS8_glm_prep) %>% 
  filter(culprits == 1) %>% 
  ungroup() %>%
  distinct() %>% #THIS IS IMPORTANT
  pivot_wider(names_from = Allele, values_from = SmoothCount) -> newnewtest

#these are now all of the ones that can be used to permute
newnewtest %>% filter(Bulk != "F",
                      CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
  select(CHROM, POS, Parent, Oak, Wine) %>% 
  group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
  summarize(Parent = Parent, Oak = Oak, Wine = Wine, 
            Loc = sample(Loc)) %>%
  group_by(Parent, Loc) %>%
  summarize(Parent = Parent, Oak = Oak, Wine = Wine,
            Loc = Loc, 
            Rep = sample(c("a", "b"))) %>%
  mutate(Bulk = "A") -> shuffled_DiluteA2

newnewtest %>% filter(Bulk != "F",
                      CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
  select(CHROM, POS, Parent, Oak, Wine) %>% 
  group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
  summarize(Parent = Parent, Oak = Oak, Wine = Wine, 
            Loc = sample(Loc)) %>%
  group_by(Parent, Loc) %>%
  summarize(Parent = Parent, Oak = Oak, Wine = Wine,
            Loc = Loc, 
            Rep = sample(c("a", "b"))) %>%
  mutate(Bulk = "B") -> shuffled_DiluteB2

rbind(shuffled_DiluteA2, shuffled_DiluteB2) %>% pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "SmoothCount") -> shuffletoglm2

#Trying this again

shuffletoglm2 %>% na.omit() %>%
  #Original Script
  group_by(Loc) %>%
  mutate_if(is.character, as.factor) %>%
    summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             Rep = Rep,
                             W = SmoothCount,
                             formula = "Allele ~ Bulk * Parent + Rep",
                            numgroups = 16, outputlength = 5),
            Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> glmresult2_c8

glmresult2_c8 %>% ungroup() %>% group_by(Factor) %>% summarize(quant = quantile(abs(Summary), 0.95, na.rm = TRUE)) %>% 
  ggplot(aes(x = "", y = quant, color = Factor)) + geom_point()

glmresult2_c8 %>% ungroup() %>% group_by(Factor) %>% summarize(quant = quantile(abs(Summary), 0.95, na.rm = TRUE)) %>% 
  ggplot(aes(x = "", y = quant)) + geom_boxplot() + geom_jitter(aes(x = "", y = quant, color = Factor))

glmresult2_c8 %>% ungroup() %>% group_by(Factor) %>% summarize(quant = quantile(abs(Summary), 0.95, na.rm = TRUE)) -> cuso4_8_cutoffs_2

saveRDS(cuso4_8_cutoffs_2, file = "cu_8_cutoffs_Parent.rds")
saveRDS(glmresult2_c8, file = "cu_8_perm_Parent.rds")
```

```{r}
chrparentperm_c8 <- cybrPermute_byCHRParent_Rep(HVYTYDRX2_CuSO4_CSS8_glm_prep)

#dataset <- HVYTYDRX2_CuSO4_CSS8_glm_prep
saveRDS(glmresult, file = "cu_8_perm_CHROM_Parent.rds")

```

```{r, eval = FALSE}

# # Pick out the specific groups of the dataset
# HVYTYDRX2_smoothed %>%  separate(Dataset, into = c("Parent", "Rep_Bulk_Dose"), sep = "_") %>% 
#   #CHANGE THE REPS ETC
#   separate(Rep_Bulk_Dose, into = c("Rep", "Bulk", "Dose"), sep = "(?<=[a-z,A-Z,0-9])") %>%
#   #cont
#   mutate(Parent = gsub("0", "O", Parent)) -> HVYTYDRX2_FlucCuSO4_81
# 
# #################################################################################
# HVYTYDRX2_FlucCuSO4_81 %>%
#   #Filter for Chr 8 and Bulk D or H
#   filter(stringr::str_detect(Parent, '8')) %>% 
#   filter(Bulk != "F") %>%
#   mutate_if(is.character, as.factor) %>% mutate(REMOVE = FALSE) -> HVYTYDRX2_CuSO4_CSS8_glm_prep
# 
# table(HVYTYDRX2_CuSO4_CSS8_glm_prep_r$Dose, HVYTYDRX2_CuSO4_CSS8_glm_prep_r$Parent)
# 
# #HVYTYDRX2_CuSO4_CSS8_glm_prep %>% filter((Parent == "O8" & Dose == 5) == FALSE) -> HVYTYDRX2_CuSO4_CSS8_glm_prep
# table(testfilter$Dose, testfilter$Parent)
# 
# HVYTYDRX2_CuSO4_CSS8_glm_prep %>% filter(Parent == "O8", Bulk == "D")

#################################################################################
#Test once
testdata <- HVYTYDRX2_CuSO4_CSS8_glm_prep %>% filter((Parent == "O8" & Dose == 6) |
                                         (Parent == "W8" & Dose == 5) | 
                                         (Parent == "O8" & is.na(Dose) == T) |
                                         (Parent == "W8" & is.na(Dose) == T) ) %>% filter(CHROM == "I", POS == 106953) %>% arrange(Bulk, Parent, Rep)
table(testdata$Rep, testdata$Bulk, testdata$Parent)
sum(as.data.frame(table(testdata$Rep, testdata$Bulk, testdata$Parent))$Freq) == 16
formula = "Allele ~ Bulk * Parent + Rep"
glm(formula = formula, family = "binomial", data = testdata, weights = SmoothCount)

#This isn't right
HVYTYDRX2_CuSO4_CSS8_glm_prep %>% filter((Parent == "O8" & Dose == 6) |
                                         (Parent == "W8" & Dose == 5) | 
                                         (Parent == "O8" & is.na(Dose) == T) |
                                         (Parent == "W8" & is.na(Dose) == T) ) %>%
# Run full dataset
#HVYTYDRX2_CuSO4_CSS8_glm_prep %>% 
  select(-Dose) %>% na.omit() %>%
  #filter(CHROM == "X", POS == 640028) %>%
  #REMOVE CHROMOSOME OF FIXATION (don't waste resources on that)
  filter(CHROM %in% c("M", "VIII") == FALSE) %>%
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
  summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             Rep = Rep,
                             W = SmoothCount,
                             formula = "Allele ~ Bulk * Parent + Rep",
                            numgroups = 16, outputlength = 5),
            Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> HVYTYDRX2_CuSO4_CSS8_glm_all

saveRDS(HVYTYDRX2_CuSO4_CSS8_glm_all, file = "StandardGLM/HVYTYDRX2_CuSO4_CSS8_glm_all.rds")
```

```{r, fig.width = 16, fig.height = 4}
HVYTYDRX2_CuSO4_CSS8_glm_all <- readRDS("StandardGLM/HVYTYDRX2_CuSO4_CSS8_glm_all.rds")
cu8_cutoffs_2 <- readRDS("cu_8_perm_Parent.rds")
cu8_cutoffs <- readRDS("cu_8_perm_CHROM_Parent.rds")

cu8_cutoffs_2 %>% ungroup() %>% summarize(quant = quantile(abs(Summary), 0.95, na.rm = TRUE)) -> cuso4_8_cutoffs_2
cu8_cutoffs %>% ungroup() %>% group_by(CHROM, Factor) %>% summarize(quant = quantile(abs(Summary), 0.95, na.rm = TRUE)) -> cuso4_8_cutoffs

HVYTYDRX2_CuSO4_CSS8_glm_all %>% ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + geom_line() + 
  geom_hline(data = cuso4_8_cutoffs, aes(yintercept = quant, color = Factor)) +
  geom_hline(yintercept = mean(cuso4_8_cutoffs_2$quant))+
  facet_grid(Factor~CHROM, space = "free", scales = "free") 

HVYTYDRX2_CuSO4_CSS8_glm_all %>% ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + geom_line() + 
  geom_hline(data = cuso4_8_cutoffs, aes(yintercept = quant, color = Factor), linetype = "dashed") +
    geom_hline(yintercept = mean(cuso4_8_cutoffs_2$quant))+
  facet_grid(~CHROM, space = "free", scales = "free")
```

### H2O2 CSS  VIII - DONE (Z score)

```{r, eval = FALSE}

# Pick out the specific groups of the dataset
HJ5HKDRX3_smoothed %>% separate(Dataset, into = c("Bulk", "Parent", "Rep"), sep = "_") %>% 
  mutate(Parent = gsub("0", "O", Parent)) %>%
  #Filter for Chr 8 and Bulk D or H
  filter(stringr::str_detect(Parent, '8')) %>% 
  filter(Bulk != "Z") %>%
  mutate_if(is.character, as.factor) -> HJ5HKDRX3_CSS8_glm_prep

#Test once
# testdata <- HJ5HKDRX3_CSS8_glm_prep %>% na.omit() %>% filter(CHROM == "X", POS == 640028) %>% arrange(Bulk, Parent, Rep)
# table(testdata$Rep, testdata$Bulk, testdata$Parent)
# sum(as.data.frame(table(testdata$Rep, testdata$Bulk, testdata$Parent))$Freq) == 16
# formula = "Allele ~ Bulk * Parent + Rep"
# glm(formula = formula, family = "binomial", data = testdata, weights = SmoothCount)

# Run full dataset
HJ5HKDRX3_CSS8_glm_prep %>% na.omit() %>% 
  #filter(CHROM == "X", POS == 640028) %>%
  #REMOVE CHROMOSOME OF FIXATION (don't waste resources on that)
  filter(CHROM %in% c("M", "VIII") == FALSE) %>%
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
  summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             Rep = Rep,
                             W = SmoothCount,
                             formula = "Allele ~ Bulk * Parent + Rep",
                            numgroups = 16, outputlength = 5),
            Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> HJ5HKDRX3_CSS8_glm_all

HJ5HKDRX3_CSS8_glm_all %>% na.omit() %>% dim()

# #Merge with GQ if you want
# alldata %>% filter(Pool == "HJ5HKDRX3", CHROM %in% c("M", "VIII") == FALSE) %>% mutate_if(is.character, as.factor) -> alldata_H2O2
# HJ5HKDRX3_CSS8_glm_all %>% na.omit() %>%
#   merge(alldata_H2O2[,c("POS", "CHROM", "GQ")]) -> HJ5HKDRX3_CSS8_merge_all

saveRDS(HJ5HKDRX3_CSS8_glm_all, file = "StandardGLM/HJ5HKDRX3_CSS8_glm_all.rds")

HJ5HKDRX3_CSS8_perm <- cybrPermute_Rep(dataset = HJ5HKDRX3_CSS8_glm_prep)

```


### CuSO4a, CSS I - DONE (Z score)
Redoing 11/28 to add back in Chr 8
```{r, eval = FALSE}

# Pick out the specific groups of the dataset
HNGLVDRXY_smoothed %>% #head() %>%
    mutate(Dataset = gsub("CuSO4_CSSI_", "", Dataset)) %>%
    mutate(Dataset = gsub("Unselected", "Unselected_", Dataset)) %>%
    mutate(Dataset = gsub("Selected", "Selected_", Dataset)) %>%
  separate(Dataset, into = c("Bulk", "Parent"), sep = "_") %>% 
  mutate_if(is.character, as.factor) -> HNGLVDRXY_CSS1_glm_prep

#Test once
testdata <- HNGLVDRXY_CSS1_glm_prep %>% na.omit() %>% filter(CHROM == "II", POS == 65975) %>% arrange(Bulk, Parent)
table(testdata$Bulk, testdata$Parent)
formula = "Allele ~ Bulk * Parent"
coffee <- glm(formula = formula, family = "binomial", data = testdata, weights = SmoothCount)

# Run full dataset
HNGLVDRXY_CSS1_glm_prep %>% na.omit() %>% 
  #filter(CHROM == "X", POS == 640028) %>%
  #REMOVE CHROMOSOME OF FIXATION (don't waste resources on that)
  filter(CHROM %in% c("M", "I") == FALSE) %>%
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
  summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             #Rep = Rep,
                             W = SmoothCount,
                             formula = "Allele ~ Bulk * Parent",
                            numgroups = 8, outputlength = 4),
            #MAKE SURE THIS IS THE SAME LENGTH AS OUTPUT LENGTH
            Factor = (c("Intercept", "Bulk", "Parent", "Interaction"))) -> HNGLVDRXY_CuSO4_CSS1_glm_all

#HNGLVDRXY_CuSO4_CSS1_glm_all %>% na.omit() %>% dim()

# #Merge with GQ if you want
# alldata %>% filter(Pool == "HNGLVDRXY", CHROM %in% c("M", "VIII") == FALSE) %>% mutate_if(is.character, as.factor) -> alldata_H2O2
# HNGLVDRXY_CSS8_glm_all %>% na.omit() %>%
#   merge(alldata_H2O2[,c("POS", "CHROM", "GQ")]) -> HNGLVDRXY_CSS8_merge_all

saveRDS(HNGLVDRXY_CuSO4_CSS1_glm_all, file = "StandardGLM/HNGLVDRXY_CuSO4_CSS1_glm_all.rds")
```

```{r, eval = FALSE}

# Pick out the specific groups of the dataset
xHNGLVDRXY_smoothed %>% #head() %>%
    mutate(Dataset = gsub("CuSO4_CSSI_", "", Dataset)) %>%
    mutate(Dataset = gsub("Unselected", "Unselected_", Dataset)) %>%
    mutate(Dataset = gsub("Selected", "Selected_", Dataset)) %>%
  separate(Dataset, into = c("Bulk", "Parent"), sep = "_") %>% 
  mutate_if(is.character, as.factor) -> xHNGLVDRXY_CSS1_glm_prep

#Test once
# testdata <- xHNGLVDRXY_CSS1_glm_prep %>% na.omit() %>% filter(CHROM == "II", POS == 65975) %>% arrange(Bulk, Parent)
# table(testdata$Bulk, testdata$Parent)
# formula = "Allele ~ Bulk * Parent"
# glm(formula = formula, family = "binomial", data = testdata, weights = SmoothCount)

# Run full dataset
xHNGLVDRXY_CSS1_glm_prep %>% na.omit() %>% 
  #filter(CHROM == "X", POS == 640028) %>%
  #REMOVE CHROMOSOME OF FIXATION (don't waste resources on that)
  filter(CHROM %in% c("M", "I") == FALSE) %>%
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
  summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             #Rep = Rep,
                             W = SmoothCount,
                             formula = "Allele ~ Bulk * Parent",
                            numgroups = 8, outputlength = 4),
            #MAKE SURE THIS IS THE SAME LENGTH AS OUTPUT LENGTH
            Factor = (c("Intercept", "Bulk", "Parent", "Interaction"))) -> xHNGLVDRXY_CuSO4_CSS1_glm_all

#xHNGLVDRXY_CuSO4_CSS1_glm_all %>% na.omit() %>% dim()

# #Merge with GQ if you want
# alldata %>% filter(Pool == "xHNGLVDRXY", CHROM %in% c("M", "VIII") == FALSE) %>% mutate_if(is.character, as.factor) -> alldata_H2O2
# xHNGLVDRXY_CSS8_glm_all %>% na.omit() %>%
#   merge(alldata_H2O2[,c("POS", "CHROM", "GQ")]) -> xHNGLVDRXY_CSS8_merge_all

saveRDS(xHNGLVDRXY_CuSO4_CSS1_glm_all, file = "StandardGLM/xHNGLVDRXY_CuSO4_CSS1_glm_all.rds")
```

### CuSO4b, CSS I - DONE

```{r, eval = FALSE}

# Pick out the specific groups of the dataset
HKTFTDRX2_smoothed %>% 
  separate(Dataset, into = c("Parent", "Bulk", "Rep"), sep = "(?<=[a-z,A-Z,0-9])") %>% 
  mutate_if(is.character, as.factor) -> HKTFTDRX2_CSS1_glm_prep

#Test once
testdata <- HKTFTDRX2_CSS1_glm_prep %>% na.omit() %>% filter(CHROM == "I", POS == 152004) %>% arrange(Bulk, Parent)
table(testdata$Bulk, testdata$Parent)
formula = "Allele ~ Bulk * Parent + Rep"
glm(formula = formula, family = "binomial", data = testdata, weights = SmoothCount)

# Run full dataset
HKTFTDRX2_CSS1_glm_prep %>% na.omit() %>% 
  #filter(CHROM == "X", POS == 640028) %>%
  #REMOVE CHROMOSOME OF FIXATION (don't waste resources on that)
  filter(CHROM %in% c("M", "I") == FALSE) %>%
  group_by(CHROM, POS) %>% 
  mutate_if(is.character, as.factor) %>%
  summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             Rep = Rep,
                             W = SmoothCount,
                             formula = "Allele ~ Bulk * Parent + Rep",
                            #numgroups = 16, 
                            outputlength = 5),
            #MAKE SURE THIS IS THE SAME LENGTH AS OUTPUT LENGTH
            Factor = (c("Intercept", "Bulk", "Parent", "Rep", "Interaction"))) -> HKTFTDRX2_CuSO4_CSS1_glm_all


saveRDS(HKTFTDRX2_CuSO4_CSS1_glm_all, file = "StandardGLM/HKTFTDRX2_CuSO4_CSS1_glm_all.rds")

HKTFTDRX2_CuSO4_CSS1_glm_all %>% na.omit()
```



# Duplicating reps to balance them (should have fixed effect of 0)
### HGVMDRX2 = Fluconazole CSS I - DONE (Z)
 
```{r, eval = FALSE}
# Pick out the specific groups of the dataset
HGVMVDRX2_smoothed %>% separate(Dataset, into = c("Parent", "Bulk", "Rep"), sep = "_") %>% 
  mutate_if(is.character, as.factor) -> HGVMVDRX2_CSS1_glm_prep

#DUPLICATE MISSING REPLICATES (this experiment only)
HGVMVDRX2_CSS1_glm_prep %>% filter(Parent == "OakI", Bulk == "Dilute", Rep %in% c("B")) %>% 
  mutate(Rep = "C") %>% rbind(HGVMVDRX2_CSS1_glm_prep) -> HGVMVDRX2_CSS1_glm_prepd
HGVMVDRX2_CSS1_glm_prep %>% filter(Parent == "OakI", Bulk == "Dilute", Rep %in% c("B")) %>% 
  mutate(Rep = "D") %>% rbind(HGVMVDRX2_CSS1_glm_prepd) -> HGVMVDRX2_CSS1_glm_prepd
HGVMVDRX2_CSS1_glm_prep %>% filter(Parent == "WineI", Bulk == "Fluc", Rep %in% c("C")) %>% 
  mutate(Rep = "B") %>% rbind(HGVMVDRX2_CSS1_glm_prepd) -> HGVMVDRX2_CSS1_glm_prepd


#Test once
testdata <- HGVMVDRX2_CSS1_glm_prep %>% na.omit() %>% filter(CHROM == "I", POS == 128455) %>% arrange(Bulk, Parent, Rep)
table(testdata$Rep, testdata$Bulk, testdata$Parent)
sum(as.data.frame(table(testdata$Rep, testdata$Bulk, testdata$Parent))$Freq)
formula = "Allele ~ Bulk * Parent + Rep"
glm(formula = formula, family = "binomial", data = testdata, weights = SmoothCount)

# Run full dataset
HGVMVDRX2_CSS1_glm_prep %>% na.omit() %>% 
  #filter(CHROM == "X", POS == 640021) %>%
  #REMOVE CHROMOSOME OF FIXATION (don't waste resources on that)
  filter(CHROM %in% c("M", "I") == FALSE) %>%
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
  summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             Rep = Rep,
                             W = SmoothCount,
                             formula = "Allele ~ Bulk * Parent + Rep",
                            numgroups = 18, outputlength = 6),
            Factor = (c("Intercept", "Bulk", "Parent", "Rep1", "Rep2", "Interaction"))) -> HGVMVDRX2_CSS1_glm_all

HGVMVDRX2_CSS1_glm_all %>% na.omit() %>% dim()

# #Merge with GQ if you want
# alldata %>% filter(Pool == "HGVMVDRX2", CHROM %in% c("M", "VIII") == FALSE) %>% mutate_if(is.character, as.factor) -> alldata_H2O2
# HGVMVDRX2_CSS1_glm_all %>% na.omit() %>%
#   merge(alldata_H2O2[,c("POS", "CHROM", "GQ")]) -> HGVMVDRX2_CSS1_merge_all

saveRDS(HGVMVDRX2_CSS1_glm_all, file = "StandardGLM/HGVMVDRX2_CSS1_glm_all.rds")
```

# Averaging across replicates to fill in missing data (HJ5HKDRX3 and HKTMWDRX2)

### H2O2 
```{r, eval = FALSE, fig.width = 15, fig.height = 4}
HJ5HKDRX3_CSS8_glm_prep %>% group_by(CHROM, POS, Bulk, Parent, Allele) %>% na.omit() %>% summarize(AvgCount = mean(SmoothCount, na.rm = TRUE)) -> HJ5HKDRX3_CSS8_glm_prep_noreps

#Test once
testdata <- HJ5HKDRX3_CSS8_glm_prep_noreps %>% na.omit() %>% filter(CHROM == "I", POS == 30782) %>% arrange(Bulk, Parent)
table(testdata$Bulk, testdata$Parent)
sum(as.data.frame(table(testdata$Bulk, testdata$Parent))$Freq)
formula = "Allele ~ Bulk * Parent"
glm(formula = formula, family = "binomial", data = testdata, weights = AvgCount)

# Run full dataset
HJ5HKDRX3_CSS8_glm_prep_noreps %>% na.omit() %>% 
  #filter(CHROM == "X", POS == 640028) %>%
  #REMOVE CHROMOSOME OF FIXATION (don't waste resources on that)
  filter(CHROM %in% c("M", "VIII") == FALSE) %>%
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
  summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             W = AvgCount,
                             formula = "Allele ~ Bulk * Parent",
                            numgroups = 8, outputlength = 4),
            Factor = (c("Intercept", "Bulk", "Parent", "Interaction"))) -> HJ5HKDRX3_CSS8_glm_all_noreps

HJ5HKDRX3_CSS8_glm_all_noreps %>% na.omit() %>% dim()

# #Merge with GQ if you want
# alldata %>% filter(Pool == "HJ5HKDRX3", CHROM %in% c("M", "VIII") == FALSE) %>% mutate_if(is.character, as.factor) -> alldata_H2O2
# HJ5HKDRX3_CSS8_glm_all %>% na.omit() %>%
#   merge(alldata_H2O2[,c("POS", "CHROM", "GQ")]) -> HJ5HKDRX3_CSS8_merge_all

#saveRDS(HJ5HKDRX3_CSS8_glm_all_noreps, file = "StandardGLM/Z_HJ5HKDRX3_CSS8_glm_all_noreps.rds")

HJ5HKDRX3_CSS8_glm_all_noreps <- readRDS("StandardGLM/Z_HJ5HKDRX3_CSS8_glm_all_noreps.rds")

ChromosomeScale %>% select(CHROM, POS) %>% mutate(Summary = NA, Factor = NA) -> ChromScale3

HJ5HKDRX3_CSS8_glm_all_noreps %>%  rbind(ChromScale3) %>% ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + geom_line() + facet_grid(~CHROM, scales = "free", space = "free")
```

```{r, eval = FALSE, fig.width = 15, fig.height = 4}
HJ5HKDRX3_CSS1_glm_prep %>% group_by(CHROM, POS, Bulk, Parent, Allele) %>% na.omit() %>% summarize(AvgCount = mean(SmoothCount, na.rm = TRUE)) -> HJ5HKDRX3_CSS1_glm_prep_noreps

#Test once
testdata <- HJ5HKDRX3_CSS1_glm_prep_noreps %>% na.omit() %>% filter(CHROM == "I", POS == 30479) %>% arrange(Bulk, Parent)
table(testdata$Bulk, testdata$Parent)
sum(as.data.frame(table(testdata$Bulk, testdata$Parent))$Freq)
formula = "Allele ~ Bulk * Parent"
glm(formula = formula, family = "binomial", data = testdata, weights = AvgCount)

# Run full dataset
HJ5HKDRX3_CSS1_glm_prep_noreps %>% na.omit() %>% 
  #filter(CHROM == "X", POS == 640021) %>%
  #REMOVE CHROMOSOME OF FIXATION (don't waste resources on that)
  filter(CHROM %in% c("M", "I") == FALSE) %>%
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
  summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             W = AvgCount,
                             formula = "Allele ~ Bulk * Parent",
                            numgroups = 1, outputlength = 4),
            Factor = (c("Intercept", "Bulk", "Parent", "Interaction"))) -> HJ5HKDRX3_CSS1_glm_all_noreps

HJ5HKDRX3_CSS1_glm_all_noreps %>% na.omit() %>% dim()

# #Merge with GQ if you want
# alldata %>% filter(Pool == "HJ5HKDRX3", CHROM %in% c("M", "VIII") == FALSE) %>% mutate_if(is.character, as.factor) -> alldata_H2O2
# HJ5HKDRX3_CSS1_glm_all %>% na.omit() %>%
#   merge(alldata_H2O2[,c("POS", "CHROM", "GQ")]) -> HJ5HKDRX3_CSS1_merge_all

saveRDS(HJ5HKDRX3_CSS1_glm_all_noreps, file = "StandardGLM/Z_HJ5HKDRX3_CSS1_glm_all_noreps.rds")

ChromosomeScale %>% select(CHROM, POS) %>% mutate(Summary = NA, Factor = NA) -> ChromScale3

HJ5HKDRX3_CSS1_glm_all_noreps %>%  rbind(ChromScale3) %>% filter(CHROM != "I") %>% ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + geom_line() + facet_grid(~CHROM, scales = "free", space = "free")
```

### Zeocin and Cycloheximide CSSI

Do the same no-rep thing for Zeocin and Cycloheximide to see if that helps

```{r, eval = FALSE, fig.width = 15, fig.height = 4}

# Zeocin
HKTMWDRX2_smoothed %>% 
  #Remove or add "Rep" and "Dose" etc
  separate(Dataset, into = c("Parent", "Bulk", "Rep"), sep="(?<=[A-Z])") %>% 
  mutate(Parent = gsub("0", "O", Parent)) %>%
  
  #Filter for Chr 1 and Bulk D or H
  filter(Bulk != "C") %>%

  #Make everything factors
  mutate_if(is.character, as.factor) -> HKTMWDRX2_Zeo_CSS1_glm_prep

# Cycloheximide
HKTMWDRX2_smoothed %>% 
  #Remove or add "Rep" and "Dose" etc
  separate(Dataset, into = c("Parent", "Bulk", "Rep"), sep="(?<=[A-Z])") %>% 
  mutate(Parent = gsub("0", "O", Parent)) %>%
  
  #Filter for Chr 1 and Bulk D or H
  filter(Bulk != "Z") %>%

  #Make everything factors
  mutate_if(is.character, as.factor) -> HKTMWDRX2_Cyc_CSS1_glm_prep
```

```{r, eval = FALSE, fig.width = 15, fig.height = 4}
HKTMWDRX2_Cyc_CSS1_glm_prep %>% group_by(CHROM, POS, Bulk, Parent, Allele) %>% na.omit() %>% summarize(AvgCount = mean(SmoothCount, na.rm = TRUE)) -> HKTMWDRX2_Cyc_CSS1_glm_prep_noreps

HKTMWDRX2_Cyc_CSS1_glm_prep_noreps %>% filter(Parent == "W", CHROM == "I")

#Test once
testdata <- HKTMWDRX2_Cyc_CSS1_glm_prep_noreps %>% na.omit() %>% filter(CHROM == "I", POS == 34991) %>% arrange(Bulk, Parent)
table(testdata$Bulk, testdata$Parent)
sum(as.data.frame(table(testdata$Bulk, testdata$Parent))$Freq)
formula = "Allele ~ Bulk * Parent"
glm(formula = formula, family = "binomial", data = testdata, weights = AvgCount)

HKTMWDRX2_Cyc_CSS1_glm_prep_noreps %>% na.omit() %>% 
  #filter(CHROM == "X", POS == 640021) %>%
  #REMOVE CHROMOSOME OF FIXATION (don't waste resources on that)
  filter(CHROM %in% c("M", "I") == FALSE) %>%
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
  summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             W = AvgCount,
                             formula = "Allele ~ Bulk * Parent",
                            numgroups = 1, outputlength = 4),
            Factor = (c("Intercept", "Bulk", "Parent", "Interaction"))) -> HKTMWDRX2_Cyc_CSS1_glm_all_noreps

saveRDS(HKTMWDRX2_Cyc_CSS1_glm_all_noreps, file = "StandardGLM/HKTMWDRX2_Cyc_CSS1_glm_all_noreps.rds")

#PLOT TO CHECK
# HKTMWDRX2_Cyc_CSS1_glm_all_noreps %>% rbind(ChromScale3) %>% filter(CHROM != "I") %>% 
#   ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + geom_line() + 
#   geom_vline(data = myloci, aes(xintercept = POS, color = cat), linewidth = 1, linetype = "dashed") +
#   facet_grid(~CHROM, scales = "free", space = "free") + ggtitle("Cycloheximide CSS I (Rep Avg)")

```

```{r, eval = FALSE, fig.width = 15, fig.height = 4}
HKTMWDRX2_Zeo_CSS1_glm_prep %>% group_by(CHROM, POS, Bulk, Parent, Allele) %>% na.omit() %>% summarize(AvgCount = mean(SmoothCount, na.rm = TRUE)) -> HKTMWDRX2_Zeo_CSS1_glm_prep_noreps

#Test once
# testdata <- HKTMWDRX2_Zeo_CSS1_glm_prep_noreps %>% na.omit() %>% filter(CHROM == "I", POS == 34991) %>% arrange(Bulk, Parent)
# table(testdata$Bulk, testdata$Parent)
# sum(as.data.frame(table(testdata$Bulk, testdata$Parent))$Freq)
# formula = "Allele ~ Bulk * Parent"
# glm(formula = formula, family = "binomial", data = testdata, weights = AvgCount)

HKTMWDRX2_Zeo_CSS1_glm_prep_noreps %>% na.omit() %>% 
  #REMOVE CHROMOSOME OF FIXATION (don't waste resources on that)
  filter(CHROM %in% c("M", "I") == FALSE) %>%
  group_by(CHROM, POS) %>%
  mutate_if(is.character, as.factor) %>%
  summarize(Summary = glm_cb2_short(Allele = Allele,
                             Bulk = Bulk,
                             Parent = Parent,
                             W = AvgCount,
                             formula = "Allele ~ Bulk * Parent",
                            numgroups = 1, outputlength = 4),
            Factor = (c("Intercept", "Bulk", "Parent", "Interaction"))) -> HKTMWDRX2_Zeo_CSS1_glm_all_noreps

saveRDS(HKTMWDRX2_Zeo_CSS1_glm_all_noreps, file = "StandardGLM/HKTMWDRX2_Zeo_CSS1_glm_all_noreps.rds")

#PLOT TO CHECK
# HKTMWDRX2_Zeo_CSS1_glm_all_noreps %>% rbind(ChromScale3) %>% filter(CHROM != "I") %>% 
#   ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + geom_line() +
#   geom_vline(data = myloci, aes(xintercept = POS, color = cat), linewidth = 1, linetype = "dashed") +
# facet_grid(~CHROM, scales = "free", space = "free") + ggtitle("Zeocin CSS I (Rep Avg)")

```

# Load in Processed Data to Plot

```{r}
#SEARCH/REPLACE: "saveRDS(" /""
#SEARCH/REPLACE: ", file = " /"<- readRDS("

#ALL SAVED:
HKTMWDRX2_Zeo_CSS1_glm_all_noreps <- readRDS("StandardGLM/HKTMWDRX2_Zeo_CSS1_glm_all_noreps.rds") #zeo
HKTMWDRX2_Cyc_CSS1_glm_all_noreps <- readRDS("StandardGLM/HKTMWDRX2_Cyc_CSS1_glm_all_noreps.rds") #cyc

HJ5HKDRX3_CSS1_glm_all_noreps <- readRDS("StandardGLM/Z_HJ5HKDRX3_CSS1_glm_all_noreps.rds") #H2O21
HJ5HKDRX3_CSS8_glm_all_noreps <- readRDS("StandardGLM/Z_HJ5HKDRX3_CSS8_glm_all_noreps.rds") #H2o28

HGVMVDRX2_CSS1_glm_all <- readRDS("StandardGLM/HGVMVDRX2_CSS1_glm_all.rds") #Fluc1
HVYTYDRX2_Fluc_CSS8_glm_all<- readRDS("StandardGLM/HVYTYDRX2_Fluc_CSS8_glm_all.rds") #fluc8

HNGLVDRXY_CuSO4_CSS1_glm_all <- readRDS("StandardGLM/HNGLVDRXY_CuSO4_CSS1_glm_all.rds") #cu1
xHNGLVDRXY_CuSO4_CSS1_glm_all <- readRDS("StandardGLM/xHNGLVDRXY_CuSO4_CSS1_glm_all.rds") #cu1
HKTFTDRX2_CuSO4_CSS1_glm_all <- readRDS("StandardGLM/HKTFTDRX2_CuSO4_CSS1_glm_all.rds") #currently empty, now fixed

HVYTYDRX2_CuSO4_CSS8_glm_all <- readRDS("StandardGLM/HVYTYDRX2_CuSO4_CSS8_glm_all.rds")

```

```{r}

rbind(data.frame(HKTMWDRX2_Zeo_CSS1_glm_all_noreps, BSA = "Zeo_1"),
      data.frame(HKTMWDRX2_Cyc_CSS1_glm_all_noreps, BSA = "Cyc_1"),
      data.frame(HJ5HKDRX3_CSS1_glm_all_noreps, BSA = "H2O2_1"),
      data.frame(HJ5HKDRX3_CSS8_glm_all_noreps, BSA = "H2O2_8"),
      data.frame(HGVMVDRX2_CSS1_glm_all, BSA = "Fluc_1"),
      data.frame(HVYTYDRX2_Fluc_CSS8_glm_all, BSA = "Fluc_8"),
      data.frame(HNGLVDRXY_CuSO4_CSS1_glm_all, BSA = "CuSO4_1a"),
      data.frame(xHNGLVDRXY_CuSO4_CSS1_glm_all, BSA = "CuSO4_1ax"),
      data.frame(HKTFTDRX2_CuSO4_CSS1_glm_all, BSA = "CuSO4_1b"),
      data.frame(HVYTYDRX2_CuSO4_CSS8_glm_all, BSA = "CuSO4_8")) -> AllRuns_GLM
```

```{r, fig.width = 16, fig.height = 4}
AllRuns_GLM %>% filter(Factor == "Intercept") %>% 
  ggplot(aes(x = POS, y = (Summary), color = BSA)) + geom_line() +
  geom_vline(data = myloci, aes(xintercept = POS, alpha = cat), linewidth = 1, linetype = "dashed") +
  facet_grid(~CHROM, scales = "free", space = "free") + ggtitle("BSA Intercepts")
```
### Bulk Effects

```{r, fig.width = 16, fig.height = 4}
AllRuns_GLM %>% filter(Factor == "Bulk") %>% 
  ggplot(aes(x = POS, y = abs(Summary), color = BSA)) + geom_line() +
  #geom_vline(data = myloci, aes(xintercept = POS, alpha = cat), linewidth = 1, linetype = "dashed") +
  facet_grid(~CHROM, scales = "free", space = "free") + ggtitle("BSA Bulk Z Scores")
```

```{r, fig.width = 16}
AllRuns_GLM %>% filter(Factor == "Bulk") %>% 
  ggplot(aes(x = POS, y = abs(Summary), color = BSA)) + geom_line() +
  #geom_vline(data = myloci, aes(xintercept = POS, alpha = cat), linewidth = 1, linetype = "dashed") +
  facet_grid(BSA~CHROM, space = "free", scales = "free") + ggtitle("BSA Bulk Z Scores")
```
```{r, fig.width = 16, fig.height = 5}
AllRuns_GLM %>% filter(Factor == "Bulk") %>% 
  separate(BSA, into = c("Trait", "FixedChr"), sep = "_") %>%
  ggplot(aes(x = POS, y = abs(Summary), color = paste(FixedChr, Trait))) + geom_line() +
  #geom_vline(data = myloci, aes(xintercept = POS, alpha = cat), linewidth = 1, linetype = "dashed") +
  facet_grid(Trait~CHROM, space = "free", scales = "free") + ggtitle("BSA Bulk Z Scores")
```

```{r, fig.width = 16, fig.height = 4}

AllRuns_GLM %>% filter(Factor == "Bulk") %>% 
  separate(BSA, into = c("Trait", "FixedChr"), sep = "_") %>%
  filter(Trait == "CuSO4") %>%
  ggplot(aes(x = POS, y = abs(Summary), linetype = paste(FixedChr, Trait), color = FixedChr == 8)) + geom_line() +
  #geom_vline(data = myloci, aes(xintercept = POS, alpha = cat), linewidth = 1, linetype = "dashed") +
  facet_grid(~CHROM, space = "free", scales = "free") + ggtitle("CuSO4 CSS I BSA Bulk Z Scores")

```

```{r, fig.width = 16, fig.height = 4}
AllRuns_GLM %>% filter(Factor == "Bulk") %>% 
  separate(BSA, into = c("Trait", "FixedChr"), sep = "_") %>%
  filter(Trait == "CuSO4") %>%
  ggplot(aes(x = POS, y = abs(Summary), color = paste(FixedChr, Trait))) + geom_line() +
  #geom_vline(data = myloci, aes(xintercept = POS, alpha = cat), linewidth = 1, linetype = "dashed") +
  facet_grid(FixedChr~CHROM, space = "free", scales = "free") + ggtitle("CuSO4 CSS I BSA Bulk Z Scores")
```

Specifically Chr 8 for CuSO4

```{r, fig.width = 16, fig.height = 8}
AllRuns_GLM %>% filter(Factor == "Bulk") %>% 
  separate(BSA, into = c("Trait", "FixedChr"), sep = "_") %>%
  filter(Trait == "CuSO4", FixedChr != 8, CHROM == "VIII") -> Cu_CSSI_chr8_test

Cu_CSSI_chr8_test %>%
  ggplot(aes(x = POS, y = abs(Summary), color = paste(FixedChr, Trait))) + geom_point(alpha = 0.5) +
  #geom_vline(data = myloci, aes(xintercept = POS, alpha = cat), linewidth = 1, linetype = "dashed") +
  geom_vline(aes(xintercept = 212535)) +
  facet_grid(FixedChr~CHROM, space = "free", scales = "free") + ggtitle("CuSO4 CSS I BSA Bulk Z Scores")
```

## Peaks

Find the peak here to see what the resolution is? Median across 5, then use max value:

```{r}
#Smooth data to get rid of the weird points
Cu_CSSI_chr8_test %>% group_by(FixedChr) %>% arrange(POS) %>%
  reframe(POS = POS, SmoothZ = frollapply(Summary, n = 5, FUN = median, align = "center")) -> Cu_CSSI_chr8_med

#Find the peaks based on max value
Cu_CSSI_chr8_med %>% group_by(FixedChr) %>% summarize(SmoothZ = max(abs(SmoothZ), na.rm = TRUE)) %>%
  merge(Cu_CSSI_chr8_med) -> Cu_CSSI_chr8_peaks

#Plot peaks with CUP1-1 and CUP1-2
Cu_CSSI_chr8_med %>%
  ggplot(aes(x = POS, y = abs(SmoothZ), color = FixedChr)) + geom_point(alpha = 0.5) +
  geom_vline(data = Cu_CSSI_chr8_peaks, aes(xintercept = POS), linetype = "dashed") +
  geom_vline(aes(xintercept = c(212535))) +
  geom_vline(aes(xintercept = c(214533))) +
  facet_grid("FixedChr", space = "free", scales = "free") + ggtitle("CuSO4 CSS I BSA Bulk Z Scores")

#Find difference between start of gene and actual peak for each
Cu_CSSI_chr8_peaks %>% mutate(Diff = abs(POS - 212535)) %>% 
  ggplot(aes(x = Diff, y = 1)) + 
  geom_boxplot(size = 1) + 
  geom_jitter(aes(y = 1, color = FixedChr), size = 4)

Cu_CSSI_chr8_peaks %>% mutate(Diff = abs(POS - 212535)) %>% mutate(Gene = "CUP1") -> PeakSpan
```

Find the peak here to see what the resolution is? Median across 5, then use max value:

```{r}

AllRuns_GLM %>% filter(Factor == "Bulk") %>% 
  separate(BSA, into = c("Trait", "FixedChr"), sep = "_") %>%
  filter(Trait == "Fluc", FixedChr != 8, CHROM == "VIII") -> Flu_CSSI_chr8_test

#Smooth data to get rid of the weird points
Flu_CSSI_chr8_test %>% group_by(FixedChr) %>% arrange(POS) %>%
  reframe(POS = POS, SmoothZ = abs(frollapply(Summary, n = 5, FUN = median, align = "center"))) -> Flu_CSSI_chr8_med

#Find the peaks based on max value
Flu_CSSI_chr8_med %>% group_by(FixedChr) %>% summarize(SmoothZ = max(abs(SmoothZ), na.rm = TRUE)) %>%
  merge(Flu_CSSI_chr8_med) -> Flu_CSSI_chr8_peaks

#Plot peaks with ERG11 
Flu_CSSI_chr8_med %>%
  ggplot(aes(x = POS, y = abs(SmoothZ), color = FixedChr)) + geom_point(alpha = 0.5) +
  geom_vline(data = Flu_CSSI_chr8_peaks, aes(xintercept = POS), linetype = "dashed") +
  geom_vline(aes(xintercept = c(120091))) +
  facet_grid("FixedChr", space = "free", scales = "free") + ggtitle("FluSO4 CSS I BSA Bulk Z Scores")

Flu_CSSI_chr8_peaks %>% mutate(Diff = abs(POS - 120091)) %>% mutate(Gene = "ERG11") %>% rbind(PeakSpan) -> PeakSpan
```

```{r, eval = FALSE, include = FALSE}
#Random thing

sel <- read.csv("C:\\Users\\cassa\\OneDrive\\Documents\\SelectionVsDNA.csv")

sel %>% ggplot(aes(x = Selection, y = ng.uL)) +
  geom_point(aes(color = Rep), size = 2, alpha = 0.5) + 
  geom_smooth(method = "lm") + 
  ggtitle("Cell Number vs DNA Extracted")

sel %>% ggplot(aes(x = Selection, y = ng.uL, color = Rep)) + 
  geom_point(size = 2, alpha = 0.5) + 
  geom_smooth(method = "lm") + 
  ggtitle("Cell Number vs DNA Extracted by Replicate")

summary(lm(sel$ng.uL ~ sel$Selection))

```

