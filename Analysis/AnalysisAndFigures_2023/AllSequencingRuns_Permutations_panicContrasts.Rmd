---
title: "GLM and Permutations for Contrasts"
author: "Cassandra Buzby"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    code_folding: hide
  html_notebook:
    code_folding: hide
---

```{r, warning=FALSE, message=FALSE, comment=FALSE, fig.width=18, fig.height=5}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

#Load packages
require(ggplot2)
require(tidyr)
require(dplyr)
require(reshape2)
require(cowplot)
require(data.table)

require(doParallel)
require(RColorBrewer)
require(scales)
require(circlize) 
require(stringr)

require(cybrBSA)


#TESTING
#glm_formula <- "Allele ~ Bulk * Parent + Rep"

ggplot2::theme_set(theme_light() + theme(text = element_text(size = 10)))

ChromosomeScale <- data.frame(CHROM = factor(as.character(as.roman(1:16)),
                                             levels = as.character(as.roman(1:16))),
                              start = rep(1, 16),
                              end = c(.23,.81,.32, 1.53, .58, .27, 1.09, .56, .44, .75, .67, 1.08, .92, .78, 1.09, .95)*1000000) %>% 
  pivot_longer(c(start, end), names_to = "delete", values_to = "POS") %>%
  mutate(Summary = NA, Label = NA) %>% select(-delete)

ChromosomeScale$Start <- 30000
ChromosomeScale$End <- ChromosomeScale$POS - 30000

ChromosomeScale2 <- data.frame(CHROM = factor(as.character(as.roman(1:16)),
                                             levels = as.character(as.roman(1:16))),
                              start = rep(1, 16),
                              end = c(.23,.81,.32, 1.53, .58, .27, 1.09, .56, .44, .75, .67, 1.08, .92, .78, 1.09, .95)*1000000) %>% 
  pivot_longer(c(start, end), names_to = "delete", values_to = "POS") %>%
  mutate(summary = 0, label = "Bulk") %>% select(-delete)

# Loci to look at specifically

myloci <- data.frame(CHROM = c("V","V","IX", "III", "IV", "I", "III"),
                     POS = c(375215, 116167,389572, 198671, 46271, 203403, 260311),
                     name = c("FLO8", "URA3", "FLO11", "MAT", "HO", "FLO1", "TUP1"),
                     cat = c("Floc", "X", "Floc", "X", "X", "Floc", "Floc"))

```

## Functions for GLM all and Permutation all

```{r}
glm_cb2_all <- function(..., W, formula, numgroups = FALSE, outputlength = 8) {
  data <- list(...)
  
  #Ensure that there is a formula and W parameter
  if (is.null(W) || is.null(formula)) {
    stop("Weights (W) and formula must be provided")
  }
  #Set formula
  glm_formula <- as.formula(formula)
  #Ensure that formula works for the data provided
  if (!all(names(data) %in% all.vars(glm_formula))) {
    stop("One or more variables in the formula are not provided as arguments")
  }
  
  #########################
  for(i in all.vars(glm_formula)){
    if(length(unique(as.data.frame(data)[,i])) < 2){
      output <- rep(NA, outputlength)
      #print("Not enough levels within groups")
      
      return(output)
    }
  }
  
  glm_fit <- glm(glm_formula, data = as.data.frame(data), weights = W, family = binomial)
  
  output <- summary(glm_fit)$coefficients[c(((length(summary(glm_fit)$coefficients)*0)+1):
                                            ((length(summary(glm_fit)$coefficients)*0.25)),
                                            ((length(summary(glm_fit)$coefficients)*0.5)+1):
                                            ((length(summary(glm_fit)$coefficients)*0.75)))]

  
  if(length(output) == outputlength){
    return(output)
  }else{
    return(rep(NA, outputlength))
  }
  
} 

```

```{r}
################################################################################
# No replicates, fix Parent
cybrPermute_cb2_all <- function(dataset, 
                                R = 0, perp = 1, outlength = 4, 
                                glmform = "Allele ~ Bulk * Parent", 
                                inputlabels = c("Intercept", "Bulk", "Parent", "Interaction")){
  start.time <- Sys.time()
    
  print("Make sure that dilute bulk is labeled aD")
  print(paste("Your labels are:", inputlabels))

    if(R > 0){ #INCLUDE REPLICATES
        dataset %>% 
        distinct() %>% ungroup() %>%
        group_by(CHROM, POS, Allele, Bulk, Rep, Parent) %>% 
        summarize(culprits = length((SmoothCount))) %>% 
        merge(dataset) %>% 
        filter(culprits == 1) %>% 
        ungroup() %>%
        distinct() %>% #THIS IS IMPORTANT
        pivot_wider(names_from = Allele, values_from = SmoothCount) -> newnewtest    
    }else{ #DO NOT INCLUDE REPLICATES
        dataset %>% 
        distinct() %>% ungroup() %>%
        group_by(CHROM, POS, Allele, Bulk, Parent) %>% 
        summarize(culprits = length((SmoothCount))) %>% 
        merge(dataset) %>% 
        filter(culprits == perp) %>% 
        ungroup() %>%
        distinct() %>% #THIS IS IMPORTANT
        pivot_wider(names_from = Allele, values_from = SmoothCount) -> newnewtest
    }
  
    #PERMUTE TWICE
  if(R > 0){
    newnewtest %>% filter(Bulk == "aD",
                          CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
      select(CHROM, POS, Rep, 
             Parent, Oak, Wine) %>% 
      group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
      summarize(Parent = Parent, Rep = Rep, 
                Oak = Oak, Wine = Wine, Loc = sample(Loc)) %>%
      mutate(Bulk = "A") -> shuffled_DiluteA2
    
    newnewtest %>% filter(Bulk == "aD",
                          CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
      select(CHROM, POS, 
             Rep, Parent, Oak, Wine) %>% 
      group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
      summarize(Parent = Parent, Rep = Rep,
                Oak = Oak, Wine = Wine, Loc = sample(Loc)) %>%
      mutate(Bulk = "B") -> shuffled_DiluteB2
    
  }else{
    newnewtest %>% filter(Bulk == "aD",
                          CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
      select(CHROM, POS, Parent, Oak, Wine) %>% 
      group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
      summarize(Parent = Parent, Oak = Oak, Wine = Wine, Loc = sample(Loc)) %>%
      mutate(Bulk = "A") -> shuffled_DiluteA2
    
    newnewtest %>% filter(Bulk == "aD",
                          CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
      select(CHROM, POS, Parent, Oak, Wine) %>% 
      group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
      summarize(Parent = Parent, Oak = Oak, Wine = Wine, Loc = sample(Loc)) %>%
      mutate(Bulk = "B") -> shuffled_DiluteB2
    
  }
    
    rbind(shuffled_DiluteA2, shuffled_DiluteB2) %>% pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "SmoothCount") -> shuffletoglm2
    
    #RUN THE GLM
    if(R > 0) {
      shuffletoglm2 %>% na.omit() %>%
      group_by(Loc) %>%
      mutate_if(is.character, as.factor) %>%
        summarize(Summary = glm_cb2_all(Allele = Allele,
                                 Bulk = Bulk,
                                 Parent = Parent,
                                 Rep = Rep,
                                 W = SmoothCount,
                                 formula = glmform,
                                outputlength = length(inputlabels)*2),
                Factor = rep(inputlabels, 2),
                d = c(rep("Effect", length(inputlabels)),
                      rep("Z", length(inputlabels)))) -> glmresult
    }else{
      shuffletoglm2 %>% na.omit() %>%
      #Original Script
      group_by(Loc) %>%
      mutate_if(is.character, as.factor) %>%
        summarize(Summary = glm_cb2_all(Allele = Allele,
                                 Bulk = Bulk,
                                 Parent = Parent,
                                 W = SmoothCount,
                                 formula = glmform,
                                outputlength = length(inputlabels)*2),
                Factor = rep(inputlabels, 2),
                d = c(rep("Effect", length(inputlabels)),
                      rep("Z", length(inputlabels)))) -> glmresult
    }
    
    
    end.time = Sys.time()
    print(end.time - start.time)
    return(glmresult)
}


```

# Load In GLM Prep Data

```{r}
#CuSO4 CSS1
HNGLVDRXY_prep <- readRDS("StandardGLM/HNGLVDRXY_CSS1_glm_prep.rds") %>% 
  mutate(Bulk = gsub("Unselected", "aD", Bulk)) %>% mutate_if(is.character,as.factor)

HKTFTDRX2_prep <- readRDS("StandardGLM/HKTFTDRX2_CSS1_glm_prep.rds")%>% mutate_if(is.character,as.factor)

#CuSO4 CSS8
HVYTYDRX2_prep <- readRDS("StandardGLM/HVYTYDRX2_CuSO4_CSS8_glm_prep.rds")%>% mutate_if(is.character,as.factor) %>% select(-Dose)

HTG3TDMXY_prep <- readRDS("StandardGLM/HTG3TDMXY_CSS8_glm_prep.rds") %>% 
  mutate(DoseCol = Bulk) %>%
  select(-Bulk) %>% 
  select(DoseCol = DoseCol, Bulk = B, Allele = Allele, POS = POS, Parent = Parent, SmoothCount = SmoothCount, CHROM = CHROM, Rep = Rep, Pool = Pool) %>% na.omit() %>% 
  filter(CHROM != "VIII", CHROM != "M") %>% mutate_if(is.character,as.factor)

```

### Define contrasts for each

```{r}
contrasts(HNGLVDRXY_prep$Allele) <- matrix(c(1/2, -1/2), ncol = 1)
contrasts(HNGLVDRXY_prep$Bulk) <- matrix(c(1/2, -1/2), ncol = 1)
contrasts(HNGLVDRXY_prep$Parent) <- matrix(c(1/2, -1/2), ncol = 1)

contrasts(HKTFTDRX2_prep$Allele) <- matrix(c(1/2, -1/2), ncol = 1)
contrasts(HKTFTDRX2_prep$Bulk) <- matrix(c(1/2, -1/2), ncol = 1)
contrasts(HKTFTDRX2_prep$Parent) <- matrix(c(1/2, -1/2), ncol = 1)

contrasts(HVYTYDRX2_prep$Allele) <- matrix(c(1/2, -1/2), ncol = 1)
contrasts(HVYTYDRX2_prep$Bulk) <- matrix(c(1/2, -1/2), ncol = 1)
contrasts(HVYTYDRX2_prep$Parent) <- matrix(c(1/2, -1/2), ncol = 1)

contrasts(HTG3TDMXY_prep$Allele) <- matrix(c(1/2, -1/2), ncol = 1)
contrasts(HTG3TDMXY_prep$Bulk) <- matrix(c(1/2, -1/2), ncol = 1)
contrasts(HTG3TDMXY_prep$Parent) <- matrix(c(1/2, -1/2), ncol = 1)

```


# Run Permutations

### HNGLVDRXY_CSS1 (CuSO4 CSS I A)
```{r}

HNGLVDRXY_parentonly <- cybrPermute_cb2_all(HNGLVDRXY_prep)


HNGLVDRXY_parentonly %>% group_by(Factor) %>%
  summarize(quant095 = quantile(abs(Summary), 0.95, na.rm = TRUE),
             quant099 = quantile(abs(Summary), 0.99, na.rm = TRUE),
             quant0995 = quantile(abs(Summary), 0.995, na.rm = TRUE)) -> HNGLVDRXY_allpQs

saveRDS(HNGLVDRXY_allpQs, file = "StandardGLM/Ec_HNGLVDRXY_allpQs.rds")

```


### CuSO4 2024, no replicates

```{r, message=FALSE, warning=FALSE, paged.print=FALSE}

HTG3TDMXY_CSS8_parentonly <- cybrPermute_cb2_all(HTG3TDMXY_prep)

HTG3TDMXY_CSS8_parentonly %>% group_by(Factor) %>%
 summarize(quant095 = quantile(abs(Summary), 0.95, na.rm = TRUE),
            quant099 = quantile(abs(Summary), 0.99, na.rm = TRUE),
            quant0995 = quantile(abs(Summary), 0.995, na.rm = TRUE)) -> HTG3TDMXY_allpQs

saveRDS(HTG3TDMXY_allpQs, file = "StandardGLM/Ec_HTG3TDMXY_allpQs.rds")
```

### HKTFTDRX2 (CuSO4)

Redoing this 1/8/24

```{r}
unique(HKTFTDRX2_prep$Allele)

HKTFTDRX2_parentonly <- cybrPermute_cb2_all(HKTFTDRX2_prep, perp = 2)


HKTFTDRX2_parentonly %>% group_by(Factor) %>%
  summarize(quant095 = quantile(abs(Summary), 0.95, na.rm = TRUE),
             quant099 = quantile(abs(Summary), 0.99, na.rm = TRUE),
             quant0995 = quantile(abs(Summary), 0.995, na.rm = TRUE)) -> HKTFTDRX2_allpQs

saveRDS(HKTFTDRX2_allpQs, file = "StandardGLM/Ec_HKTFTDRX2_allpQs.rds")

```

### CSS8
REDO THIS FOR CSS8: 1/9/24 - running

```{r}

HVYTYDRX2_cu_prep_parentonly <- cybrPermute_cb2_all(HVYTYDRX2_prep, perp = 2)

HVYTYDRX2_cu_prep_parentonly %>% na.omit()

HVYTYDRX2_cu_prep_parentonly %>% group_by(Factor) %>%
  summarize(quant095 = quantile(abs(Summary), 0.95, na.rm = TRUE),
             quant099 = quantile(abs(Summary), 0.99, na.rm = TRUE),
             quant0995 = quantile(abs(Summary), 0.995, na.rm = TRUE)) -> HVYTYDRX2_allpQs

saveRDS(HVYTYDRX2_allpQs, file = "StandardGLM/Ec_HVYTYDRX2_allpQs.rds")

# HVYTYDRX2_prep[,c("CHROM", "Allele", "Bulk", "Parent", "SmoothCount")]
# HTG3TDMXY_prep[,c("CHROM", "Allele", "Bulk", "Parent", "SmoothCount")]
# str(HVYTYDRX2_prep)
# str(HTG3TDMXY_prep)
```

```{r}

HTG3TDMXY_parentonly_rep <- cybrPermute_cb2_all(HTG3TDMXY_prep, perp = 2, R = 2,
                                                glmform = "Allele ~ Bulk*Parent + Rep",
                                                inputlabels = c("cept", "Bulk", "Parent", "Rep", "Interaction"))

HTG3TDMXY_parentonly_rep %>% group_by(Factor) %>%
  summarize(quant095 = quantile(abs(Summary), 0.95, na.rm = TRUE),
             quant099 = quantile(abs(Summary), 0.99, na.rm = TRUE),
             quant0995 = quantile(abs(Summary), 0.995, na.rm = TRUE)) -> HTG3TDMXY_allpQs_rep

saveRDS(HTG3TDMXY_allpQs_rep, file = "StandardGLM/Ec_HTG3TDMXY_allpQs_rep.rds")


```

# Run the GLMs on these same samples with the contrasts at -0.5 and 0.5

### HNV

```{r}
inputlabels <- c("cept", "Bulk", "Parent", "Interaction")
HVYTYDRX2_prep %>% na.omit() %>% 
      group_by(Pool, CHROM, POS) %>%
      mutate_if(is.character, as.factor) %>%
        summarize(Summary = glm_cb2_all(
                                    Allele = Allele, Bulk = Bulk, Parent = Parent,#Rep = Rep,
                                    W = SmoothCount,
                                    formula = "Allele ~ Bulk * Parent",
                                    outputlength = length(inputlabels)*2),
                Factor = rep(inputlabels, 2),
                d = c(rep("Effect", length(inputlabels)),
                      rep("Z", length(inputlabels)))) -> HVYTYDRX2_glm_Ec

saveRDS(HVYTYDRX2_glm_Ec, file = "HVYTYDRX2_glm_Ec.rds")
```
### HNG
```{r}
inputlabels <- c("cept", "Bulk", "Parent", "Interaction")
HNGLVDRXY_prep %>% na.omit() %>% 
      group_by(Pool, CHROM, POS) %>%
      mutate_if(is.character, as.factor) %>%
        summarize(Summary = glm_cb2_all(
                                    Allele = Allele, Bulk = Bulk, Parent = Parent, #Rep = Rep,
                                    W = SmoothCount,
                                    formula = "Allele ~ Bulk * Parent",
                                    outputlength = length(inputlabels)*2),
                Factor = rep(inputlabels, 2),
                d = c(rep("Effect", length(inputlabels)),
                      rep("Z", length(inputlabels)))) -> HNGLVDRXY_glm_Ec

saveRDS(HNGLVDRXY_glm_Ec, file = "HNGLVDRXY_glm_Ec.rds")

```

### HKT

```{r}
inputlabels <- c("cept", "Bulk", "Parent", "Interaction")
HKTFTDRX2_prep %>% na.omit() %>% 
      group_by(Pool, CHROM, POS) %>%
      mutate_if(is.character, as.factor) %>%
        summarize(Summary = glm_cb2_all(
                                    Allele = Allele, Bulk = Bulk, Parent = Parent,#Rep = Rep,
                                    W = SmoothCount,
                                    formula = "Allele ~ Bulk * Parent",
                                    outputlength = length(inputlabels)*2),
                Factor = rep(inputlabels, 2),
                d = c(rep("Effect", length(inputlabels)),
                      rep("Z", length(inputlabels)))) -> HKTFTDRX2_glm_Ec

saveRDS(HKTFTDRX2_glm_Ec, file = "HKTFTDRX2_glm_Ec.rds")
```

### HTG
```{r}
inputlabels <- c("cept", "Bulk", "Parent", "Interaction")
HTG3TDMXY_prep %>% na.omit() %>% 
      group_by(Pool, CHROM, POS) %>%
      mutate_if(is.character, as.factor) %>%
        summarize(Summary = glm_cb2_all(
                                    Allele = Allele, Bulk = Bulk, Parent = Parent,#Rep = Rep,
                                    W = SmoothCount,
                                    formula = "Allele ~ Bulk * Parent",
                                    outputlength = length(inputlabels)*2),
                Factor = rep(inputlabels, 2),
                d = c(rep("Effect", length(inputlabels)),
                      rep("Z", length(inputlabels)))) -> HTG3TDMXY_glm_Ec

saveRDS(HTG3TDMXY_glm_Ec, file = "HTG3TDMXY_glm_Ec.rds")
```

Replicates

```{r}
inputlabels <- c("cept", "Bulk", "Parent", "Interaction", "Rep1", "Rep2")

HTG3TDMXY_prep %>% na.omit() %>%
      group_by(Pool, CHROM, POS) %>%
      mutate_if(is.character, as.factor) %>%
        summarize(Summary = glm_cb2_all(Allele = Allele,
                                 Bulk = Bulk, 
                                 Parent = Parent,
                                 Rep = Rep,
                                 W = SmoothCount,
                                 formula = "Allele ~ Bulk * Parent + Rep",
                                outputlength = length(inputlabels)*2),
                Factor = rep(inputlabels, 2),
                d = c(rep("Effect", length(inputlabels)),
                      rep("Z", length(inputlabels)))) -> HTG3TDMXY_glm_Ec_rep

saveRDS(HTG3TDMXY_glm_Ec_rep, file = "HTG3TDMXY_glm_Ec_rep.rds")
```

# Plotting to Compare

Effects vs Z-scores for rep vs no rep
```{r, fig.width = 12, fig.height = 5}

HTG3TDMXY_glm_Ec_rep %>% merge(HTG3TDMXY_allpQs_rep) %>% 
  mutate(intpeaks = POS*(abs(Summary) > quant095)*(Factor == "Interaction")) %>%
  mutate(bulkpeaks = POS*(abs(Summary) > quant095)*(Factor == "Bulk")) %>%
  filter(d == "Z") %>%

  ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + 
  #geom_vline(aes(xintercept = bulkpeaks), color = "lightpink", alpha = 0.2) +
  geom_vline(aes(xintercept = intpeaks), color = "lightblue", alpha = 0.8) +
  geom_hline(aes(yintercept = quant095, color = Factor)) +
  geom_line() + facet_grid(d~CHROM, space = "free", scales = "free") + ggtitle("Z-score w Replicates")

################################################################################
HTG3TDMXY_glm_Ec %>% merge(HTG3TDMXY_allpQs) %>% 
  mutate(intpeaks = POS*(abs(Summary) > quant095)*(Factor == "Interaction")) %>%
  mutate(bulkpeaks = POS*(abs(Summary) > quant095)*(Factor == "Bulk")) %>%
  filter(d == "Z") %>%
  
  ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + 
  #geom_vline(aes(xintercept = bulkpeaks), color = "lightpink", alpha = 0.2) +
  geom_vline(aes(xintercept = intpeaks), color = "lightblue", alpha = 0.8) +
  geom_hline(aes(yintercept = quant095, color = Factor)) +
  geom_line() + facet_grid(d~CHROM, space = "free", scales = "free") + ggtitle("Z-score No replicates")

```

### Effects

```{r, fig.width = 12, fig.height = 5}
HNGLVDRXY_glm_Ec %>% merge(HNGLVDRXY_allpQs) %>% 
  mutate(intpeaks = POS*(abs(Summary) > quant095)*(Factor == "Interaction")) %>%
  mutate(bulkpeaks = POS*(abs(Summary) > quant095)*(Factor == "Bulk")) %>%
  filter(d == "Effect") %>%

  ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + 
  geom_vline(aes(xintercept = bulkpeaks), color = "lightpink", alpha = 0.2) +
  geom_vline(aes(xintercept = intpeaks), color = "lightblue", alpha = 0.8) +
  geom_hline(aes(yintercept = quant095, color = Factor)) +
  
  geom_line() + facet_grid(Factor~CHROM, space = "free", scales = "free") + ggtitle("HNGLVDRXY Effect")

################################################################################
HKTFTDRX2_glm_Ec %>% merge(HKTFTDRX2_allpQs) %>% 
  mutate(intpeaks = POS*(abs(Summary) > quant095)*(Factor == "Interaction")) %>%
  mutate(bulkpeaks = POS*(abs(Summary) > quant095)*(Factor == "Bulk")) %>%
  filter(d == "Effect") %>%
  
  ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + 
  geom_vline(aes(xintercept = bulkpeaks), color = "lightpink", alpha = 0.2) +
  geom_vline(aes(xintercept = intpeaks), color = "lightblue", alpha = 0.8) +
  geom_hline(aes(yintercept = quant095, color = Factor)) +
  geom_line() + facet_grid(Factor~CHROM, space = "free", scales = "free") + ggtitle("HKTFTDRX2 Effect ")

################################################################################
HVYTYDRX2_glm_Ec %>% merge(HVYTYDRX2_allpQs) %>% 
  mutate(intpeaks = POS*(abs(Summary) > quant095)*(Factor == "Interaction")) %>%
  mutate(bulkpeaks = POS*(abs(Summary) > quant095)*(Factor == "Bulk")) %>%
  filter(d == "Effect") %>%
  
  ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + 
  geom_vline(aes(xintercept = bulkpeaks), color = "lightpink", alpha = 0.2) +
  geom_vline(aes(xintercept = intpeaks), color = "lightblue", alpha = 0.8) +
  geom_hline(aes(yintercept = quant095, color = Factor)) +
  geom_line() + facet_grid(Factor~CHROM, space = "free", scales = "free") + ggtitle("HVYTYDRX2 Effect")

```

### Z-scores

```{r, fig.width = 12, fig.height = 5}
HNGLVDRXY_glm_Ec %>% merge(HNGLVDRXY_allpQs) %>% 
  mutate(intpeaks = POS*(abs(Summary) > quant095)*(Factor == "Interaction")) %>%
  mutate(bulkpeaks = POS*(abs(Summary) > quant095)*(Factor == "Bulk")) %>%
  filter(d == "Z") %>%

  ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + 
  geom_vline(aes(xintercept = bulkpeaks), color = "lightpink", alpha = 0.2) +
  geom_vline(aes(xintercept = intpeaks), color = "lightblue", alpha = 0.8) +
  geom_hline(aes(yintercept = quant095, color = Factor)) +
  
  geom_line() + facet_grid(Factor~CHROM, space = "free", scales = "free") + ggtitle("HNGLVDRXY Z")

HKTFTDRX2_glm_Ec %>% merge(HKTFTDRX2_allpQs) %>% 
  mutate(intpeaks = POS*(abs(Summary) > quant095)*(Factor == "Interaction")) %>%
  mutate(bulkpeaks = POS*(abs(Summary) > quant095)*(Factor == "Bulk")) %>%
  filter(d == "Z") %>%
  
  ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + 
  geom_vline(aes(xintercept = bulkpeaks), color = "lightpink", alpha = 0.2) +
  geom_vline(aes(xintercept = intpeaks), color = "lightblue", alpha = 0.8) +
  geom_hline(aes(yintercept = quant095, color = Factor)) +
  geom_line() + facet_grid(Factor~CHROM, space = "free", scales = "free") + ggtitle("HKTFTDRX2 Z ")

HVYTYDRX2_glm_Ec %>% merge(HVYTYDRX2_allpQs) %>% 
  mutate(intpeaks = POS*(abs(Summary) > quant095)*(Factor == "Interaction")) %>%
  mutate(bulkpeaks = POS*(abs(Summary) > quant095)*(Factor == "Bulk")) %>%
  filter(d == "Z") %>%
  
  ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + 
  geom_vline(aes(xintercept = bulkpeaks), color = "lightpink", alpha = 0.2) +
  geom_vline(aes(xintercept = intpeaks), color = "lightblue", alpha = 0.8) +
  geom_hline(aes(yintercept = quant095, color = Factor)) +
  geom_line() + facet_grid(Factor~CHROM, space = "free", scales = "free") + ggtitle("HVYTYDRX2 Z")

```

All at once?

```{r, fig.width = 12, fig.height = 5}
rbind(HTG3TDMXY_glm_Ec[HTG3TDMXY_glm_Ec$CHROM != "VIII",], 
      #HTG3TDMXY_glm_Ec_rep[HTG3TDMXY_glm_Ec_rep$CHROM != "VIII",],
      HNGLVDRXY_glm_Ec[HNGLVDRXY_glm_Ec$CHROM != "I",],
      HKTFTDRX2_glm_Ec[HKTFTDRX2_glm_Ec$CHROM != "I",],
      HVYTYDRX2_glm_Ec[HVYTYDRX2_glm_Ec$CHROM != "VIII",]) -> CuSO4_contrastglm

CuSO4_contrastglm %>% filter(d == "Effect", Factor != "cept") %>%
  ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + geom_line() + facet_grid(Pool ~ CHROM, space = "free", scales = "free") +
  ggtitle("Effects, 0.5/-0.5")

CuSO4_contrastglm %>% filter(d == "Z", Factor != "cept") %>%
  ggplot(aes(x = POS, y = abs(Summary), color = Factor)) + geom_line() + facet_grid(Pool ~ CHROM, space = "free", scales = "free") +
  ggtitle("Z scores, 0.5/-0.5")

```

