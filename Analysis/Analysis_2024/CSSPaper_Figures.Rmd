---
title: "MergedVCFs_CuSO4_May24"
author: "Cassandra Buzby"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Load packages
require(ggplot2)
require(tidyr)
require(dplyr)
require(reshape2)
require(cowplot)
require(data.table)

require(doParallel)
require(RColorBrewer)
require(scales)
require(circlize) 
require(stringr)
require(ggrepel)

require(cybrBSA)
require(lme4)

ggplot2::theme_set(theme_minimal() + theme(text = element_text(size = 10)) +
                     theme(#axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()))

ChromosomeScale <- data.frame(CHROM = factor(as.character(as.roman(1:16)),
                                             levels = as.character(as.roman(1:16))),
                              start = rep(1, 16),
                              end = c(.23,.81,.32, 1.53, .58, .27, 1.09, .56, .44, .75, .67, 1.08, .92, .78, 1.09, .95)*1000000) %>% 
  pivot_longer(c(start, end), names_to = "delete", values_to = "POS") %>%
  mutate(Summary = NA, Label = NA) %>% select(-delete)

ChromosomeScale$Start <- 30000
ChromosomeScale$End <- ChromosomeScale$POS - 30000

ChromosomeScale2 <- data.frame(CHROM = factor(as.character(as.roman(1:16)),
                                             levels = as.character(as.roman(1:16))),
                              start = rep(1, 16),
                              end = c(.23,.81,.32, 1.53, .58, .27, 1.09, .56, .44, .75, .67, 1.08, .92, .78, 1.09, .95)*1000000) %>% 
  pivot_longer(c(start, end), names_to = "delete", values_to = "POS") %>%
  mutate(summary = 0, label = "Bulk") %>% select(-delete)

# Loci to look at specifically

myloci <- data.frame(CHROM = c("V","V","IX", "III", "IV", "I", "III"),
                     POS = c(375215, 116167,389572, 198671, 46271, 203403, 260311),
                     name = c("FLO8", "URA3", "FLO11", "MAT", "HO", "FLO1", "TUP1"),
                     cat = c("Floc", "X", "Floc", "X", "X", "Floc", "Floc"))

## RANDOM NEW FUNCTIONS

subtract <- function(POS){
  return(max(POS) - min(POS))
}

findchange <- function(x){
  t <- length(x)
  diff <- x[t] - x[1]
  if(is.na(diff)){
    return(NA)
  }else if(diff == 0){
    return(0)
  }else{
    return(diff > 0)  
  }
}

findpeak <- function(x){
  t <- length(x)
  diff <- x[t] - x[1]
  return(diff)
}

  
cybr_weightedgauss <- function(myx){
  myy <- dnorm(1:length(myx), mean = length(myx)/2, sd = 10)
  return(weighted.mean(x = myx, y = myy, na.rm = TRUE))
} 


## Functions for GLM all and Permutation all

glm_cb2_all <- function(..., W, formula, numgroups = FALSE, outputlength = 8) {
  data <- list(...)
  
  #Ensure that there is a formula and W parameter
  if (is.null(W) || is.null(formula)) {
    stop("Weights (W) and formula must be provided")
  }
  #Set formula
  glm_formula <- as.formula(formula)
  #Ensure that formula works for the data provided
  if (!all(names(data) %in% all.vars(glm_formula))) {
    stop("One or more variables in the formula are not provided as arguments")
  }
  
  #########################
  for(i in all.vars(glm_formula)){
    if(length(unique(as.data.frame(data)[,i])) < 2){
      output <- rep(NA, outputlength)
      #print("Not enough levels within groups")
      
      return(output)
    }
  }
  
  glm_fit <- glm(glm_formula, data = as.data.frame(data), weights = W, family = binomial)
  
  output <- summary(glm_fit)$coefficients[c(((length(summary(glm_fit)$coefficients)*0)+1):
                                            ((length(summary(glm_fit)$coefficients)*0.25)),
                                            ((length(summary(glm_fit)$coefficients)*0.5)+1):
                                            ((length(summary(glm_fit)$coefficients)*0.75)))]

  
  if(length(output) == outputlength){
    return(output)
  }else{
    return(rep(NA, outputlength))
  }
  
} 


################################################################################
# No replicates, fix Parent
cybrPermute_cb2_all <- function(dataset, 
                                R = 0, perp = 1, outlength = 4, 
                                glmform = "Allele ~ Bulk * Parent", 
                                inputlabels = c("Intercept", "Bulk", "Parent", "Interaction")){
  start.time <- Sys.time()
    
  print("Make sure that dilute bulk is labeled aD")
  print(paste("Your labels are:", inputlabels))

    if(R > 0){ #INCLUDE REPLICATES
        dataset %>% 
        distinct() %>% ungroup() %>%
        group_by(CHROM, POS, Allele, Bulk, Rep, Parent) %>% 
        summarize(culprits = length((SmoothCount))) %>% 
        merge(dataset) %>% 
        filter(culprits == 1) %>% 
        ungroup() %>%
        distinct() %>% #THIS IS IMPORTANT
        pivot_wider(names_from = Allele, values_from = SmoothCount) -> newnewtest    
    }else{ #DO NOT INCLUDE REPLICATES
        dataset %>% 
        distinct() %>% ungroup() %>%
        group_by(CHROM, POS, Allele, Bulk, Parent) %>% 
        summarize(culprits = length((SmoothCount))) %>% 
        merge(dataset) %>% 
        filter(culprits == perp) %>% 
        ungroup() %>%
        distinct() %>% #THIS IS IMPORTANT
        pivot_wider(names_from = Allele, values_from = SmoothCount) -> newnewtest
    }
  
    #PERMUTE TWICE
  if(R > 0){
    newnewtest %>% filter(Bulk == "aD",
                          CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
      select(CHROM, POS, Rep, 
             Parent, Oak, Wine) %>% 
      group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
      summarize(Parent = Parent, Rep = Rep, 
                Oak = Oak, Wine = Wine, Loc = sample(Loc)) %>%
      mutate(Bulk = "A") -> shuffled_DiluteA2
    
    newnewtest %>% filter(Bulk == "aD",
                          CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
      select(CHROM, POS, 
             Rep, Parent, Oak, Wine) %>% 
      group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
      summarize(Parent = Parent, Rep = Rep,
                Oak = Oak, Wine = Wine, Loc = sample(Loc)) %>%
      mutate(Bulk = "B") -> shuffled_DiluteB2
    
  }else{
    newnewtest %>% filter(Bulk == "aD",
                          CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
      select(CHROM, POS, Parent, Oak, Wine) %>% 
      group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
      summarize(Parent = Parent, Oak = Oak, Wine = Wine, Loc = sample(Loc)) %>%
      mutate(Bulk = "A") -> shuffled_DiluteA2
    
    newnewtest %>% filter(Bulk == "aD",
                          CHROM %in% c("I", "III", "V", "VIII", "M") == FALSE) %>% 
      select(CHROM, POS, Parent, Oak, Wine) %>% 
      group_by(Parent) %>% mutate(Loc = paste(CHROM, POS)) %>%
      summarize(Parent = Parent, Oak = Oak, Wine = Wine, Loc = sample(Loc)) %>%
      mutate(Bulk = "B") -> shuffled_DiluteB2
    
  }
    
    rbind(shuffled_DiluteA2, shuffled_DiluteB2) %>% pivot_longer(c(Oak, Wine), names_to = "Allele", values_to = "SmoothCount") -> shuffletoglm2
    
    #RUN THE GLM
    if(R > 0) {
      shuffletoglm2 %>% na.omit() %>%
      group_by(Loc) %>%
      mutate_if(is.character, as.factor) %>%
        summarize(Summary = glm_cb2_all(Allele = Allele,
                                 Bulk = Bulk,
                                 Parent = Parent,
                                 Rep = Rep,
                                 W = SmoothCount,
                                 formula = glmform,
                                outputlength = length(inputlabels)*2),
                Factor = rep(inputlabels, 2),
                d = c(rep("Effect", length(inputlabels)),
                      rep("Z", length(inputlabels)))) -> glmresult
    }else{
      shuffletoglm2 %>% na.omit() %>%
      #Original Script
      group_by(Loc) %>%
      mutate_if(is.character, as.factor) %>%
        summarize(Summary = glm_cb2_all(Allele = Allele,
                                 Bulk = Bulk,
                                 Parent = Parent,
                                 W = SmoothCount,
                                 formula = glmform,
                                outputlength = length(inputlabels)*2),
                Factor = rep(inputlabels, 2),
                d = c(rep("Effect", length(inputlabels)),
                      rep("Z", length(inputlabels)))) -> glmresult
    }
    
    
    end.time = Sys.time()
    print(end.time - start.time)
    return(glmresult)
}

cybrInputGATKTable2 <- function(rawData, yeast = TRUE){

  require(dplyr)
  require(doParallel)
  require(foreach)

  HNGLCDRXY <- read.table(rawData, header = TRUE)

  #Identify the unique values besides AD/DP/GQ/PL
  gsub(".AD", "",
       gsub(".GQ", "",
            gsub(".DP","",
                 gsub(".PL","",
                      colnames(select(HNGLCDRXY, -CHROM, -POS, -REF, -ALT)))))) %>% unique() -> Samples
  #i <- Samples[1]

  resultscdf <- foreach(i=Samples,.combine=rbind) %dopar% {
    mydf <- HNGLCDRXY %>% select(CHROM, POS, REF, ALT) %>% mutate(Dataset = i)
    AD <- select(HNGLCDRXY,matches(c(i), ignore.case = FALSE)) %>% select(., contains("AD"))
    GQ <- select(HNGLCDRXY,matches(c(i), ignore.case = FALSE)) %>% select(., contains("GQ"))
    DP <- select(HNGLCDRXY,matches(c(i), ignore.case = FALSE)) %>% select(., contains("DP"))
    PL <- select(HNGLCDRXY,matches(c(i), ignore.case = FALSE)) %>% select(., contains("PL"))
    cbind(mydf, AD , GQ , DP, PL) -> mydftotal
    colnames(mydftotal) <- c(colnames(mydf), "AD", "GQ", "DP", "PL")

    mydftotal %>% separate(AD, c('AD.REF','AD.ALT'), extra='drop') %>%
      separate(PL, c('PL.REF','PL.ALT'), extra='drop') %>%
      #Added 10/18/23:
      select(CHROM, POS,REF,ALT,Dataset,AD.REF,AD.ALT,GQ,DP,PL.REF,PL.ALT) -> mycdf

    mycdf %>% filter(grepl(",", ALT)) %>% 
      separate(ALT, c("A1", "A2"), extra = 'merge') %>%
      separate(AD.ALT, c("AD1", "AD2"), extra = 'merge') %>%
      separate(PL.ALT, c("P1", "P2"), extra = 'merge') %>%
      
      pivot_longer(c(A1, A2), names_to = "NumAlt", values_to = "ALT") %>%
      pivot_longer(c(AD1, AD2), names_to = "NumADAlt", values_to = "AD.ALT") %>%
      pivot_longer(c(P1, P2), names_to = "NumPL", values_to = "PL.ALT") %>%
      mutate(NumAlt = gsub("A", "", NumAlt),
             NumADAlt = gsub("AD", "", NumADAlt),
             NumPL = gsub("P", "", NumPL)) %>%
      filter(NumAlt == NumPL,
             NumPL == NumADAlt) %>%
      select(CHROM, POS,REF,ALT,Dataset,AD.REF,AD.ALT,GQ,DP,PL.REF,PL.ALT) -> doublecdf
    
    doublecdf %>% filter(grepl(",", ALT)) %>%
      separate(ALT, c("A1", "A2"), extra = 'merge') %>%
      separate(AD.ALT, c("AD1", "AD2"), extra = 'merge') %>%
      separate(PL.ALT, c("P1", "P2"), extra = 'merge') %>%
      
      pivot_longer(c(A1, A2), names_to = "NumAlt", values_to = "ALT") %>%
      pivot_longer(c(AD1, AD2), names_to = "NumADAlt", values_to = "AD.ALT") %>%
      pivot_longer(c(P1, P2), names_to = "NumPL", values_to = "PL.ALT") %>%
      mutate(NumAlt = gsub("A", "", NumAlt),
             NumADAlt = gsub("AD", "", NumADAlt),
             NumPL = gsub("P", "", NumPL)) %>%
      filter(NumAlt == NumPL,
             NumPL == NumADAlt) %>%
      select(CHROM, POS,REF,ALT,Dataset,AD.REF,AD.ALT,GQ,DP,PL.REF,PL.ALT) -> triplecdf
    
    rbind(mycdf, doublecdf, triplecdf) -> newcdf
    
    newcdf
  }

  if(yeast == TRUE){
    ChromKey <- data.frame(chromosomes = c("I", "II", "III", "IV", "V", "VI", "VII", "VIII",
                                         "IX", "X", "XI", "XII", "XIII", "XIV", "XV", "XVI", "M"),
                         CHROM = c("NC_001133.9", "NC_001134.8", "NC_001135.5", "NC_001136.10",
                                   "NC_001137.3", "NC_001138.5", "NC_001139.9", "NC_001140.6",
                                   "NC_001141.2", "NC_001142.9", "NC_001143.9", "NC_001144.5",
                                   "NC_001145.3", "NC_001146.8", "NC_001147.6", "NC_001148.4", "NC_001224.1"))

    resultscdf %>% left_join(.,ChromKey) %>% select(-CHROM) %>% mutate(CHROM = chromosomes) %>% select(-chromosomes) -> results
  }else{
    results <- resultscdf
  }
  return(results)

}

#CIRCLIZE
cybr_circos <- function(d1, d8, peaklist1 = NULL, peaklist8 = NULL, maxy = NULL, color1 = "#24588A", color8 = "#ED7B01", opacity = "50"){
  
  color1fade_50 <- paste(color1, "50", sep = "")
  color8fade_50 <- paste(color8, "50", sep = "")
  
  color1fade <- paste(color1, opacity, sep = "")
  color8fade <- paste(color8, opacity, sep = "")

  if(is.null(d8)){
    d8 <- d1
    include8 <- FALSE
  }else{
    include8 <- TRUE
  }
    #SET UP DATA
  df8 <- data.frame(sectors = as.character(d8$CHROM),
                 x = d8$POS,
                 y = abs(d8$summary),
                  label = d8$label)

  df1 <- data.frame(sectors = as.character(d1$CHROM),
                 x = d1$POS,
                 y = abs(d1$summary),
                  label = d1$label)

  #Take just the interactions of each
  df8int <- df8 %>% filter(label == "Interaction")
  df1int <- df1 %>% filter(label == "Interaction")

    #REORDER THE CHROMOSOMES
  df8int$sectors <- factor(df8int$sectors, levels = as.character(as.roman(1:16)))
  df1int$sectors <- factor(df1int$sectors, levels = as.character(as.roman(1:16)))
  
  ##############################################################################
  dfall <- rbind(df1int, df8int) %>% na.omit()
  circos.par("track.height" = 0.3, start.degree = 90, cell.padding = c(0,0))
  circos.initialize(sectors = dfall$sectors, x = dfall$x)

  if(is.null(maxy)){
    #I think this makes the sizes?
    circos.track(ylim = c(max(c(dfall$y)), 0), dfall$sectors, y = dfall$y, 
        panel.fun = function(x, y) {
            circos.text(CELL_META$xcenter, 
                0 - mm_y(5), 
                CELL_META$sector.index,
                niceFacing = FALSE)
            circos.axis(labels.cex = 0.1)
    })
  }else{
    circos.track(ylim = c(maxy, 0), dfall$sectors, y = dfall$y, 
      panel.fun = function(x, y) {
          circos.text(CELL_META$xcenter, 
              0 - mm_y(5), 
              CELL_META$sector.index,
              niceFacing = FALSE)
          circos.axis(labels.cex = 0.1)
      })
  }
  #Makes the chromosome overlap parts
  #CHROMOSOME I
  draw.sector(83.5, #RIGHT
              90, #LEFT
              rou1 = 0.99, rou2 = 0.69, clock.wise = FALSE, col = color1fade_50, border = FALSE)
  if(include8 == TRUE){
    #CHROMOSOME VIII
    draw.sector(289.5, #LEFT
              305.4, #RIGHT
              rou1 = 0.99, rou2 = 0.69, clock.wise = FALSE, col = color8fade_50, border = FALSE)
  }
  
  
  #Makes the lines
  circos.trackPoints(df8int$sectors, df8int$x, abs(df8int$y), col = color8, pch = 16, cex = 0.1)
  circos.trackPoints(df1int$sectors, df1int$x, abs(df1int$y), col = color1, pch = 16, cex = 0.1)
  
  if(is.null(peaklist8) == FALSE){
    if(length(peaklist8$POS) >= 1){
      for(i in 1:length(peaklist8$POS)){
      circos.link(peaklist8$CHROM[i], 
                  peaklist8$POS[i], 
                  #Add 8 after
                  "VIII", c(0, max(dfall$x[dfall$sectors == "VIII"])),  
                  
                  col = color8fade, 
                  h.ratio = 0.3, 
                  border = color8fade, 
                  lwd = 1)
      }
    }else{
      print("No interactions on Chr 8")
    }
    
  }

  if(is.null(peaklist1) == FALSE){
    if(length(peaklist1$POS) >= 1){
      for(i in 1:length(peaklist1$POS)){
        circos.link("I",c(0, max(dfall$x[dfall$sectors == "I"])),  
                    #add 1 first
                    peaklist1$CHROM[i], 
                    peaklist1$POS[i], 
                    col = color1fade, 
                    h.ratio = 0.3, 
                    border = color1fade, 
                    lwd = 1)
      }
    }else{
      print("No interactions on Chr 1")
    }
  }  
  
  circos.clear()
}

cybr_circos_comp <- function(d1, d8, peaklist1 = NULL, peaklist8 = NULL, maxy = NULL, color1 = "#24588A", color8 = "#ED7B01", colorC = "#Ffb6c1", opacity = "50", complist = NULL){
  
  color1fade_50 <- paste(color1, "50", sep = "")
  color8fade_50 <- paste(color8, "50", sep = "")
  colorCfade_50 <- paste(colorC, "50", sep = "")
  
  color1fade <- paste(color1, opacity, sep = "")
  color8fade <- paste(color8, opacity, sep = "")
  colorCfade <- paste(colorC, opacity, sep = "")

  if(is.null(d8)){
    d8 <- d1
    include8 <- FALSE
  }else{
    include8 <- TRUE
  }
    #SET UP DATA
  df8 <- data.frame(sectors = as.character(d8$CHROM),
                 x = d8$POS,
                 y = abs(d8$summary),
                  label = d8$label)

  df1 <- data.frame(sectors = as.character(d1$CHROM),
                 x = d1$POS,
                 y = abs(d1$summary),
                  label = d1$label)

  #Take just the interactions of each
  df8int <- df8 %>% filter(label == "Interaction")
  df1int <- df1 %>% filter(label == "Interaction")

    #REORDER THE CHROMOSOMES
  df8int$sectors <- factor(df8int$sectors, levels = as.character(as.roman(1:16)))
  df1int$sectors <- factor(df1int$sectors, levels = as.character(as.roman(1:16)))
  
  ##############################################################################
  dfall <- rbind(df1int, df8int) %>% na.omit()
  circos.par("track.height" = 0.3, start.degree = 90, cell.padding = c(0,0))
  circos.initialize(sectors = dfall$sectors, x = dfall$x)

  if(is.null(maxy)){
    #I think this makes the sizes?
    circos.track(ylim = c(max(c(dfall$y)), 0), dfall$sectors, y = dfall$y, 
        panel.fun = function(x, y) {
            circos.text(CELL_META$xcenter, 
                0 - mm_y(5), 
                CELL_META$sector.index,
                niceFacing = FALSE)
            circos.axis(labels.cex = 0.1)
    })
  }else{
    circos.track(ylim = c(maxy, 0), dfall$sectors, y = dfall$y, 
      panel.fun = function(x, y) {
          circos.text(CELL_META$xcenter, 
              0 - mm_y(5), 
              CELL_META$sector.index,
              niceFacing = FALSE)
          circos.axis(labels.cex = 0.1)
      })
  }
  #Makes the chromosome overlap parts
  #CHROMOSOME I
  draw.sector(83.5, #RIGHT
              90, #LEFT
              rou1 = 0.99, rou2 = 0.69, clock.wise = FALSE, col = color1fade_50, border = FALSE)
  if(include8 == TRUE){
    #CHROMOSOME VIII
    draw.sector(289.5, #LEFT
              305.4, #RIGHT
              rou1 = 0.99, rou2 = 0.69, clock.wise = FALSE, col = color8fade_50, border = FALSE)
  }
  
  
  #Makes the lines
  circos.trackPoints(df8int$sectors, df8int$x, abs(df8int$y), col = color8, pch = 16, cex = 0.1)
  circos.trackPoints(df1int$sectors, df1int$x, abs(df1int$y), col = color1, pch = 16, cex = 0.1)
  
  if(is.null(peaklist8) == FALSE){
    if(length(peaklist8$POS) >= 1){
      for(i in 1:length(peaklist8$POS)){
      circos.link(peaklist8$CHROM[i], 
                  peaklist8$POS[i], 
                  #Add 8 after
                  "VIII", c(0, max(dfall$x[dfall$sectors == "VIII"])),  
                  
                  col = color8fade, 
                  h.ratio = 0.3, 
                  border = color8fade, 
                  lwd = 1)
      }
    }else{
      print("No interactions on Chr 8")
    }
    
  }

  if(is.null(peaklist1) == FALSE){
    if(length(peaklist1$POS) >= 1){
      for(i in 1:length(peaklist1$POS)){
        circos.link("I",c(0, max(dfall$x[dfall$sectors == "I"])),  
                    #add 1 first
                    peaklist1$CHROM[i], 
                    peaklist1$POS[i], 
                    col = color1fade, 
                    h.ratio = 0.3, 
                    border = color1fade, 
                    lwd = 1)
      }
    }else{
      print("No interactions on Chr 1")
    }
  }  
  
  if(is.null(complist) == FALSE){
    if(length(complist$POS) >= 1){
      for(i in 1:length(complist$POS)){
        
        linkchrom = unique(complist$C)[1]
        circos.link(linkchrom,c(0, max(dfall$x[dfall$sectors == linkchrom])),  
                    complist$CHROM[i], 
                    complist$POS[i], 
                    col = colorCfade, 
                    h.ratio = 0.3, 
                    border = colorCfade, 
                    lwd = 1)
      }
    }else{
      print("No interactions on Chr 1")
    }
  }  
  
  
  circos.clear()
}

fmt_dcimals <- function(decimals=0){
   # return a function responpsible for formatting the 
   # axis labels with a given number of decimals 
   function(x) as.character(round(x,decimals))
}

```

# Load in data

```{r}
rawdata_unsmoothed <- readRDS("rawdataG.rds")
rd_factor <- readRDS("rd_factorG.rds")
```

```{r}
CuSO4_CSS1_glmer_1byRep <- readRDS("CuSO4_CSS1_glmer_1byRepG.rds")
CuSO4_CSS8_glmer_1byRep <- readRDS("CuSO4_CSS8_glmer_1byRepG.rds")
q5_all <- readRDS("q5_CuSO4_CSS.rds")


CuSO4_CSS1_glmer_1byRep %>% filter(CHROM != "I") %>% mutate(CSS = "I") -> temp1
CuSO4_CSS8_glmer_1byRep %>% mutate(CSS = "VIII") %>%
  rbind(temp1) -> AllCuSO4_glmer_1byRep

rm(temp1)

AllCuSO4_glmer_1byRep %>% ungroup() %>%
  group_by(CHROM, label, CSS) %>%
  arrange(POS) %>%
  summarize(POS = POS,
            zscore = zscore,
            sdz = frollapply(zscore, n = 3, FUN = sd, align = "center" )) -> checksd

checksd %>% filter(sdz < 0.25) -> AllCuSO4_glmer_1byRep

sgd_orfs <- read.csv("C:/Users/Cassandra/Documents/R_FileTransfer/SGD_ORFs.csv")

################################################################################
#TESTING
sgd_orfs %>% filter(Gene.symbol %in% c("COA2")) %>%
  mutate(CHROM = gsub("chr", "", Gene.chromosome.primaryIdentifier))
################################################################################

genes <- c("CRS5", "SOD1", "CUP1-1", "CUP1-2", "MET17", "MUP1", "PCL1", "OYE3", "FRE1", "FRE7", "CTR1", "IRC7")
sgd_orfs %>% filter(Gene.symbol %in% genes) %>%
  mutate(CHROM = gsub("chr", "", Gene.chromosome.primaryIdentifier)) -> sgd_copper

genes_eh <- c("VMA4", "MTL1", "PTR2", "LEU9", "IRC15")
sgd_orfs %>% filter(Gene.symbol %in% genes_eh) %>%
  mutate(CHROM = gsub("chr", "", Gene.chromosome.primaryIdentifier)) -> sgd_copper_eh

#HUBS
sgd_orfs %>% filter(Gene.symbol %in% c("PTR3", "VPS70", "CUP1", "YLR257W")) %>%
  mutate(CHROM = gsub("chr", "", Gene.chromosome.primaryIdentifier)) %>% mutate(Hub = "Matsui") -> sgd_hubs_Matsui

# sgd_orfs %>% filter(Gene.symbol %in% eQTL_hubs_Genes$GeneName) %>%
#   mutate(CHROM = gsub("chr", "", Gene.chromosome.primaryIdentifier)) %>% mutate(Hub = "Albert") %>% arrange(CHROM) -> sgd_hubs_Albert

#Sporulation Genes
sgd_orfs %>% filter(Gene.symbol %in% c("RME1", "MKT1", "TAO3")) %>%
  mutate(CHROM = gsub("chr", "", Gene.chromosome.primaryIdentifier)) %>% mutate(Hub = "Sporulation") -> sgd_sporulation
```
# Figures in Order

## Figure 1

There is no code for this because it's all done in Illustrator

## Figure 2

```{r}

sgd_copper %>% filter(Gene.symbol %in% c("CUP1-1", "FRE1")) -> Fig2Genes

AllCuSO4_glmer_1byRep %>% filter(CHROM %in% c("VIII", "XII")) %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore))) + 
  geom_vline(data = Fig2Genes, aes(xintercept = c(Gene.chromosomeLocation.start), color = Gene.symbol),
             size = 2, alpha = 0.5) +  
  geom_line(aes(linetype = CSS)) +
  # geom_line(data = Cu_MP[Cu_MP$CHROM == "VIII" | Cu_MP$CHROM == "XII",], aes(x = Bin.start..bp., y = LOD.score), color = "red") +

    geom_hline(data = q5_all[q5_all$label %in% c("Bulk"),], aes(yintercept = q5)) +
  facet_wrap("CHROM", scales = "free") +
  #facet_grid(~CHROM, scales = "free", space = "free") +
  labs(color = NULL, linetype = NULL, alpha = NULL) +
  theme(legend.position = "bottom") +ylab("")+
    scale_size_manual(values = c(0.1, 2)) +
  scale_color_manual(values = c("darkturquoise", "darkorange"))

```

## Figure 3

```{r, fig.width=8, fig.height=3}
AllCuSO4_glmer_1byRep %>%
  filter(label == "Bulk") %>%
  ungroup() %>%
  group_by(CHROM, CSS) %>%
  summarize(max_zscore = max(zscore),
            min_zscore = min(zscore)) %>%
  pivot_longer(c(max_zscore, min_zscore), values_to = "zscore") %>%
  group_by(CHROM, CSS) %>%
  summarize(zscore = zscore,
            maxactual = max(abs(zscore))) %>%
  filter(abs(zscore) == maxactual) %>%
  merge(AllCuSO4_glmer_1byRep) -> peaks_rainbow

peaks_rainbow %>% filter(abs(zscore) > 1.1) -> peaks_rainbow

peaks_rainbow$CHROM <- factor(peaks_rainbow$CHROM, levels = as.character(as.roman(1:16)))


AllCuSO4_glmer_1byRep %>%
  filter(label == "Bulk") %>%
  ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) + 
  geom_line() +
  geom_hline(data = q5_Bulk, aes(yintercept = Bulkq5, linetype = CSS), size = 0.5) +
  geom_vline(data = peaks_rainbow, aes(xintercept = POS, color = CHROM, linetype = CSS), alpha = 0.3, size = 1) + 
  facet_grid(~CHROM, space = "free", scales = "free") +
  #theme_classic() +
  theme(legend.position = "none",panel.grid = element_blank()) +
  scale_linetype_manual(values = c(2,1)) +
  scale_color_manual(values = c(1,"darkorange","skyblue3","darkorange","skyblue3","darkorange","skyblue3",1,
                                "skyblue3","darkorange","skyblue3","darkorange","skyblue3","darkorange","skyblue3","darkorange"))
```


## Figure 4

The big one

```{r}
AllCuSO4_glmer_1byRep %>% filter(label == "Interaction", CSS == "VIII",
                                 CHROM %in% c("VII", "X", "XI", "XII", "XIV", "XV")) %>%
  group_by(CHROM) %>%
  arrange(desc(abs(zscore))) %>%
  summarize(POS = head(POS, 1)) -> IntPeaks2

rd_factor %>% filter(POS %in% IntPeaks2$POS) %>%
  mutate(Background = gsub("Oak", 0, Background),
         Background = gsub("Wine", 1, Background)) %>%
  mutate(Bulk = gsub("Dilute", "Unselected", Bulk)) %>%
  ggplot(aes(x = as.numeric(Background), y = SmoothCount, color = Allele)) + 
  geom_point(shape = 1, size = 2, stroke = 1, alpha = 0.8) + 
  geom_smooth(method = "lm", alpha = 0.2) +
  scale_color_manual(values = c("palegreen3", "firebrick3")) +
    xlab("Parental Background") +
  ylab("Allele Count") +
    theme(legend.position = "bottom") +

    geom_hline(yintercept = Inf, color = "white", size = 4) +
    theme(strip.background.y = element_rect(fill = c("black", "darkturquoise" )),
        strip.text.y = element_text(color = "white", size = 10, face = "bold"))+
  facet_grid(Bulk ~ paste(CHROM, POS)) -> pa

AllCuSO4_glmer_1byRep %>% merge(IntPeaks2) %>%
  filter(label %in% c("Bulk", "Interaction"), CSS == "VIII") %>%
  mutate(Coefficient = label) %>%
  #filter(abs(zscore) > 1.1) %>%
  ggplot(aes(x = as.character(POS), y = abs(zscore), color = Coefficient)) + 
  geom_point(stroke = 1, size = 2, alpha = 0.8, shape = 2) + 
  facet_grid( ~ CHROM, scales = "free") +
  ylim(0,10) +
  xlab("") + ylab("abs Z-score") +
      theme(legend.position = "bottom") +

  scale_color_manual(values = c("black", "purple")) -> pb

#plot_grid(pa, pb, ncol = 1, rel_heights = c(2,1))

```
```{r}

AllCuSO4_glmer_1byRep %>%
  filter(CSS == "I") %>%
  merge(q5_all) %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = label)) +
  geom_line() +
  xlab("") +
  ylab("abs Z-score") +
  geom_hline(aes(yintercept = q5)) +
  #labs(linetype = NULL, color = NULL) +
  scale_color_manual(values = c("black", "purple")) +
  theme(strip.background.y = element_rect(fill = c("#6aa0c7", "#f8923a"),color = c("#6aa0c7", "#f8923a")),
        strip.text.y = element_text(color = "white", size = 10, face = "bold"))+
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) -> pCSS1

AllCuSO4_glmer_1byRep %>%
  filter(CSS == "VIII") %>%
  merge(q5_all) %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = label)) +
  geom_line() +
  geom_vline(data = IntPeaks,
             aes(xintercept = POS),
             color = "red", linetype = "dashed", size = 1, alpha = 0.4)+
  xlab("") +
  ylab("abs Z-score") +
  geom_hline(aes(yintercept = q5)) +
  #labs(linetype = NULL, color = NULL) +
  scale_color_manual(values = c("black", "purple")) +
  theme(strip.background.y = element_rect(fill = c( "#f8923a"),color = c("#f8923a")),
        strip.text.y = element_text(color = "white", size = 10, face = "bold"))+
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) -> pCSS8

```

```{r, fig.height=12, fig.width=8}
plot_grid(pCSS1, pCSS8, pa, pb, ncol = 1, rel_heights = c(1,1,2,1))

```

## Figure 5

Not sure if I'll even keep this one, so not necessarily putting it in here

## Figure 6

Also not sure if keeping this one

# All Code

What genes are nearby?

```{r, fig.width=16, fig.height=5}


AllCuSO4_glmer_1byRep %>% filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore))) + 
  geom_line(aes(linetype = CSS)) +
  geom_vline(data = sgd_sporulation, 
             aes(xintercept = Gene.chromosomeLocation.start),
             size = 1, alpha = 0.3, color = "black", linetype = "dashed") +
  geom_vline(data = sgd_hubs_Matsui, 
             aes(xintercept = Gene.chromosomeLocation.start),
             size = 1, alpha = 0.3, color = "red", linetype = "dashed") +
  # geom_vline(data = eQTL_hubs_Genes[eQTL_hubs_Genes$numberGenesInHotspot > 5,],
  #            aes(xintercept = as.numeric(POS), color = CHROM),
  #            size = 1, alpha = 0.3) +
  geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  theme(legend.position = "bottom") +
    scale_size_manual(values = c(0.1, 2)) +
  scale_alpha_manual(values = c(0.4, 0))
```

# Final Plotting

Ensure filters happen

```{r, fig.width = 16, fig.height=5}
AllCuSO4_glmer_1byRep$CHROM <- factor(AllCuSO4_glmer_1byRep$CHROM, levels=as.character(as.roman(c(1:16,1000))))
sgd_copper$CHROM <- factor(sgd_copper$CHROM, levels=as.character(as.roman(c(1:16,1000))))
sgd_copper_eh$CHROM <- factor(sgd_copper_eh$CHROM, levels=as.character(as.roman(c(1:16,1000))))

AllCuSO4_glmer_1byRep %>% filter(label %in% c("Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore))) + 
  geom_point(aes(alpha = abs(zscore) > 1.01), color = "gray", size = 0.1) +
  geom_point(aes(alpha = abs(zscore) < 1.01), color = "black", size = 0.1) +
  geom_vline(data = sgd_copper, 
             aes(xintercept = Gene.chromosomeLocation.start, color = paste(CHROM,Gene.symbol)),
             size = 1, alpha = 0.3) +
  geom_vline(data = sgd_copper_eh,
             aes(xintercept = Gene.chromosomeLocation.start, color = paste(CHROM,Gene.symbol)),
             linetype = "dashed", alpha = 0.3) +
  geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  labs(color = "Gene", linetype = NULL, alpha = NULL) +
  theme(legend.position = "bottom") + ggtitle("Interaction points") +
    scale_size_manual(values = c(0.1, 2)) +
  scale_alpha_manual(values = c(0.4, 0))

AllCuSO4_glmer_1byRep %>% filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore))) + 
  geom_point(aes(alpha = abs(zscore) > 1.01), color = "gray", size = 0.1) +
  geom_point(aes(alpha = abs(zscore) < 1.01), color = "black", size = 0.1) +
  geom_vline(data = sgd_copper, 
             aes(xintercept = Gene.chromosomeLocation.start, color = paste(CHROM,Gene.symbol)),
             size = 1, alpha = 0.3) +
  geom_vline(data = sgd_copper_eh,
             aes(xintercept = Gene.chromosomeLocation.start, color = paste(CHROM,Gene.symbol)),
             linetype = "dashed", alpha = 0.3) +
  geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  labs(color = "Gene", linetype = NULL, alpha = NULL) +
  theme(legend.position = "bottom") + ggtitle("Bulk points") +
    scale_size_manual(values = c(0.1, 2)) +
  scale_alpha_manual(values = c(0.4, 0))
```

```{r, fig.height=6, fig.width=16}
AllCuSO4_glmer_1byRep %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) + 
  geom_line() +
  geom_vline(data = sgd_copper, 
             aes(xintercept = Gene.chromosomeLocation.start, color = paste(CHROM,Gene.symbol)),
             size = 1, alpha = 0.3) +
    geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  labs(color = "Gene", linetype = NULL, alpha = NULL) +
  theme(legend.position = "bottom") +
    scale_size_manual(values = c(0.1, 2)) +
  scale_alpha_manual(values = c(0.4, 0))
  
```

Looking at FRE1

```{r}
#FRE1 Gene for resolution
AllCuSO4_glmer_1byRep %>% filter(CHROM == "XII", POS > (568567-1000), POS < (570627+1000)) %>%
  ungroup() %>%
  select(CHROM, POS) %>%
  distinct() %>%
  ggplot() + 
  #geom_vline(xintercept = c(570627,568567), linetype = "dashed") +
  annotate("rect", fill = "skyblue", alpha = 0.2,
            xmin = 568567, xmax = 570627 + 11/12,
            ymin = -Inf, ymax = Inf) +  
  geom_point(aes(x = POS, y = ""), size = 4, shape = 21) +
  xlim((568567-1000),(570627+1000)) +
  ylab("SNP") +
  ggtitle("SNPs in FRE1 +/- 1kb")

```

```{r, fig.height=4, fig.width=8}
AllCuSO4_glmer_1byRep %>% filter(CHROM == "XII") %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) + 
  geom_line() +
  geom_vline(aes(xintercept = c(568567), color = "FRE1"),
             size = 1, alpha = 0.3) +
  geom_vline(aes(xintercept = c(570627), color = "FRE1"),
             size = 1, alpha = 0.3) +
    geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  labs(color = NULL, linetype = NULL, alpha = NULL) +
  theme(legend.position = "bottom") +
    scale_size_manual(values = c(0.1, 2)) +
  scale_alpha_manual(values = c(0.4, 0))


AllCuSO4_glmer_1byRep %>% filter(CHROM == "VIII") %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) + 
  geom_line() +
  geom_vline(aes(xintercept = 212535, color = "CUP1"),
             size = 1, alpha = 0.3) +
    geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  labs(color = NULL, linetype = NULL, alpha = NULL) +
  theme(legend.position = "bottom") +
    scale_size_manual(values = c(0.1, 2)) +
  scale_alpha_manual(values = c(0.4, 0))

```

```{r, fig.height=3, fig.width=8}
################################################################################

AllCuSO4_glmer_1byRep %>% filter(CHROM == "XII") %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) + 
  geom_line() +
  geom_vline(aes(xintercept = c(568567), color = "FRE1"),
             size = 1, alpha = 0.3) +
  geom_vline(aes(xintercept = c(570627), color = "FRE1"),
             size = 1, alpha = 0.3) +
    geom_hline(data = q5_all[q5_all$label %in% c("Bulk"),], aes(yintercept = q5)) +
  facet_grid(~CHROM, scales = "free", space = "free") +
  labs(color = NULL, linetype = NULL, alpha = NULL) +
  theme(legend.position = "bottom") +ylab("")+
    scale_size_manual(values = c(0.1, 2)) +
  scale_color_manual(values = c("#898ef5")) +
  scale_alpha_manual(values = c(0.8, 0)) -> p1


AllCuSO4_glmer_1byRep %>% filter(CHROM == "VIII") %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) + 
  geom_line() +
  geom_vline(aes(xintercept = 212535, color = "CUP1"),
             size = 1, alpha = 0.3) +
    geom_hline(data = q5_all[q5_all$label %in% c("Bulk"),], aes(yintercept = q5)) +
  facet_grid(~CHROM, scales = "free", space = "free") +
  labs(color = NULL, linetype = NULL, alpha = NULL) +
  theme(legend.position = "bottom") +
    scale_size_manual(values = c(0.1, 2)) +
  ylim(0,12)+ ylab("Additive (abs scale)")+
    scale_color_manual(values = c("#1dc678")) +
  scale_alpha_manual(values = c(0.8, 0)) -> p2

require(cowplot)

plot_grid(p2, p1, ncol = 2)

```

```{r, fig.width=16, fig.height=5}
AllCuSO4_glmer_1byRep %>% 
  ungroup() %>% na.omit() %>%
  group_by(CHROM, CSS, label) %>%
  arrange(desc(abs(zscore))) %>%
  summarize(peakPOS = head(POS, 1),
            zscore = max(abs(zscore))) %>%
  merge(q5_all) %>% 
  filter(abs(zscore) > q5) -> peaks

saveRDS(peaks, file = "peaks_CuAll.rds")

knowngenes <- data.frame(Gene = c("CUP1", "FRE1", "FRE1"),
                         POS = c(212535, 568567, 570627),
                         CHROM = c("VIII", "XII", "XII"))

AllCuSO4_glmer_1byRep %>% 
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) +
  #cutoffs and genes
  geom_vline(data = knowngenes, aes(xintercept = POS), color = "red") +
  geom_vline(data = peaks[peaks$label %in% c("Bulk", "Interaction"),], 
             aes(xintercept = peakPOS, color = CHROM, linetype = CSS),
             size = 1, alpha = 0.8) +
    geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  #actual data
  geom_line() +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  labs(color = NULL, linetype = "CSS", alpha = NULL) +
  theme(legend.position = "bottom") +
    scale_size_manual(values = c(0.1, 2)) +
  scale_alpha_manual(values = c(0.4, 0))

#peaks %>% filter(CHROM == "VIII")
#rd_logratios %>% filter(POS == 141525) %>% distinct()

AllCuSO4_glmer_1byRep %>% 
  filter(CHROM == "XII") %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore), shape = CSS)) +
  #cutoffs and genes
  geom_rect(aes(xmin = 568567, xmax = 570627, ymin = -Inf, ymax = Inf), alpha = 0.2, fill = "lightblue") +
  geom_vline(data = peaks[peaks$label %in% c("Bulk") & peaks$CHROM == "XII",], 
             aes(xintercept = peakPOS, color = CHROM, linetype = CSS),
             size = 1, alpha = 0.8) +
    geom_hline(data = q5_all[q5_all$label %in% c("Bulk"),], aes(yintercept = q5)) +
  #actual data
  geom_point(alpha = 0.4) +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  labs(color = NULL, linetype = "CSS", alpha = NULL) +
  theme(legend.position = "bottom") +
  xlim(520000, 600000) +
    scale_size_manual(values = c(0.1, 2)) +
  scale_alpha_manual(values = c(0.4, 0))+
  theme(axis.text.x=element_text())

AllCuSO4_glmer_1byRep %>% 
  filter(CHROM == "VIII") %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore), shape = CSS)) +
  #cutoffs and genes
  geom_rect(aes(xmin = 212535, xmax = 212720, ymin = -Inf, ymax = Inf), alpha = 0.2, fill = "lightblue") +
  geom_rect(aes(xmin = 214533, xmax = 214718, ymin = -Inf, ymax = Inf), alpha = 0.2, fill = "lightblue") +
  geom_vline(data = peaks[peaks$label %in% c("Bulk") & peaks$CHROM == "VIII",], 
             aes(xintercept = peakPOS, color = CHROM, linetype = CSS),
             size = 1, alpha = 0.8) +
    geom_hline(data = q5_all[q5_all$label %in% c("Bulk"),], aes(yintercept = q5)) +
  #actual data
  geom_point(alpha = 0.4) +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  labs(color = NULL, linetype = "CSS", alpha = NULL) +
  theme(legend.position = "bottom") +
  xlim(c(2e05, 2.25e05))+
    scale_size_manual(values = c(0.1, 2)) +
  scale_alpha_manual(values = c(0.4, 0))+
  theme(axis.text.x=element_text())

```

```{r}

peaks %>% filter(CHROM == "XII") %>%
  mutate(Dist = peakPOS - 570627) %>%
  arrange(abs(Dist)) -> FRE1_dist

FRE1_dist

peaks %>% filter(CHROM == "VIII") %>%
  mutate(Dist = peakPOS - 212535) %>%
  arrange(abs(Dist)) -> CUP1_dist

CUP1_dist


```

# Peak finder based on actual change in direction

Applying this to everythingg

```{r, fig.width=12, fig.height=5}

AllCuSO4_glmer_1byRep %>% group_by(CHROM) %>% summarize(POS = max(POS)) -> limits

mylabs <- data.frame(label = c(unique(AllCuSO4_glmer_1byRep$label)),
           zscore = 0, 
           sdz = 0)

data.frame(CSS = unique(AllCuSO4_glmer_1byRep$CSS)) %>% merge(mylabs)

for(i in 1:300){
  limits <- cbind(limits, limits$POS + i)
}

limits %>% pivot_longer(-CHROM, values_to = "POS") %>% merge(data.frame(CSS = unique(AllCuSO4_glmer_1byRep$CSS))) %>% merge(mylabs) %>%
  select(c("CHROM",  "label" , "CSS" ,   "POS" ,   "zscore", "sdz"   )) %>%
  rbind(AllCuSO4_glmer_1byRep) %>% 
  group_by(label, CSS, CHROM) %>%
  summarize(POS = POS,
            zscore = zscore,
            SmoothZ = frollapply(zscore, n = 300, FUN = mean, align = "center", na.rm = TRUE)) %>%
  summarize(POS = POS,
                    zscore = zscore,
                    SmoothZ = SmoothZ,
                    change = frollapply(abs(SmoothZ), n = 50, findchange, align = "center")) %>%
  summarize(POS = POS,
                    zscore = zscore,
                    SmoothZ = SmoothZ,
          change = change,
                    peak = frollapply(abs(change), n = 4, findpeak, align = "center")) %>%
  filter(peak == -1) %>% merge(q5_all) %>% filter(abs(zscore) > q5) -> TruePeaks

dim(TruePeaks)

AllCuSO4_glmer_1byRep %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = label)) +
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Bulk")& TruePeaks$CHROM != "VI",],
             aes(xintercept = POS, color = label), alpha = 0.2)+
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Interaction") ,],
             aes(xintercept = POS), alpha = 0.1, color = "red", size = 2)+
  geom_line() +
  geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  labs(linetype = NULL) +
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_color_manual(values = c("black", "purple"))

AllCuSO4_glmer_1byRep %>%
  filter(CHROM == "VII") %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = label)) +
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Bulk")& TruePeaks$CHROM == "VII",],
             aes(xintercept = POS, color = label), alpha = 0.2)+
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Interaction")& TruePeaks$CHROM == "VII" ,],
             aes(xintercept = POS), alpha = 0.1, color = "red", size = 2)+
  geom_line() +
  geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  labs(linetype = NULL) +
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none", axis.text.x = element_text()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_color_manual(values = c("black", "purple")) -> Chr7_Plot

Chr7_Plot

TruePeaks[TruePeaks$label %in% c("Interaction")& TruePeaks$CHROM == "VII" , "POS"]
TruePeaks[TruePeaks$label %in% c("Bulk")& TruePeaks$CHROM == "VII", "POS"]
```

### Ranks of Bulk Effects

```{r, eval = FALSE}
TruePeaks %>% filter(label == "Bulk") %>% ungroup() %>% 
  group_by(CSS, CHROM) %>%
  summarize(zscore = head(abs(zscore),1)) %>%
  pivot_wider(names_from = CSS, values_from = zscore) %>%
  na.omit() %>%
  ggplot(aes(x = I, y = VIII)) + geom_point() +
  geom_smooth(method = "lm") +
  geom_abline(intercept = 0, slope = 1) +
  theme(axis.text.x = element_text()) +
  xlim(0, 10) +
  ylim(0, 12)

TruePeaks %>% filter(label == "Bulk") %>% ungroup() %>% 
  group_by(CSS, CHROM) %>%
  summarize(zscore = head(abs(zscore),1)) %>%
  pivot_wider(names_from = CSS, values_from = zscore) %>%
  na.omit() -> ChromPeakRanks

ChromPeakRanks %>% select(CHROM, I) %>% arrange(I) %>% mutate(RankI = row_number()) -> CSSI
ChromPeakRanks %>% select(CHROM, VIII) %>% arrange(VIII) %>% mutate(RankVIII = row_number()) -> CSSVIII

merge(CSSI, CSSVIII) %>%
  ggplot(aes(x = RankI, y = RankVIII)) + geom_point(aes(color = CHROM), size = 4) +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(method = "lm")

```

### Interaction Effect Sampling

```{r}
AllCuSO4_glmer_1byRep %>% filter(label == "Interaction") -> AllInters

TruePeaks %>% filter(label == "Bulk") %>% ungroup() %>%
  select(CSS, CHROM, POS) -> BulkPeaks

AllCuSO4_glmer_1byRep %>% filter(label == "Interaction") %>% merge(BulkPeaks) %>% mutate(Cat = "Peak") -> IntUnderBulks #204

numsims <- 1000
SimResults <- data.frame(BulkStat = 1:numsims,
                         RandStat = NA)
for(i in 1:numsims){
  AllInters[sample(1:length(AllInters$POS), 204),] %>% mutate(Cat = "Rand") -> IntRandomm
  wtest <- wilcox.test((IntRandomm$zscore), (IntUnderBulks$zscore))
  SimResults$BulkStat[i] <- wtest$statistic
}

for(i in 1:numsims){
  AllInters[sample(1:length(AllInters$POS), 204),] %>% mutate(Cat = "Rand") -> IntRandomm1
  AllInters[sample(1:length(AllInters$POS), 204),] %>% mutate(Cat = "Rand") -> IntRandomm2
  wtest <- wilcox.test((IntRandomm1$zscore), (IntRandomm2$zscore))
  SimResults$RandStat[i] <- wtest$statistic
}

SimResults %>% ggplot(aes(x = BulkStat)) + geom_density(color = "red") +
  geom_density(aes(x = RandStat), color = "gray") +
  theme(axis.text.x = element_text()) +
  xlab("W Statistic") +
  ggtitle("Peak vs Random (Red), Random vs Random (Gray) Interaction Z-scores") -> PRand

t.test(abs(SimResults$BulkStat), abs(SimResults$RandStat))

plot(dwilcox(x = 1:1000, m = 204, n = 204, log = FALSE))
plot(dnorm(x = 1:1000, mean = 204, sd = 204))

```

Assigning interaction scores the sign of agreeing or disagreeing with bulk direction

```{r}
TruePeaks %>% filter(label == "Bulk") %>% ungroup() %>%
  select(CSS, CHROM, POS) -> BulkPeaks

AllCuSO4_glmer_1byRep %>% filter(label %in% c("Interaction", "Bulk")) %>%
  select(-sdz) %>%
  pivot_wider(names_from = label, values_from = zscore) %>%
  mutate(Agree = Bulk/Interaction > 0) %>%
  mutate(zscore_sign = abs(Interaction)* ((2*Agree) - 1)) -> AllInters_sign

AllInters_sign %>% merge(BulkPeaks) %>% mutate(Cat = "Peak") -> IntUnderBulks_sign

################################################################################
numsims <- 1000
SimResults_sign <- data.frame(BulkStat = 1:numsims,
                         RandStat = NA)
for(i in 1:numsims){
  AllInters[sample(1:length(AllInters_sign$POS), 204),] %>% mutate(Cat = "Rand") -> IntRandomm
  wtest <- wilcox.test(abs(IntRandomm$zscore), abs(IntUnderBulks_sign$zscore))
  SimResults_sign$BulkStat[i] <- wtest$statistic
}

for(i in 1:numsims){
  AllInters[sample(1:length(AllInters_sign$POS), 204),] %>% mutate(Cat = "Rand") -> IntRandomm1
  AllInters[sample(1:length(AllInters_sign$POS), 204),] %>% mutate(Cat = "Rand") -> IntRandomm2
  wtest <- wilcox.test(abs(IntRandomm1$zscore), abs(IntRandomm2$zscore))
  SimResults_sign$RandStat[i] <- wtest$statistic
}

SimResults_sign %>% ggplot(aes(x = BulkStat)) + geom_density(color = "red") +
  geom_density(aes(x = RandStat), color = "gray") +
  theme(axis.text.x = element_text()) +
  xlab("W Statistic") +
  ggtitle("Peak vs Random (Red), Random vs Random (Gray) Interaction Z-scores") -> PAbs

t.test(abs(SimResults_sign$BulkStat), abs(SimResults_sign$RandStat))


require(cowplot)
plot_grid(PRand, PAbs)

SimResults_sign %>% mutate(Test = "Abs") -> temp
SimResults %>% mutate(Test = "Signed") %>%
  rbind(temp) %>%
  ggplot() +
  geom_density(aes(x = BulkStat, linetype = Test, ), color = "red") +
  geom_density(aes(x = RandStat, linetype = Test), color = "gray") +
  ggtitle("Interaction Scores under Peaks (red) vs not (gray)") +
  xlab("W Statistic")
  

```

### Interaction Effect COrrelations

Are interactions higher under true peaks than not?

```{r}
TruePeaks %>% filter(label == "Bulk") %>% ungroup() %>%
  select(CSS, CHROM, POS) -> BulkPeaks

AllCuSO4_glmer_1byRep %>% filter(label == "Interaction") %>% merge(BulkPeaks) %>% mutate(Cat = "Peak") -> IntUnderBulks #204 
AllCuSO4_glmer_1byRep %>% filter(label == "cept") %>% merge(BulkPeaks) %>% mutate(Cat = "Peak") -> cUnderBulks #204 rows
AllCuSO4_glmer_1byRep %>% filter(label == "Background") %>% merge(BulkPeaks) %>% mutate(Cat = "Peak") -> BkUnderBulks #204 rows

AllCuSO4_glmer_1byRep %>% filter(label == "Interaction") -> AllInters
AllCuSO4_glmer_1byRep %>% filter(label == "cept") -> Allcept
AllCuSO4_glmer_1byRep %>% filter(label == "Background") -> AllBkg

#SAMPLE ONCE
AllInters[sample(1:length(AllInters$POS), 204),] %>% mutate(Cat = "Rand") -> IntRandomm
#t.test(abs(IntRandomm$zscore), abs(IntUnderBulks$zscore), alternative = "less")
wilcox.test(abs(IntRandomm$zscore), abs(IntUnderBulks$zscore), alternative = "less")

#SAMPLE ONCE - INTERCEPT
Allcept[sample(1:length(Allcept$POS), 204),] %>% mutate(Cat = "Rand") -> ceptRandomm
#t.test(abs(ceptRandomm$zscore), abs(cUnderBulks$zscore), alternative = "less")
wilcox.test(abs(ceptRandomm$zscore), abs(cUnderBulks$zscore), alternative = "less")

#SAMPLE ONCE - BACKGROUND
AllBkg[sample(1:length(AllBkg$POS), 204),] %>% mutate(Cat = "Rand") -> BkRandomm
#t.test(abs(BkRandomm$zscore), abs(BkUnderBulks$zscore), alternative = "less")
wilcox.test(abs(BkRandomm$zscore), abs(BkUnderBulks$zscore), alternative = "less")

rbind(IntUnderBulks, IntRandomm) %>%
  ggplot(aes(x = abs(zscore), color = Cat)) + geom_density()

#LOOK AT EVERYTHING ABOVE Q5
q5_all %>% filter(label == "Bulk") %>% select(CSS, Bulkq5 = q5) -> q5_Bulk

AllCuSO4_glmer_1byRep %>% select(-sdz) %>% pivot_wider(names_from = label, values_from = zscore) %>%
  merge(q5_Bulk) %>% na.omit() -> TestDistr

#PLOT DISTRIBUTIONS
TestDistr %>% na.omit() %>% ggplot(aes(x = abs(Interaction), color = abs(Bulk) > Bulkq5)) + geom_density()
TestDistr %>% na.omit() %>% ggplot(aes(x = abs(Background), color = abs(Bulk) > Bulkq5)) + geom_density()
TestDistr %>% na.omit() %>% ggplot(aes(x = abs(cept), color = abs(Bulk) > Bulkq5)) + geom_density()

```

These have WAY too much data, though interactions do look much more significant

```{r, eval = FALSE}
################################################################################
#T TEST FOR ENTIRE DATASET
TestDistr %>% filter(abs(Bulk) > Bulkq5) %>% select(Interaction) -> Above
TestDistr %>% filter(abs(Bulk) < Bulkq5) %>% select(Interaction) -> Below
Below[sample(1:length(Below$Interaction), size= length(Above$Interaction)),] -> Below

t.test(abs(Above$Interaction), abs(Below), alternative = "greater")

#TEST ALL OTHER PARAMS
TestDistr %>% filter(abs(Bulk) > Bulkq5) %>% select(cept) -> Above
TestDistr %>% filter(abs(Bulk) < Bulkq5) %>% select(cept) -> Below
Below[sample(1:length(Below$cept), size = length(Above$cept)),] -> Below

t.test(abs(Above$cept), abs(Below), alternative = "greater")

#TEST ALL OTHER PARAMS
TestDistr %>% filter(abs(Bulk) > Bulkq5) %>% select(Background) -> Above
TestDistr %>% filter(abs(Bulk) < Bulkq5) %>% select(Background) -> Below
Below[sample(1:length(Below$Background), size = length(Above$Background)),] -> Below

t.test(abs(Above$Background), abs(Below), alternative = "greater")

################################################################################
#So actually we need to sample from both over and over to see if that's actually a thing?
#BONFERONI CORRECT 62k
Anew = 0.05/62494
Anew

```

These really don't have enough data to draw conclusions (very few peaks) - it would honestly be better to compare the above areas for this but that probably isn't worth doing

```{r}
################################################################################
#What if we looked at where the intercept was significant and looked at the interaction scores?
TruePeaks %>% filter(label == "cept") %>% ungroup() %>%
  select(CSS, CHROM, POS) -> ceptPeaks

AllCuSO4_glmer_1byRep %>% filter(label == "Interaction") %>% merge(ceptPeaks) %>% mutate(Cat = "Peak") -> IntUndercept #243
#SAMPLE ONCE
AllInters[sample(1:length(AllInters$POS), 243),] %>% mutate(Cat = "Rand") -> IntRandomm
t.test(abs(IntRandomm$zscore), abs(IntUndercept$zscore), alternative = "less")

################################################################################
#What if we looked at where the Background was significant and looked at the interaction scores?
TruePeaks %>% filter(label == "Background") %>% ungroup() %>%
  select(CSS, CHROM, POS) -> BKPeaks

AllCuSO4_glmer_1byRep %>% filter(label == "Interaction") %>% merge(BKPeaks) %>% mutate(Cat = "Peak") -> IntUnderBK #9
#SAMPLE ONCE
AllInters[sample(1:length(AllInters$POS), 9),] %>% mutate(Cat = "Rand") -> IntRandomm
t.test(abs(IntRandomm$zscore), abs(IntUnderBK$zscore), alternative = "less")

```

```{r, fig.width=8, fig.height=4}

AllCuSO4_glmer_1byRep %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = CSS)) +
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Bulk", "Interaction"),],
             aes(xintercept = POS, color = CSS), alpha = 0.2, linetype = "dashed")+
  geom_line(alpha = 0.4) +
  geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  theme(legend.position = "bottom") +
  scale_color_manual(values = c("navyblue", "darkorange")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

AllCuSO4_glmer_1byRep %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = CSS)) +
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Bulk"),],
             aes(xintercept = POS, color = CSS), alpha = 0.2, linetype = "dashed")+
  geom_line(alpha = 0.4) +
  geom_hline(data = q5_all[q5_all$label %in% c("Bulk"),], aes(yintercept = q5)) +
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "bottom") + #ylim(0,12) +
  scale_color_manual(values = c("navyblue", "darkorange")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  ggtitle("Bulk Effect Peaks")

```

```{r, fig.width=8, fig.height=4}
AllCuSO4_glmer_1byRep %>% 
  filter(label %in% c("Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = CHROM %in% c("I", "III", "V", "VII", "IX", "XI", "XIII", "XV"))) + 
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Interaction"),], 
             aes(xintercept = POS, color = CHROM %in% c("I", "III", "V", "VII", "IX", "XI", "XIII", "XV")), alpha = 0.2, linetype = "dashed")+
  geom_line(alpha = 0.4) +
  geom_hline(data = q5_all[q5_all$label %in% c("Interaction"),], aes(yintercept = q5)) +
  labs(color = NULL)+
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") + #ylim(0,12) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  ggtitle("Interaction Effect Peaks") +
  ylim(0,4)

AllCuSO4_glmer_1byRep %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = CHROM %in% c("I", "III", "V", "VII", "IX", "XI", "XIII", "XV"))) + 
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Bulk"),], 
             aes(xintercept = POS, color = CHROM %in% c("I", "III", "V", "VII", "IX", "XI", "XIII", "XV")), alpha = 0.2, linetype = "dashed")+
  geom_line(alpha = 0.4) +
  geom_hline(data = q5_all[q5_all$label %in% c("Bulk"),], aes(yintercept = q5)) +
  labs(color = NULL)+
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") + #ylim(0,12) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  ggtitle("Bulk Effect Peaks")

```

## Overlaps with specific genes in all peaks

```{r, fig.width=10, fig.height=4}
AllCuSO4_glmer_1byRep %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = label)) +
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Bulk"),],
             aes(xintercept = POS, color = label), alpha = 0.2)+
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Interaction"),],
             aes(xintercept = POS), alpha = 0.2, color = "red", size = 2)+
  geom_line() +
  geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  labs(linetype = NULL) +
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_color_manual(values = c("black", "purple"))

AllCuSO4_glmer_1byRep %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = CSS)) +
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Bulk", "Interaction"),],
             aes(xintercept = POS, color = CSS), alpha = 0.2)+
  geom_line(alpha = 0.4) +
  geom_hline(data = q5_all[q5_all$label %in% c("Bulk", "Interaction"),], aes(yintercept = q5)) +
  geom_vline(data = sgd_copper, 
             aes(xintercept = Gene.chromosomeLocation.start, linetype = paste(CHROM,Gene.symbol)),
             size = 1, alpha = 0.3)+ 
  labs(linetype = NULL) +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  theme(legend.position = "bottom") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_linetype_manual(values = c("dotted", "dotted","dotted", "dotted","dotted", "dotted","dotted", "dotted","dotted", 
                                   "dotted","dotted", "dotted","dotted", "dotted","dotted", "dotted","dotted", "dotted",
                                   "dotted", "dotted","dotted", "dotted","dotted", "dotted","dotted", "dotted","dotted", 
                                   "dotted","dotted", "dotted","dotted", "dotted"))

################################################################################
#Separate by chromosomes
################################################################################

chromlist <- c(c("VII", "X", "XII", "XIV", "XV"))
AllCuSO4_glmer_1byRep %>%
  merge(q5_all) %>%
  filter(CHROM %in% chromlist) %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = CSS)) +
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Bulk", "Interaction") & TruePeaks$CHROM %in% chromlist,],
             aes(xintercept = POS, color = CSS), alpha = 0.2)+
  geom_line(alpha = 0.4) +
  geom_hline(aes(yintercept = q5)) +
  geom_vline(data = sgd_copper[sgd_copper$CHROM %in% chromlist,], 
             aes(xintercept = Gene.chromosomeLocation.start, linetype = paste(CHROM,Gene.symbol)),
             size = 1, alpha = 0.3)+ 
  labs(linetype = NULL) +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  theme(legend.position = "bottom") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_linetype_manual(values = c("dotted", "dotted","solid", "dotted","dotted", "dotted","dotted", "dotted","dotted", 
                                   "dotted","dotted", "dotted","dotted", "dotted","dotted", "dotted","dotted", "dotted",
                                   "dotted", "dotted","dotted", "dotted","dotted", "dotted","dotted", "dotted","dotted", 
                                   "dotted","dotted", "dotted","dotted", "dotted")) +
  ggtitle("Chr Containing Interactions")

################################################################################
chromlist <- c(c("IV", "VII", "IX", "XI", "XII", "XIV", "XVI"))
AllCuSO4_glmer_1byRep %>%
  merge(q5_all) %>%
  filter(CHROM %in% chromlist) %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = CSS)) +
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Bulk") & TruePeaks$CHROM %in% chromlist,],
             aes(xintercept = POS, color = CSS), alpha = 0.05, size = 2)+
  geom_line(alpha = 0.4) +
  geom_hline(aes(yintercept = q5)) +
  labs(linetype = NULL) +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  theme(legend.position = "bottom") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  ggtitle("CSS Bulk Agreements")

chromlist <- c(c("IV", "VII", "IX", "XI", "XII", "XIV", "XVI"))
AllCuSO4_glmer_1byRep %>%
  merge(q5_all) %>%
  filter(CHROM %in% chromlist) %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = CHROM)) +
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Bulk") & TruePeaks$CHROM %in% chromlist,],
             aes(xintercept = POS, color = CHROM), alpha = 0.05, size = 2)+
  geom_line(alpha = 0.4) +
  geom_hline(aes(yintercept = q5)) +
  labs(linetype = NULL) +
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "bottom") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  ggtitle("CSS Bulk Agreements")


```

# How close are the peaks?

```{r, fig.width=10, fig.height=4, eval = FALSE}
TruePeaks %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  select(label, CHROM, CSS, POS) %>%
  pivot_wider(names_from = CSS, values_from = POS) -> TotalList

TotalList %>% select(-VIII) %>% unnest() -> chr1
TotalList %>% select(-I) %>% unnest() -> chr8

merge(chr1, chr8) %>% mutate(diff = abs(I - VIII)) %>% 
  group_by(CHROM) %>%
  summarize(diff = min(diff)) %>%
  ggplot() + geom_point(aes(y = diff, x = CHROM)) +
  theme(axis.text.x=element_text())

merge(chr1, chr8) %>% mutate(diff = abs(I - VIII)) %>% arrange(diff) %>%
  filter(diff < 8000) %>%
  group_by(label, CHROM, diff) %>%
  summarize(maxpoint = max(I, VIII),
            minpoint = min(I, VIII)) %>%
  ggplot(aes(color = CHROM)) + geom_linerange(aes(xmax = maxpoint, xmin = minpoint, y = diff)) +
  facet_grid(rows = "CHROM") +
  theme(axis.text.x=element_text())

merge(chr1, chr8) %>% mutate(diff = abs(I - VIII)) %>% arrange(diff) %>%
  filter(diff < 15000) %>%
  group_by(label, CHROM, diff) %>%
  summarize(maxpoint = max(I, VIII),
            minpoint = min(I, VIII)) %>%
  ggplot(aes(color = CHROM)) + geom_point(aes(x = CHROM, y = diff), alpha = 0.4, size = 2) +
  theme(axis.text.x=element_text())

################################################################################

merge(chr1, chr8) %>% mutate(diff = abs(I - VIII)) %>% arrange(diff) %>%
  filter(diff < 16000) %>%
  pivot_longer(c(I, VIII)) ->listofdiffs

AllCuSO4_glmer_1byRep %>%
  merge(q5_all) %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = CHROM, linetype = CSS)) +
  geom_vline(data = TruePeaks[TruePeaks$label %in% c("Bulk") & TruePeaks$POS %in% listofdiffs$value,],
             aes(xintercept = POS, color = CHROM))+

  geom_line(alpha = 0.4) +
    
  geom_hline(aes(yintercept = q5)) +
  labs(linetype = NULL) +
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  ggtitle("CSS Bulk Agreements within 16 kb")


```

# The Classics

```{r, fig.width=10, fig.height=4}

AllCuSO4_glmer_1byRep %>%
  merge(q5_all) %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = zscore, color = label)) + 
  geom_hline(aes(yintercept = c(q5)), linetype = "dashed") +
  geom_hline(aes(yintercept = c(-q5)), linetype = "dashed") +
  geom_line() +
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "bottom") +
  ggtitle("Bulk and Interaction Effects") +
  scale_color_manual(values = c("black", "purple"))

#PEAKS OF INTERACTIONS
AllCuSO4_glmer_1byRep %>%
  merge(q5_all) %>% filter(label == "Interaction", 
                      abs(zscore) > q5) %>%
  arrange(desc(abs(zscore))) %>%
  group_by(CHROM, CSS) %>%
  summarize(POS = head(POS, 1)) -> IntPeaks

AllCuSO4_glmer_1byRep %>%
  merge(q5_all) %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = label)) +
  # geom_vline(data = minlist,
  #            aes(xintercept = POS), color = "gray", size = 1)+
  geom_vline(data = IntPeaks,
             aes(xintercept = POS),
             color = "red", linetype = "dashed", size = 1, alpha = 0.4)+
  
  geom_line() +
  geom_hline(aes(yintercept = q5)) +
  
  labs(linetype = NULL, color = NULL) +
  scale_color_manual(values = c("black", "purple")) +
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  ggtitle("Selection Agreements vs Interaction Peaks")


AllCuSO4_glmer_1byRep %>%
  merge(q5_all) %>%
  filter(label %in% c("Bulk", "Interaction"), CHROM == "VII") %>%
  ggplot(aes(x = POS, y = abs(zscore), color = label)) +
  
  # geom_vline(data = minlist,
  #            aes(xintercept = POS), color = "gray", size = 1)+
  geom_vline(data = IntPeaks[IntPeaks$CHROM == "VII",],
             aes(xintercept = POS),
             color = "red", linetype = "dashed", size = 1, alpha = 0.4)+
  
  geom_line() +
  geom_hline(aes(yintercept = q5)) +
  
  labs(linetype = NULL, color = NULL) +
  scale_color_manual(values = c("black", "purple")) +
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  ggtitle("Selection Agreements vs Interaction Peaks")


```



## How many interaction peaks are within x of bulk peaks?

```{r}
TruePeaks %>% filter(label == "Bulk") %>% select(CHROM, Bulk_POS =POS) -> BulkPeaks
TruePeaks %>% filter(label == "Interaction") %>% select(CHROM, Int_POS =POS) %>% merge(BulkPeaks) %>%
  mutate(diff = abs(Int_POS - Bulk_POS)) %>% 
  group_by(CHROM) %>%
  summarize(Dist = min(diff)) %>%
  arrange(Dist)

TruePeaks %>% filter(label == "Interaction", CHROM == "XII")
#FRE1 is at 570627

```

# Count distance between POS for smoothing

```{r}
rawdata_called_ex <- readRDS("rawdata_called_ex.rds")

rawdata_called_ex %>% select(CHROM, POS) %>% distinct() %>%
  arrange(POS) %>% group_by(CHROM) %>%
  summarize(POS = POS,
            Span = frollapply(n = 200, POS, FUN = subtract, align = "center")) -> SmoothSpans

SmoothSpans %>% filter(CHROM != "M") %>% ggplot() + geom_density(aes(x = Span, color = CHROM, linetype = CHROM == "III"), alpha = 0.3) +
  geom_density(aes(x = Span), size = 1) +
  theme(axis.text.x = element_text(),
        legend.position = "bottom") +
  xlim(0, 3000)

mean(SmoothSpans$Span, na.rm = TRUE)
median(SmoothSpans$Span, na.rm = TRUE) #32kb span

```

# Circos Plots for Interaction Found

```{r}
#Load data for interaction networks
CUP1_Interactions <- readRDS("Costanzo_CUP1_Interactions.rds")
BloomVIII_Interactions <- readRDS("BloomVIII_Interactions.rds")
NguyenVIII_Interactions <- readRDS("NguyenVIII_Interactions.rds")
MatsuiVIII_Interactions <- readRDS("MatsuiVIII_Interactions.rds")

```

```{r, fig.width=5, fig.height=5, warning=FALSE, message=FALSE}
ChromosomeScale2 <- data.frame(CHROM = factor(as.character(as.roman(1:16)),
                                             levels = as.character(as.roman(1:16))),
                              start = rep(1, 16),
                              end = c(.23,.81,.32, 1.53, .58, .27, 1.09, .56, .44, .75, .67, 1.08, .92, .78, 1.09, .95)*1000000) %>% 
  pivot_longer(c(start, end), names_to = "delete", values_to = "POS") %>%
  mutate(summary = 0, label = "Bulk") %>% select(-delete)

AllCuSO4_glmer_1byRep  %>% filter(CSS == "I", label == "Interaction") %>%
  ungroup() %>%
  select(CHROM, POS, summary = zscore, label) %>%
  rbind(ChromosomeScale2) -> d1AllC

AllCuSO4_glmer_1byRep  %>% filter(CSS == "VIII", label == "Interaction") %>%
  ungroup() %>%
  select(CHROM, POS, summary = zscore, label) %>%
  rbind(ChromosomeScale2) -> d8AllC

TruePeaks %>% filter(CSS == "VIII", label == "Interaction") %>%
  ungroup() %>%
  select(CHROM, POS, summary = zscore, label) -> peaks8

cybr_circos(d1 = d1AllC, 
            d8 = d8AllC,
            peaklist8 = peaks8)

# #Costanzo Data
# cybr_circos_comp(d1 = d1AllC, 
#             d8 = d8AllC,
#             peaklist8 = peaks8, 
#             complist = CUP1_Interactions,
#             colorC = "#9f19d7")
# 
# #Bloom Data (CuSO4 Specific)
# cybr_circos_comp(d1 = d1AllC, 
#             d8 = d8AllC,
#             peaklist8 = peaks8, 
#             complist = BloomVIII_Interactions,
#             colorC = "#8B0000")
# 
# #Nguyen Data
# 
# cybr_circos_comp(d1 = d1AllC, 
#             d8 = d8AllC,
#             peaklist8 = peaks8, 
#             complist = NguyenVIII_Interactions,
#             colorC = "#8B0000")
```

### Plot overlaps between datasets

```{r}
CUP1_Interactions <- readRDS("Costanzo_CUP1_Interactions.rds")
BloomVIII_Interactions <- readRDS("BloomVIII_Interactions.rds")
NguyenVIII_Interactions <- readRDS("NguyenVIII_Interactions.rds")
MatsuiVIII_Interactions <- readRDS("MatsuiVIII_Interactions.rds")
```

```{r, fig.width=16, fig.height=5}


AllCuSO4_glmer_1byRep %>% filter(label %in% c("Bulk", "Interaction"), CSS == "VIII") %>% ggplot(aes(x = POS, y = abs(zscore), linetype = CSS, color = label)) +
  geom_vline(data = CUP1_Interactions, aes(xintercept = POS, alpha = abs(E)), color = "lightblue") +
  geom_line() +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  scale_color_manual(values = c("black", "purple")) +
  ggtitle("Costanzo Data by E")

AllCuSO4_glmer_1byRep %>% filter(label %in% c("Bulk", "Interaction"), CSS == "VIII") %>% ggplot(aes(x = POS, y = abs(zscore), linetype = CSS, color = label)) +
  geom_vline(data = MatsuiVIII_Interactions, aes(xintercept = POS, size = LOD), alpha = 0.3, color = "lightblue") +
  geom_line() +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  scale_color_manual(values = c("black", "purple")) +
  ggtitle("Matsui data by LOD")

# 
# AllCuSO4_glmer_1byRep %>% filter(label == "Interaction") %>% ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) +
#   geom_line() +
#   geom_vline(data = BloomVIII_Interactions, aes(xintercept = POS), color = "purple", linetype = "dashed") +
#   geom_vline(data = NguyenVIII_Interactions, aes(xintercept = POS), color = "red") +
#   facet_grid(~CHROM, scales = "free", space = "free")
# 
# NguyenVIII_Interactions %>% filter(Chr8POS < 2.5e5, Chr8POS > 1.5e5)


AllCuSO4_glmer_1byRep %>% filter(label %in% c("Bulk"), CSS == "VIII") %>% 
  ggplot(aes(x = POS, y = CHROM)) +
  geom_tile(aes(color = abs(zscore)),na.rm = TRUE) +
  geom_vline(data = BloomVIII_Interactions, aes(xintercept = POS), color = "orange",  size = 1) +
  geom_vline(data = NguyenVIII_Interactions, aes(xintercept = POS), color = "red",size = 1) +
  facet_grid(rows = "CHROM", scales = "free", space = "free") +
  scale_color_gradient2(low = "gray", mid = "black", high = "cyan", midpoint = 6)+
  ggtitle("Bulk Effects")

AllCuSO4_glmer_1byRep %>% filter(label %in% c("Interaction"), CSS == "VIII") %>% 
  ggplot(aes(x = POS, y = CHROM)) +
  geom_tile(aes(color = abs(zscore)),na.rm = TRUE) +
  geom_vline(data = BloomVIII_Interactions, aes(xintercept = POS), color = "orange",  size = 1) +
  geom_vline(data = NguyenVIII_Interactions, aes(xintercept = POS), color = "red",size = 1) +
  facet_grid(rows = "CHROM", scales = "free", space = "free") +
  scale_color_gradient2(low = "gray", mid = "black", high = "cyan", midpoint = 2)+
  ggtitle("Interaction Effects")

AllCuSO4_glmer_1byRep %>% filter(label %in% c("Bulk", "Interaction"), CSS == "VIII") %>% ggplot(aes(x = POS, y = abs(zscore), linetype = CSS, color = label)) +
  geom_vline(data = BloomVIII_Interactions, aes(xintercept = POS, size = CHROM == "XI"), color = "orange") +
  geom_vline(data = NguyenVIII_Interactions, aes(xintercept = POS, size = CHROM %in% c("XVI", "XV")), color = "red") +
  geom_vline(data = MatsuiVIII_Interactions, aes(xintercept = POS, size = CHROM == "XV"), color = "skyblue") +
  geom_line() +
  facet_grid(label~CHROM, scales = "free", space = "free") +
  scale_color_manual(values = c("black", "purple"))+
  scale_size_manual(values = c(0.5, 2))


```

## Ziv and AIG Data Comparison

```{r, fig.width=16, fig.height=5}
Ziv_rawdata_called <- readRDS("Ziv_rawdata_called.rds")
Ziv_rawdata_smoothed <- readRDS("Ziv_rawdata_smoothed.rds")
CB_AIGs_logOdds <- readRDS("CB_AIGs_logOdds.rds")

rd_factor %>% filter(Bulk == "Dilute") %>%
  pivot_wider(names_from = Allele, values_from = SmoothCount) %>% unnest() %>% select(Dataset, CHROM, POS, Oak, Wine) %>%
  mutate(logOdds = log(Wine/Oak)) -> Cu_Pooled_logOdds


Ziv_rawdata_smoothed %>% pivot_wider(names_from = Allele, values_from = SmoothCount) %>% unnest() %>%
  mutate(logOdds = log(Wine/Oak)) -> Ziv_logodds

sgd_orfs <- read.csv("C:/Users/Cassandra/Documents/R_FileTransfer/SGD_ORFs.csv")

genes <- c("IME1", "RME1", "RSF1")
sgd_orfs %>% filter(Gene.symbol %in% genes) %>%
  mutate(CHROM = gsub("chr", "", Gene.chromosome.primaryIdentifier)) -> sgd_spo

CB_AIGs_logOdds %>% mutate(Dataset = paste("CB_AIG ", Bulk, Rep)) %>%
  select(Dataset, CHROM, POS, Oak, Wine, logOdds) %>%
  #rbind(Ziv_logodds) -> comparison
  rbind(Cu_Pooled_logOdds[Cu_Pooled_logOdds$CHROM != "VIII",]) -> comparison

comparison %>% filter(CHROM %in% c("I", "M") == FALSE) %>%
  ggplot(aes(x = POS, y = logOdds, color = Dataset)) + 
    geom_line(alpha = 0.4, size = 0.5) +
  geom_hline(yintercept = 0) +
  geom_vline(data = sgd_spo, aes(xintercept = Gene.chromosomeLocation.start, linetype = Gene.symbol), 
             size = 1, alpha = 0.8, color = "red") +
    facet_grid(~CHROM, scales = "free", space = "free") +
  # scale_color_manual(values = c("orchid","orchid","orchid","orchid","orchid","orchid","orchid","orchid",
  #                               "black","black","black","black","black","black","black","black","black","black","black","black","black","black","black")) +
  theme(legend.position = "none") +
  ggtitle("logOdds of Ziv AIGs (black) vs CB AIGs (purple)")
```

## Multipool

Produce File

```{r, eval = FALSE}
rawdata_called_ex <- readRDS("rawdata_called_ex.rds")
rawdata_called_ex %>% pivot_wider(names_from = Allele, values_from = Reads) %>%
  select(CHROM, POS, Wine, Oak, Dataset) -> CuSO4_mpsetup

expnames <- read.csv("experiment_names_524.csv")

CuSO4_mpsetup %>% mutate(Dataset = gsub("n01_", "", Dataset)) %>%
  mutate(Dataset = gsub(".fastq", "", Dataset)) %>%
  separate(Dataset, into = c("Pool", "Dataset"), sep = "_", extra = "merge") %>%
  merge(expnames) %>% unnest() %>% select(CHROM, POS, Bulk, Wine, Oak)-> CuSO4_mpsetup_final

CuSO4_mpsetup_final %>% na.omit() -> CuSO4_mpsetup_final

CuSO4_mpsetup_final %>% filter(Bulk != "Fluconazole") -> CuSO4_mpsetup_final

for(d in unique(CuSO4_mpsetup_final$Bulk)){
  for(c in unique(CuSO4_mpsetup_final$CHROM)){
   CuSO4_mpsetup_final %>% filter(CHROM == c, Bulk == d) %>%
      arrange(POS) %>% ungroup() %>%
      select(POS, Wine, Oak) -> temp
    filename = paste("MultiPool_Inputs/CUSO4all", d,"_", c,"new.txt", sep = "")
    write.table(temp, file = filename, col.names = FALSE, row.names = FALSE)
  }
}

```

Load file and produce plots

```{r, fig.width=12, fig.height=4}
#Start header to make everything easier
test8 <- read.table("MultiPool_Inputs/CuSO4_all_out_I.txt", sep = "\t", header = TRUE) %>% mutate(CHROM = "4")

#Load in all advanced intercross data
AllMP_few <- head(test8,1)
for(i in as.character(as.roman(1:16))){
  filename <- paste("MultiPool_Inputs/2kr_few_out_", i, ".txt", sep = "")
  tempfile <- read.table(filename, sep = "\t", header = TRUE) %>% mutate(CHROM = i)
  
  AllMP_few <- rbind(AllMP_few, tempfile)
}

AllMP_few %>% distinct() %>%
  group_by(CHROM) %>%
  summarize(LOD = LOD.score, MLE = MLE.allele.freq.,
            POS = Bin.start..bp.,
            max = max(Bin.start..bp.)) %>%
  filter(POS < max - 30000, POS > 30000) -> addtoplot

#Load in all CuSO4 F2 data
Cu_MP <- head(test8,1)
for(i in as.character(as.roman(1:16))){
  filename <- paste("MultiPool_Inputs/CuSO4_all_out_", i, ".txt", sep = "")
  tempfile <- read.table(filename, sep = "\t", header = TRUE) %>% mutate(CHROM = i)
  
  Cu_MP <- rbind(Cu_MP, tempfile)
}

################################################################################

#LOD scores for F2 vs F12
Cu_MP %>% ggplot(aes(x = Bin.start..bp., y = LOD.score, color = CHROM)) + geom_line() + ggtitle("CuSO4 Multipool, n = 10k, r = 2k") +
  facet_grid(~CHROM, scales = "free", space = "free")  +
    geom_line(data = addtoplot, aes(x = POS, y = LOD/5), color = "black") +

  theme(legend.position = "none") +
  ylim(0,20)

#Allele Frequencies for F2 vs F12
Cu_MP %>% ggplot(aes(x = Bin.start..bp., y = MLE.allele.freq., color = CHROM)) + geom_line() + ggtitle("CuSO4 Multipool, n = 10k, r = 2k") +
  facet_grid(~CHROM, scales = "free", space = "free")  +
    geom_line(data = addtoplot, aes(x = POS, y = MLE), color = "black") +
geom_hline(yintercept = 0.5, linetype = "dashed")+
  theme(legend.position = "none") 

################################################################################
#LOD Scores for Chr VII
Cu_MP %>% filter(CHROM == "VII") %>% 
  ggplot(aes(x = Bin.start..bp., y = LOD.score, color = CHROM)) + geom_line() + #ggtitle("CuSO4 Multipool, n = 10k, r = 2k") +
  # geom_vline(data = peaks[peaks$CHROM == "VII" & peaks$label == "Interaction",], aes(xintercept = peakPOS), linetype = "dashed") +
  # geom_vline(data = peaks[peaks$CHROM == "VII" & peaks$label == "Bulk",], aes(xintercept = peakPOS)) +
  facet_grid(~CHROM, scales = "free", space = "free")  +
    geom_line(data = addtoplot[addtoplot$CHROM == "VII",], aes(x = POS, y = LOD), color = "black") +
  ylab("") + xlab("")+ ggtitle("") +
  theme(legend.position = "none") -> p7

#LOD Scores for Chr VIII
Cu_MP %>% filter(CHROM == "VIII") %>% 
  ggplot(aes(x = Bin.start..bp., y = LOD.score, color = CHROM)) + geom_line() + #ggtitle("CuSO4 Multipool, n = 10k, r = 2k") +
    #geom_vline(data = peaks[peaks$CHROM == "VIII" & peaks$label == "Bulk",], aes(xintercept = peakPOS), linetype = "dashed") +
  geom_vline(aes(xintercept = 212533), color = "turquoise") +
  geom_vline(aes(xintercept = 214533), color = "turquoise") +
  facet_grid(~CHROM, scales = "free", space = "free")  +
  ylab("") + xlab("")+ ggtitle("") +
    geom_line(data = addtoplot[addtoplot$CHROM == "VIII",], aes(x = POS, y = LOD), color = "black") +
  theme(legend.position = "none") -> p8

################################################################################
AllCuSO4_glmer_1byRep %>%
  filter(CHROM == "VII", label == "Bulk") -> glm7data

AllCuSO4_glmer_1byRep %>%
  filter(CHROM == "VII", label == "Interaction") -> glm7data_i

Cu_MP %>% filter(CHROM == "VII") %>%
  mutate(splits = Bin.start..bp. < 3e05) %>%
  arrange(desc(LOD.score)) %>%
    group_by(splits) %>%
  summarize(Bin = Bin.start..bp.,
            LOD.score = LOD.score,
            top = max(LOD.score)) %>%
  filter(LOD.score == top) -> MP_peaks

addtoplot %>% filter(CHROM == "VII") %>%
  mutate(split1 = POS < 3e05,
         split2 = POS > 6e05) %>%
  mutate(splits = paste(split1, split2)) %>%
  arrange(desc(LOD)) %>%
    group_by(splits) %>%
  summarize(POS = POS,
            LOD = LOD,
            top = max(LOD)) %>%
  filter(LOD == top) -> MP_IG_peaks

################################################################################
Cu_MP %>% filter(CHROM == "VII") %>% 
  ggplot(aes(x = Bin.start..bp., y = LOD.score, color = CHROM)) + geom_line() + 
  geom_line(data = glm7data, aes(x = POS, y = abs(zscore), linetype = CSS), color = "limegreen") +
  #geom_line(data = glm7data_i, aes(x = POS, y = abs(zscore), linetype = CSS), color = "gray") +
  # geom_vline(data = peaks[peaks$CHROM == "VII" & peaks$label == "Interaction",], aes(xintercept = peakPOS), linetype = "dashed") +
  # geom_vline(data = peaks[peaks$CHROM == "VII" & peaks$label == "Bulk",], aes(xintercept = peakPOS)) +
  geom_vline(data = MP_peaks, aes(xintercept = Bin), color = "red") +
  geom_vline(data = MP_IG_peaks, aes(xintercept = POS)) +
  facet_grid(~CHROM, scales = "free", space = "free")  +
    geom_line(data = addtoplot[addtoplot$CHROM == "VII",], aes(x = POS, y = LOD), color = "black") +
  ylab("") + xlab("")+ ggtitle("") +
  xlim(0, 1082000) +
  theme(legend.position = "none") -> p7both

cowplot::plot_grid(p7both, p8, labels = "LOD Scores by Chromosome")
```

```{r}
AllCuSO4_glmer_1byRep %>%
  filter(CHROM == "VII", label == "Bulk") %>%
  ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) + geom_line(color = "limegreen") +
  theme(legend.position = "none") -> glm7b

AllCuSO4_glmer_1byRep %>%
  filter(CHROM == "VII", label == "Interaction") %>%
  ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) + geom_line(color = "gray") +
  xlim(0, 1082000) +
    geom_hline(yintercept = 1.107608, linetype = "dashed", alpha = 0.5) +

  scale_y_continuous(labels = fmt_dcimals(0)) +
  #scale_y_continuous(c(0,1)) +
  ylab("") +
  theme(legend.position = "none",
        axis.text.x = element_text()) -> glm7i

AllCuSO4_glmer_1byRep %>%
  filter(CHROM == "VII", label == "Interaction") %>%
  ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) + geom_line(color = "gray") +
  xlim(0, 1082000) +
  geom_hline(yintercept = 1.107608, linetype = "dashed", alpha = 0.5) +
  scale_y_continuous(labels = fmt_dcimals(0)) +
  #scale_y_continuous(c(0,1)) +
  ylab("") +geom_vline(data = MP_peaks, aes(xintercept = Bin), color = "red") +
  geom_vline(data = MP_IG_peaks, aes(xintercept = POS)) +
  theme(legend.position = "none",
        axis.text.x = element_text()) -> glm7isstack

plot_grid(p7, glm7b, glm7i, labels = "Chr VII Comparison", ncol = 1, rel_heights = c(3,2,1))

plot_grid(p7both, glm7isstack, ncol = 1, rel_heights = c(3,1))

Cu_MP %>% filter(CHROM == "VII") %>%
  ungroup() %>%
  summarize(max(Bin.start..bp.))

q5_all
```

Figure 2 if we use MULTIPOOL from the start

```{r, fig.height=3, fig.width=6}
AllCuSO4_glmer_1byRep %>%
  filter(CHROM == "VII", label == "Bulk") %>%
  ggplot(aes(x = POS, y = abs(zscore), linetype = CSS)) + geom_line(color = "limegreen") +
  theme(legend.position = "none")

Cu_MP %>% filter(CHROM %in% c("VIII", "XII")) %>% 
  ggplot(aes(x = Bin.start..bp., y = LOD.score)) + geom_line() + #ggtitle("CuSO4 Multipool, n = 10k, r = 2k") +
  # geom_vline(data = peaks[peaks$CHROM == "VII" & peaks$label == "Interaction",], aes(xintercept = peakPOS), linetype = "dashed") +
  # geom_vline(data = peaks[peaks$CHROM == "VII" & peaks$label == "Bulk",], aes(xintercept = peakPOS)) +
  facet_grid(~CHROM, scales = "free", space = "free")  +
    #geom_line(data = addtoplot[addtoplot$CHROM == "VII",], aes(x = POS, y = LOD), color = "black") +
  ylab("") + xlab("")+ ggtitle("") +
  theme(legend.position = "none")

sgd_copper %>% filter(Gene.symbol %in% c("CUP1-1", "FRE1")) -> Fig2Genes

AllCuSO4_glmer_1byRep %>% filter(CHROM %in% c("VIII", "XII")) %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore))) + 
  geom_vline(data = Fig2Genes, aes(xintercept = c(Gene.chromosomeLocation.start), color = Gene.symbol),
             size = 2, alpha = 0.5) +  
  geom_line(aes(linetype = CSS)) +
  geom_line(data = Cu_MP[Cu_MP$CHROM == "VIII" | Cu_MP$CHROM == "XII",], aes(x = Bin.start..bp., y = LOD.score), color = "red") +

    geom_hline(data = q5_all[q5_all$label %in% c("Bulk"),], aes(yintercept = q5)) +
  facet_wrap("CHROM", scales = "free") +
  #facet_grid(~CHROM, scales = "free", space = "free") +
  labs(color = NULL, linetype = NULL, alpha = NULL) +
  theme(legend.position = "bottom") +ylab("")+
    scale_size_manual(values = c(0.1, 2)) +
  scale_color_manual(values = c("darkturquoise", "darkorange"))

AllCuSO4_glmer_1byRep %>% filter(CHROM %in% c("VIII", "XII")) %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore))) + 
  #geom_line(aes(linetype = CSS)) +
  geom_line(data = Cu_MP[Cu_MP$CHROM == "VIII" | Cu_MP$CHROM == "XII",], aes(x = Bin.start..bp., y = LOD.score), color = "limegreen") +
  geom_vline(data = Fig2Genes, aes(xintercept = c(Gene.chromosomeLocation.start), color = Gene.symbol),
             size = 1, alpha = 0.3) +
  facet_wrap("CHROM", scales = "free") +
  labs(color = NULL, linetype = NULL, alpha = NULL) +
  theme(legend.position = "none") +ylab("")+
    scale_size_manual(values = c(0.1, 2)) -> pmultipool

AllCuSO4_glmer_1byRep %>% filter(CHROM %in% c("VIII", "XII")) %>%
  filter(label %in% c("Bulk")) %>%
  ggplot(aes(x = POS, y = abs(zscore))) + 
  geom_line(aes(linetype = CSS)) +
  #geom_line(data = Cu_MP[Cu_MP$CHROM == "VIII" | Cu_MP$CHROM == "XII",], aes(x = Bin.start..bp., y = LOD.score), color = "limegreen") +
  geom_vline(data = Fig2Genes, aes(xintercept = c(Gene.chromosomeLocation.start), color = Gene.symbol),
             size = 1, alpha = 0.3) +
    geom_hline(data = q5_all[q5_all$label %in% c("Bulk"),], aes(yintercept = q5)) +
  facet_wrap("CHROM", scales = "free") +
  #facet_grid(~CHROM, scales = "free", space = "free") +
  labs(color = NULL, linetype = NULL, alpha = NULL) +
  theme(legend.position = "bottom") +ylab("")+
    scale_size_manual(values = c(0.1, 2)) -> pglm

plot_grid(pmultipool, pglm, nrow = 2, rel_heights = c(1,1.2))


```

```{r}
AllCuSO4_glmer_1byRep %>% filter(label == "Interaction", CSS == "VIII",
                                 CHROM %in% c("VII", "X", "XI", "XII", "XIV", "XV")) %>%
  group_by(CHROM) %>%
  arrange(desc(abs(zscore))) %>%
  summarize(POS = head(POS, 1)) -> IntPeaks2

rd_factor %>% filter(POS %in% IntPeaks2$POS) %>%
  mutate(Background = gsub("Oak", 0, Background),
         Background = gsub("Wine", 1, Background)) %>%
  mutate(Bulk = gsub("Dilute", "Unselected", Bulk)) %>%
  ggplot(aes(x = as.numeric(Background), y = SmoothCount, color = Allele)) + 
  geom_point(shape = 1, size = 2, stroke = 1, alpha = 0.8) + 
  geom_smooth(method = "lm", alpha = 0.2) +
  scale_color_manual(values = c("palegreen3", "firebrick3")) +
    xlab("Parental Background") +
  ylab("Allele Count") +
    theme(legend.position = "bottom") +

    geom_hline(yintercept = Inf, color = "white", size = 4) +
    theme(strip.background.y = element_rect(fill = c("black", "darkturquoise" )),
        strip.text.y = element_text(color = "white", size = 10, face = "bold"))+
  facet_grid(Bulk ~ paste(CHROM, POS)) -> pa

AllCuSO4_glmer_1byRep %>% merge(IntPeaks2) %>%
  filter(label %in% c("Bulk", "Interaction"), CSS == "VIII") %>%
  mutate(Coefficient = label) %>%
  #filter(abs(zscore) > 1.1) %>%
  ggplot(aes(x = as.character(POS), y = abs(zscore), color = Coefficient)) + 
  geom_point(stroke = 1, size = 2, alpha = 0.8, shape = 2) + 
  facet_grid( ~ CHROM, scales = "free") +
  ylim(0,10) +
  xlab("") + ylab("abs Z-score") +
      theme(legend.position = "bottom") +

  scale_color_manual(values = c("black", "purple")) -> pb

plot_grid(pa, pb, ncol = 1, rel_heights = c(2,1))

```
```{r}
AllCuSO4_glmer_1byRep %>%
  merge(q5_all) %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = label)) +
  # geom_vline(data = minlist,
  #            aes(xintercept = POS), color = "gray", size = 1)+
  geom_vline(data = IntPeaks,
             aes(xintercept = POS),
             color = "red", linetype = "dashed", size = 1, alpha = 0.4)+
  
  geom_line() +
  geom_hline(aes(yintercept = q5)) +
  
  labs(linetype = NULL, color = NULL) +
  scale_color_manual(values = c("black", "purple")) +
  theme(strip.background.y = element_rect(fill = c("#6aa0c7", "#f8923a"),color = c("#6aa0c7", "#f8923a")),
        strip.text.y = element_text(color = "white", size = 10, face = "bold"))+
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  ggtitle("Selection Agreements vs Interaction Peaks")

################################################################################

AllCuSO4_glmer_1byRep %>%
  filter(CSS == "I") %>%
  merge(q5_all) %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = label)) +
  geom_line() +
  xlab("") +
  ylab("abs Z-score") +
  geom_hline(aes(yintercept = q5)) +
  #labs(linetype = NULL, color = NULL) +
  scale_color_manual(values = c("black", "purple")) +
  theme(strip.background.y = element_rect(fill = c("#6aa0c7", "#f8923a"),color = c("#6aa0c7", "#f8923a")),
        strip.text.y = element_text(color = "white", size = 10, face = "bold"))+
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) -> pCSS1

AllCuSO4_glmer_1byRep %>%
  filter(CSS == "VIII") %>%
  merge(q5_all) %>%
  filter(label %in% c("Bulk", "Interaction")) %>%
  ggplot(aes(x = POS, y = abs(zscore), color = label)) +
  geom_line() +
  geom_vline(data = IntPeaks,
             aes(xintercept = POS),
             color = "red", linetype = "dashed", size = 1, alpha = 0.4)+
  xlab("") +
  ylab("abs Z-score") +
  geom_hline(aes(yintercept = q5)) +
  #labs(linetype = NULL, color = NULL) +
  scale_color_manual(values = c("black", "purple")) +
  theme(strip.background.y = element_rect(fill = c( "#f8923a"),color = c("#f8923a")),
        strip.text.y = element_text(color = "white", size = 10, face = "bold"))+
  facet_grid(CSS~CHROM, scales = "free", space = "free") +
  theme(legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) -> pCSS8

```

```{r, fig.height=12, fig.width=8}
plot_grid(pCSS1, pCSS8, pa, pb, ncol = 1, rel_heights = c(1,1,2,1))

```

# Random sim

Assume that you have two alleles, and that they can take on 9 different values (1-9). The sum of the values are the phenotype. If they are the SAME number, there is an advantage of +2 to the phenotype. If they are both even or both odd, there is a +1. For 2,2 for example, it would be +3 because (1) same number and (2) both even.

If only one number can change at a time, what is the evolutionary landscape?

```{r}
merge(data.frame(A1 = 1:9),
      data.frame(A2 = 1:9)) %>%
  mutate(Same = 2* as.numeric(A1 == A2)) %>%
  mutate(Even = as.numeric((abs(A1 - A2))%%2 == 0)) %>%
  mutate(pheno = A1+A2+Same+Even) -> genotypephenotype

genotypephenotype %>%
  ggplot(aes(x= A1, y = A2, fill = pheno, alpha = pheno > 10)) + geom_tile() +
  theme_minimal()

genotypephenotype %>%
  ggplot(aes(x = A1, y = pheno)) + geom_point() +
  geom_smooth(method = "lm") +
  geom_abline(slope = 1,intercept = 0) +
  ylim(0,20) +
  ggtitle("No Selection")+
  facet_wrap("A2")

genotypephenotype %>%
  filter(pheno > 5) %>%
  ggplot(aes(x = A1, y = pheno)) + geom_point() +
  geom_smooth(method = "lm") +
  geom_abline(slope = 1,intercept = 0) +
  ylim(0,20) +
  ggtitle("Selection > 5")+
  facet_wrap("A2")

genotypephenotype %>%
  filter(pheno > 10) %>%
  ggplot(aes(x = A1, y = pheno)) + geom_point() +
  geom_smooth(method = "lm") +
  geom_abline(slope = 1,intercept = 0) +
  ylim(0,20) +
  ggtitle("Selection > 10")+
  facet_wrap("A2")

genotypephenotype %>%
  filter(pheno > 10) %>%
  ggplot(aes(x = A1, y = pheno)) + 
  geom_point() +
  geom_smooth(method = "lm") +
  geom_smooth(data = genotypephenotype, method = "lm", color = "red") +
  geom_abline(slope = 1,intercept = 0) +  ylim(0,20) +
  ggtitle("Overall Effect of A1 with and without selection > 10")

```

